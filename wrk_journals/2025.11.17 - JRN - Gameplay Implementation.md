# Development Journal: Complete Gameplay Implementation

**Date:** 2025-11-17
**Session:** Gameplay Features - Tools, Caves, Survival, UI
**Goal:** Implement comprehensive gameplay systems to make mdminecraft playable

---

## Multi-Stage Implementation Plan

### Overview
Implementing four major feature sets:
- **Stage 1:** Tools & Mining System (D)
- **Stage 2:** Cave Generation (C)
- **Stage 3:** Survival Mechanics (B)
- **Stage 4:** 3D UI Integration (A)

**Estimated Total Time:** 12-16 hours of implementation
**Target:** Get as far as possible in this session

---

## Stage 1: Tools & Mining System üî®

### Goals
- Tool types: Pickaxe, Axe, Shovel, Sword
- Material tiers: Wood ‚Üí Stone ‚Üí Iron ‚Üí Diamond
- Block hardness and mining speed
- Durability system
- Tool crafting recipes

### Implementation Steps

#### 1.1 Tool Data Structures
```rust
// crates/core/src/item.rs
pub enum ItemType {
    Tool(ToolType, ToolMaterial),
    Block(BlockId),
    // ... other types
}

pub enum ToolType {
    Pickaxe,
    Axe,
    Shovel,
    Sword,
}

pub enum ToolMaterial {
    Wood,
    Stone,
    Iron,
    Diamond,
}

pub struct Tool {
    tool_type: ToolType,
    material: ToolMaterial,
    durability: u32,
    max_durability: u32,
}
```

#### 1.2 Block Properties
```rust
// crates/world/src/block_properties.rs
pub struct BlockProperties {
    pub hardness: f32,
    pub best_tool: Option<ToolType>,
    pub required_tier: ToolMaterial,
    pub drops: Vec<(ItemType, u32)>,
}
```

#### 1.3 Mining Speed Calculation
- Base breaking time based on hardness
- Tool effectiveness multiplier
- Tier bonuses
- No tool penalty

#### 1.4 Tool Crafting
- Add crafting recipes for all tool tiers
- Stick recipes
- Tool bench (optional)

**Time Estimate:** 2-3 hours

---

## Stage 2: Cave Generation üï≥Ô∏è

### Goals
- 3D Perlin noise cave systems
- Natural cave formations
- Cave biomes (lush, dripstone, deep dark)
- Integration with terrain generation
- Exposed ore veins in caves

### Implementation Steps

#### 2.1 Cave Noise Generator
```rust
// crates/world/src/caves.rs
pub struct CaveGenerator {
    noise: PerlinNoise,
    threshold: f32,
}

impl CaveGenerator {
    pub fn is_cave(&self, x: i32, y: i32, z: i32) -> bool {
        let noise_value = self.sample_3d(x, y, z);
        noise_value > self.threshold
    }
}
```

#### 2.2 Integration with Terrain
- Modify chunk generation to carve caves
- Preserve surface terrain
- Cave entrances at mountains/hills
- Cave floor generation (stone, gravel)

#### 2.3 Cave Features
- Underground lakes (water at y < 50)
- Ore veins exposed in cave walls
- Stalactites/stalagmites (optional)
- Cave lighting (darkness by default)

#### 2.4 Performance
- Optimize 3D noise sampling
- Cache cave data per chunk
- LOD for distant caves

**Time Estimate:** 3-4 hours

---

## Stage 3: Survival Mechanics ‚ù§Ô∏è

### Goals
- Health system (20 hearts = 20.0 HP)
- Damage sources (fall, mobs, lava)
- Death and respawn
- Basic hostile mob (Zombie)
- Mob AI (pathfinding, attack)
- Food system (basic)

### Implementation Steps

#### 3.1 Health System
```rust
// crates/core/src/player.rs
pub struct PlayerHealth {
    pub current: f32,
    pub max: f32,
    pub regeneration_rate: f32,
}

pub enum DamageSource {
    Fall(f32),
    Mob(MobType),
    Lava,
    Fire,
    Drowning,
}
```

#### 3.2 Fall Damage
- Track player vertical velocity
- Calculate damage on landing: `max(0, (fall_distance - 3.0) * 2.0)`
- Apply to health

#### 3.3 Hostile Mobs
```rust
// crates/world/src/mob.rs
pub enum MobType {
    // Passive (existing)
    Pig, Cow, Sheep, Chicken,
    // Hostile (new)
    Zombie, Skeleton, Spider, Creeper,
}

pub struct HostileMob {
    pub mob_type: MobType,
    pub target: Option<EntityId>,
    pub attack_damage: f32,
    pub attack_cooldown: f32,
}
```

#### 3.4 Mob AI
- Simple pathfinding (move towards player)
- Attack when in range (1.5 blocks)
- Damage cooldown (0.5 seconds)
- Spawning rules (darkness, surface)

#### 3.5 Death & Respawn
- Death screen overlay
- Respawn button
- Reset health
- Teleport to spawn point
- Drop inventory (optional)

#### 3.6 Food System (Basic)
```rust
pub struct Food {
    pub hunger_restored: f32,
    pub saturation: f32,
}
```
- Hunger bar (20 points)
- Food items (bread, meat, apple)
- Eating mechanics
- Hunger damage (when at 0)

**Time Estimate:** 4-5 hours

---

## Stage 4: 3D UI Integration üé®

### Goals
- Floating spawn point label
- Coordinate display in 3D
- Health bar in 3D space
- Block information labels
- Mob nameplates

### Implementation Steps

#### 4.1 UI Manager
```rust
// src/game.rs
pub struct UIManager {
    text_renderer: TextRenderer,
    labels: Vec<Label3D>,
    font_atlas: FontAtlas,
}
```

#### 4.2 Spawn Point Indicator
- Floating "Spawn Point" label at world origin
- Green color, large text
- Visible from distance
- Distance fade (50-100 blocks)

#### 4.3 Coordinate Display
- Show X, Y, Z coordinates
- Update in real-time
- Position: top-left of screen in 3D
- Small, unobtrusive font

#### 4.4 Health Bar
- 3D heart icons
- Positioned relative to player view
- Updates with damage/healing
- Red color when low health

#### 4.5 Block Info
- When looking at block, show name
- Distance display
- Hardness indicator

**Time Estimate:** 2-3 hours

---

## Implementation Order & Priorities

### Session 1 (Current)
1. ‚úÖ Create implementation plan
2. ‚è≥ Stage 1: Tools & Mining (most foundational)
3. ‚è≥ Stage 2: Cave Generation (makes world interesting)
4. ‚è≥ Stage 3: Survival Mechanics (adds challenge)
5. ‚è≥ Stage 4: 3D UI Integration (polish)

### Success Metrics
- **Minimum Viable:** Tools working, can mine blocks
- **Good:** Caves generating, ores distributed
- **Great:** Health system, hostile mobs, combat
- **Excellent:** Full 3D UI integration

---

## Technical Approach

### New Crates/Modules
- `crates/core/src/item.rs` - Item system
- `crates/core/src/tool.rs` - Tool mechanics
- `crates/world/src/caves.rs` - Cave generation
- `crates/world/src/block_properties.rs` - Block data
- `crates/gameplay/` - New crate for game logic (health, combat, etc.)

### Integration Points
- Modify `GameWorld` to include health, inventory
- Extend chunk generation with caves
- Add mob spawning logic
- Integrate 3D UI rendering

---

## Work Log

### [16:00] Session Start
- Created comprehensive multi-stage plan
- Identified dependencies between systems
- Estimated ~12-16 hours total work
- Starting with Stage 1: Tools & Mining

### [16:15] Beginning Stage 1 Implementation
- Creating item and tool systems...

### [16:30] Stage 1.1 - Item System Complete ‚úÖ
**Created:** `crates/core/src/item.rs` (220 lines)

Implemented comprehensive item system:
- `ItemType` enum: Tool, Block, Food, Item
- `ToolType` enum: Pickaxe, Axe, Shovel, Sword, Hoe
- `ToolMaterial` enum: Wood (0), Stone (1), Iron (2), Diamond (3), Gold (4)
  - Gold has tier 0 mining power (like Wood) but 12x speed multiplier
  - Special `can_mine_tier()` logic to handle Gold's unique properties
- `ItemStack` struct with durability tracking
  - `damage_durability()` - reduce tool durability
  - `is_broken()` - check if tool is broken
  - `max_durability()` - get max durability
- Material-specific durability values (Wood: 59, Diamond: 1561)
- Speed multipliers per material (Wood: 2x, Diamond: 8x, Gold: 12x)

**Tests:** Full test coverage for tool tiers, durability, and item stacks

### [16:45] Stage 1.2 - Block Properties Complete ‚úÖ
**Created:** `crates/world/src/block_properties.rs` (286 lines)

Implemented block mining mechanics:
- `BlockProperties` struct with:
  - `hardness` - mining time modifier
  - `best_tool` - optimal tool type
  - `required_tier` - minimum material tier to harvest
  - `instant_break` - for air/flowers
  - `is_solid` - collision flag
- Factory methods for common blocks:
  - `air()` - instant break, not solid
  - `dirt()` - 0.5 hardness, shovel
  - `stone()` - 1.5 hardness, pickaxe, requires Wood tier
  - `wood()` - 2.0 hardness, axe
  - `iron_ore()` - 3.0 hardness, requires Stone tier
  - `diamond_ore()` - 3.0 hardness, requires Iron tier
- `calculate_mining_time()` - Complex calculation:
  - Base time from hardness (√ó1.5)
  - Tool effectiveness multiplier
  - Harvest penalty (5x slower if wrong tier)
  - Water penalty (5x slower when underwater)
- `can_harvest()` - Check if tool tier is sufficient
- `BlockPropertiesRegistry` with defaults for IDs 0-12

**Tests:** Mining time calculations, harvest requirements, registry

### [17:00] Stage 1.3 - Game Integration Complete ‚úÖ
**Modified:** `src/game.rs` (~200 lines changed)

Integrated mining system into main game:
1. **Hotbar System Redesign:**
   - Changed from `[BlockId; 9]` to `[Option<ItemStack>; 9]`
   - Default inventory: Wood/Stone/Iron pickaxes, shovels, blocks
   - `selected_tool()` - Get current tool for mining
   - `selected_block()` - Get block for placement
   - `item_name()` - Display item names (e.g., "Iron Pickaxe")

2. **Mining Progress Tracking:**
   - New `MiningProgress` struct tracks:
     - `block_pos` - which block is being mined
     - `time_mining` - time spent mining
     - `time_required` - total time needed
   - Reset when looking away or releasing mouse
   - Visual progress bar in debug HUD

3. **Mining Mechanics:**
   - `handle_mining()` - Progressive mining system:
     - Calculate required time based on block + tool
     - Track progress over time
     - Break block when 100% complete
     - Check harvest requirements
     - Damage tool durability
     - Remove broken tools
   - Tool durability damage on each block mined
   - Proper tool tier checking

4. **Block Placement:**
   - `handle_block_placement()` - Separate method
   - Decrease block count from stack
   - Remove empty stacks

5. **UI Updates:**
   - Hotbar shows tool durability (% with color coding)
   - Hotbar shows block counts (x64)
   - Mining progress in debug HUD (F3)
   - Tool names displayed on selection

**Added:** `BlockPropertiesRegistry` to `GameWorld`

### [17:15] Debug HUD Enhancement ‚úÖ
**Modified:** `crates/render/src/ui.rs`

Added mining progress visualization:
- `mining_progress: Option<f32>` field
- Progress bar widget (0-100%)
- Percentage display
- Only shown when actively mining

### [17:20] Build Success ‚úÖ

Fixed compilation errors:
1. Duplicate discriminant for Gold (was 0, now 4)
2. Added missing `damage_durability()`, `is_broken()`, `max_durability()` methods
3. Exported `BlockPropertiesRegistry` from world crate

**Build Result:** Success with only unused variable warnings

### Stage 1 Status: COMPLETE ‚úÖ

**Implemented:**
- ‚úÖ Item and tool type system
- ‚úÖ Tool material tiers with proper ordering
- ‚úÖ Block properties with hardness
- ‚úÖ Mining speed calculation
- ‚úÖ Tool durability system
- ‚úÖ Progressive mining with visual feedback
- ‚úÖ Harvest tier requirements
- ‚úÖ Tool effectiveness multipliers

**Not Yet Implemented:**
- ‚è≥ Tool crafting recipes (deferred - not critical)
- ‚è≥ Item drops from mined blocks (deferred)

**Time Spent:** ~1 hour
**Estimated:** 2-3 hours (came in under budget!)

---

### Next: Stage 2 - Cave Generation üï≥Ô∏è

Preparing to implement 3D Perlin noise cave systems...

---

*Journal will be updated as implementation progresses...*
