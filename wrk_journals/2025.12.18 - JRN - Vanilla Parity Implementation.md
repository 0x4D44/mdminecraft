# Vanilla Parity Implementation Journal

**Date:** 2025-12-18  
**Repo:** `/home/md/language/mdminecraft`  
**Plan:** `wrk_docs/2025.12.17 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  

---

## 2025-12-18

### Stage 3 — Survival loop fidelity (WIP)

- Moved survival ticking to the fixed 20 TPS sim loop (`GameWorld::fixed_update`) via a new `GameWorld::tick_player_survival(dt)` to reduce FPS-dependence.
- Implemented tick-based environmental hazards:
  - Drowning (air depletion + periodic drowning damage; Water Breathing prevents it).
  - Burning DOT (periodic fire damage; Water extinguishes; Fire Resistance prevents damage).
  - Lava contact damage + ignition (simplified; Fire Resistance prevents).
- Reintroduced XP orb physics + collection in sim-time (previously removed from per-frame update); XP now also drives Mending repairs (hotbar only, simplified).
- Added bed interaction: right-click bed sets spawn and skips to sunrise (simple hostile-mob proximity gate; clears weather).
- UI polish: added slot tooltips + durability bars for tools (hotbar + inventory overlay).
- Added personal crafting (2x2) inside the inventory UI; added crafting table recipe (4 planks → crafting table) to enable the early-game loop without requiring a pre-placed table.
- Prevented accidental item loss on close by returning any items left in crafting grids (crafting table + personal crafting) back into the hotbar (best-effort; warns if full).
- Added player drop-item behavior: `Q` drops one from the selected hotbar stack; `Ctrl+Q` drops the whole stack. Drops spawn just outside pickup radius in front of the player and are configurable via the pause-menu keybind editor (`DropItem`).
- Extended dropped-item mappings to include tools (pickaxe/axe/shovel/sword/hoe across materials), so dropping and re-picking up tools now works.
- Refactored brewing stand UI to use cursor + hotbar interactions (fuel/ingredient/bottle slots); the old quick-add buttons are now hidden behind `MDM_DEBUG_BREWING_QUICK_ADD=1`. Added client-side IDs + dropped-item mappings for brewing items and potions so they can be picked up/dropped.

### Stage 3 — Crafting + furnace UX (WIP)

- Fixed furnace UI integration: removed temporary “quick-add” debug buttons and wired furnace input/fuel/output to the selected hotbar slot (put selected → input/fuel; take output/input/fuel back to hotbar with overflow returned to the furnace).
- Hardened inventory insertion: implemented `Hotbar::add_stack` to merge/split stacks across hotbar slots and used it for crafting output + dropped-item pickup paths.
- Fixed a major block-id mismatch: aligned crafting recipes and hotbar defaults to the canonical ids from `config/blocks.json` (notably cobblestone=24, oak_log=11, oak_planks=12, crafting_table=13, furnace=18).
- Removed hardcoded block-name tables in the hotbar overlay; block names now come from `BlockRegistry` descriptors.
- Added canonical block-id constants to `mdminecraft_world` (`BLOCK_COBBLESTONE`, `BLOCK_OAK_LOG`, `BLOCK_OAK_PLANKS`) and re-exported them.
- Corrected several world block-id tables that were off-by-one vs `config/blocks.json` (redstone + farming blocks, plus interactive `bed_*`/`chest`/`trapdoor`/`torch` ids).
- Fixed dropped cobblestone placement + drops (`drop_item::ItemType::Cobblestone` now places as block id 24; cobblestone blocks drop themselves).
- Fixed crafting recipe matching to require exact counts (prevents “extra items still match” and silent deletion on craft).
- Added unit tests for crafting recipes (log→planks, planks→sticks, planks→table, cobble→furnace, coal+stick→torches) and exact-count enforcement.
- Fixed leaf drop IDs in `mdminecraft_world::drop_item` (oak/birch/spruce leaves now align with `config/blocks.json`) and wired leaf-breaking in the client to produce deterministic apple/sapling drops.
- Replaced the “fract(sim_tick)” drop RNG with a deterministic, per-block seeded RNG for Fortune/leaf drops (seeded by world seed + sim tick + block position).
- Added a regression test to ensure key block-id tables match `config/blocks.json` (`crates/world/tests/block_ids_match_blocks_json.rs`).
- Added core early-game smelting parity: `OakLog → Coal` (charcoal-as-coal) and `Cobblestone → Stone` in `mdminecraft_world::furnace`.
- Fixed crafting consumption semantics: crafting now consumes only the required inputs (instead of clearing the entire grid), and planks crafting intentionally allows extra log counts so players can craft multiple times without clearing the grid.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `cargo test -p mdminecraft`

### Stage 3 — Inventory UX (WIP)

- Replaced the “number button” crafting UI with a cursor-based slot interaction model:
  - Left click: pick up / place / merge / swap.
  - Right click: pick up half / place one / add one.
- Inventory UI (2×2) and crafting table UI (3×3) now use interactive slots for both grids + hotbar, with a visible cursor stack.
- Craft results now prefer the UI cursor stack; overflow spills to world drops instead of being silently lost.
- Inventory close now returns only the cursor stack; the personal crafting grid now persists across inventory closes (vanilla-like).
- Crafting table close returns the cursor stack plus any remaining grid items back to the player, spilling overflow to world drops.

### World drops — parity improvements

- Added droppable/placeable `CraftingTable` and `Torch` to `mdminecraft_world::drop_item::ItemType` (including `to_block`, `from_block`, and a new `from_placeable_block` helper).
- Updated worldtests/unit tests to match new block drop behavior for crafting tables/torches.

### Persistence safety

- On world save/exit (`persist_world`), stashes any UI-held items (cursor + both crafting grids) back into player storage or world drops so they aren’t lost when quitting mid-UI.

### Furnace UX

- Furnace UI now uses the same cursor-based slot interactions as inventory/crafting (input/fuel/output slots + hotbar shown, no “selected hotbar” buttons).
- Added unit tests covering furnace slot click semantics (output take/merge; input smeltable filtering + swap).

### Enchanting UX + Lapis

- Added Lapis Lazuli as a real core item (`Item(15)`) and mapped it to/from world dropped items so it can be picked up and used.
- Enchanting table UI now has an interactive lapis slot (deposit/withdraw via cursor) and shows the hotbar/cursor like other UIs (removed the debug “+ Lapis” button).
- Synced enchanting offers to the currently selected hotbar tool by mapping core tools to the world enchanting ID conventions; offers now reroll after enchanting.

### Stage 3 — Crafting Output UX (WIP)

- Removed “Craft” buttons: inventory 2×2 and crafting table 3×3 outputs are now clickable result slots.
- Normal click crafts once **into the cursor** (only if the cursor can accept the full output stack).
- Shift-click crafts as many times as possible **into the hotbar**; overflow spills to world drops.
- Added shift-click quick-move from crafting grid slots back to the hotbar (bypasses the cursor).
- Clamped `try_add_stack_to_cursor` to the cursor max stack size (so overflow returns to the caller for hotbar/spill instead of silently overfilling the cursor).
- Refactored `render_core_slot_interactive` to share a single visual renderer, so shift-click behavior doesn’t duplicate tooltip/durability rendering logic.
- Added unit tests for cursor clamping + craft-max helpers.

### Verification (post-change)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Verification (post-change 2)

- `cargo fmt --all`
- `cargo clippy -p mdminecraft --all-targets -- -D warnings`
- `cargo test -p mdminecraft`

### Stage 3 — Overflow Safety (WIP)

- Fixed dropped-item pickup overflow: if the hotbar can’t accept the full picked-up stack, the remainder is re-spawned just outside the pickup radius (prevents silent deletion).

### Verification (post-change 3)

- `cargo fmt --all`
- `cargo test -p mdminecraft`

### Stage 3 — Pause Menu + Options (WIP)

- Implemented an in-game pause menu (Esc) instead of immediately returning to title:
  - Resume Game
  - Options…
  - Save & Quit to Title
  - Quit Game
- While paused, the deterministic 20 TPS sim loop is halted and the fixed-step accumulator is held at 0 to prevent “fast-forward” on resume.
- Options screen:
  - Mouse sensitivity + invert-Y update live
  - FOV + render distance update live
  - “Save Controls” writes `config/controls.toml`
- Added `fov_degrees` + `render_distance` to `ControlsConfig` so menu + pause options persist and apply consistently.
- Game now initializes camera FOV + chunk radius from `ControlsConfig` (menu sliders are no longer cosmetic).
- Made menu → game propagation correct: starting a new game now reloads `ControlsConfig` from disk so menu changes take effect immediately.
- Updated menu “Save” behavior to preserve binding overrides by round-tripping `ControlsConfig` instead of overwriting with a minimal template.
- Added a basic keybind editor in pause menu → Options (base layer only, limited key set) and hot-reload bindings in-session by rebuilding `InputProcessor`.

### Verification (post-change 4)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Verification (post-change 5)

- `cargo fmt --all`
- `cargo clippy -p mdminecraft --all-targets -- -D warnings`
- `cargo test -p mdminecraft`

### Stage 3 — Main Inventory (WIP)

- Implemented an interactive 27-slot main inventory (distinct from the hotbar) with cursor interactions in the inventory UI.
- Added shift-click quick-move between main inventory and hotbar (vanilla-like “quick transfer” behavior).
- Wired main inventory persistence by converting to/from `mdminecraft_world::Inventory` on save/load:
  - Stores tool durability + enchantments in `Inventory::ItemStack.metadata` (compact, versioned encoding).
  - Includes a sentinel fallback path that stores a full `mdminecraft_core::ItemStack` as JSON metadata for items without a dropped-item mapping.
- Updated dropped-item pickup insertion to fill hotbar first, then main inventory; overflow is re-spawned just outside pickup radius (prevents silent deletion).
- Updated UI close/save stashing to return cursor/crafting-held stacks into player storage (hotbar → main inventory) and spill any remaining overflow to world drops (prevents hidden “cursor-only” items after closing UI).
- Bow arrow consumption now checks the main inventory if the hotbar has no arrows.
- Added `DroppedItemType::from_id(u16)` to support inventory persistence roundtrips and future container work.

### Verification (post-change 6)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `cargo test -p mdminecraft-world`

### Stage 3 — Station UIs use full inventory (WIP)

- Crafting table UI now shows full player storage (main inventory + hotbar), not just the hotbar.
- Inventory/personal crafting grid + crafting table grid shift-click now quick-moves items back into player storage (hotbar → main inventory).
- Shift-click crafting output now crafts into player storage (hotbar → main inventory), spilling overflow to world drops.
- Furnace UI now shows full player storage and supports vanilla-ish shift-click routing:
  - Shift-click player items: smeltables go to input, fuels go to fuel; items that are both (e.g. logs) fall back to fuel if input is blocked.
  - Shift-click furnace slots: moves stacks back into player storage.
- Enchanting and brewing UIs now show full player storage (so lapis/bottles/ingredients can be moved without pre-loading the hotbar).
- Added unit tests for furnace shift-move insertion helpers.

### Verification (post-change 7)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Audio settings persistence + wiring (WIP)

- Extended `ControlsConfig` to persist audio sliders (master/music/sfx/ambient) plus a mute toggle in `config/controls.toml`.
- Menu Settings now loads/saves audio volumes + mute from/to `ControlsConfig`.
- In-game pause menu Options now includes an Audio section and persists it via `Save Settings`.
- Added an `AudioManager` to `GameWorld`, keeps the listener synced to the camera, applies audio settings when options change, and plays basic UI SFX on inventory/station open/close plus item pickup (backend is stub unless `rodio_backend` is enabled).

### Verification (post-change 8)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Inventory drag distribute (WIP)

- Added click-drag stack distribution (vanilla-ish) for core inventory slots:
  - Right-drag: “place one” into each newly-hovered slot.
  - Left-drag: on release, round-robin distribute across all visited slots until the cursor is empty or no slots can accept.
- Works across main inventory, hotbar, personal crafting grid, crafting table grid, and player inventory panels inside crafting/furnace/enchanting/brewing UIs.
- Added unit tests for round-robin distribution and skipping full/incompatible slots.

### Verification (post-change 9)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Armor management in inventory UI (WIP)

- Added dedicated armor slots (H/C/L/B) to the inventory UI with click-to-equip/unequip/swap using the existing cursor model.
- Preserved armor durability + enchantments when moving between equipped armor and inventory (via `ItemStack.durability`/`ItemStack.enchantments`).
- Fixed right-click equip-in-world to no longer delete replaced armor: old piece is returned to player storage (or spilled if full).
- Added a unit test for armor piece ↔ core stack roundtrip (durability + enchantments preserved).

### Verification (post-change 10)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing/Enchanting shift-click routing (WIP)

- Brewing stand shift-click routing (vanilla-ish):
  - Shift-click player storage: blaze powder routes into fuel (and falls back to ingredient if fuel is full), bottles/potions fill empty bottle slots, nether wart routes into ingredient slot.
  - Shift-click machine slots (fuel/ingredient/bottles) moves items back into player storage.
- Enchanting table shift-click routing (vanilla-ish):
  - Shift-click lapis from player storage routes into the table’s lapis slot while the UI is open.
- Added unit tests for brewing/enchanting shift-move helpers.

### Verification (post-change 11)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `cargo test -p mdminecraft-world --test determinism_worldtest -- --nocapture`

### Stage 3 — Recipe book lite + 2x2/3x3 crafting gating (WIP)

- Added a simple “Recipe Book” panel to the crafting table UI with a craftable indicator and `Fill` action (requires empty cursor + empty grid).
- Implemented deterministic autofill: consumes required inputs from player storage (main inventory first, then hotbar) and populates the 3×3 crafting grid.
- Added recipe grid-size gating so 3×3-only recipes (furnace, bow/arrow, armor) no longer craft from the 2×2 personal crafting grid.
- Added unit tests for grid-size gating and autofill behavior.

### Verification (post-change 12)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Personal crafting recipe book (WIP)

- Added a small “Recipes” panel to the 2×2 personal crafting UI (Inventory screen), filtered to 2×2-legal recipes, with the same `Fill` behavior (empty cursor + empty grid).
- Slightly widened the Inventory window to fit the added panel without squishing the crafting grid.

### Verification (post-change 13)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Clear crafting grids + multi-spill support (WIP)

- Added `Clear` buttons to the 2×2 personal crafting grid and the 3×3 crafting table grid (requires empty cursor), returning items to player storage and spilling overflow deterministically.
- Switched UI overflow handling from a single `spill_item: Option<ItemStack>` to `spill_items: Vec<ItemStack>` so multiple overflow stacks can be dropped in one frame.

### Verification (post-change 14)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Block properties registry correctness (WIP)

- Fixed `mdminecraft_world::BlockPropertiesRegistry` to index properties by the canonical `BlockId` values from `config/blocks.json` (instead of relying on contiguous `push()` order, which caused many higher-id blocks to behave like air).
- Added missing `mdminecraft_world` `BLOCK_*` constants for common Overworld blocks (dirt/grass/sand/gravel/water/ice/snow/clay/bedrock/obsidian/glass) and re-exported them.
- Added a regression test ensuring ores/wood/fluid IDs resolve to the intended mining properties and that out-of-range IDs fall back to air.

### Verification (post-change 15)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Collision/ground checks use block solidity (WIP)

- Switched player collision and ground-height queries to use `mdminecraft_world::BlockPropertiesRegistry` (`is_solid`) instead of conflating solidity with `BlockRegistry` opacity, fixing transparent-but-solid blocks (e.g. glass) behaving like air for movement/collisions.
- Added a regression test proving glass collides while water does not.

### Verification (post-change 16)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Non-solid blocks in BlockPropertiesRegistry (WIP)

- Marked common non-solid blocks as `is_solid = false` in `BlockPropertiesRegistry` (torches, ladders, redstone components, and crops) so they don’t become full-block collision walls now that collision checks use `block_properties`.
- Extended tests to cover torch/redstone/crop non-solidity and added a torch case to the collision regression test.

### Verification (post-change 17)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Door open state affects collisions (WIP)

- Updated collision solidity checks to respect open/closed state for doors (plus fence gates and trapdoors), so opening a door no longer leaves an invisible full-block collision wall.
- Extended the collision regression test to assert “door closed collides, door open does not”.

### Verification (post-change 18)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Scripted “first night” scenario test (WIP)

- Added a deterministic scripted unit test (`stage3_first_night_scenario_survives_save_load`) that exercises the early loop in a headless way: gather → craft (planks/table/sticks/torches) → hunger drain while active → bed sets spawn → save/load via `RegionStore` and verify inventory + survival stats roundtrip.

### Verification (post-change 19)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Collision shapes (incremental) (WIP)

- Refactored player collision + ground-height queries to use `mdminecraft_world::get_collision_type`-derived AABBs (partial slabs/trapdoors/beds/chests/fences) instead of treating every solid block as a full cube.
- Added regression tests for slab top/bottom collision and trapdoor open/closed collision behavior.

### Verification (post-change 20)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Cave generation uses canonical block IDs (WIP)

- Replaced stale hardcoded numeric block IDs in `mdminecraft_world::caves` with the canonical `BLOCK_*` constants aligned with `config/blocks.json` (fixes cases like stone/water/bedrock mapping being incorrect).
- Updated cave carvers and ravines to avoid carving bedrock and any fluids via `mdminecraft_world::is_fluid`, restoring expected cave carving behavior.
- Updated lush/dripstone/deep-dark decorators to place the correct block IDs for moss/deepslate/sculk/glow lichen/hanging roots and related decorations (cave vines, spore blossom, moss carpet, sculk sensor/shrieker/catalyst/vein).
- Updated `caves.rs` unit tests to assert against the canonical constants.
- Marked cave decoration blocks as non-solid in `BlockPropertiesRegistry` to prevent them from becoming full-block collision walls.

### Verification (post-change 21)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Geode generation uses canonical block IDs (WIP)

- Fixed `mdminecraft_world::geode` to use canonical `BLOCK_*` IDs for geode layers (smooth basalt, calcite, amethyst block, budding amethyst) and for air/water skipping logic, aligned with `config/blocks.json`.
- Added missing geode-related `BLOCK_*` constants and re-exported them via `mdminecraft_world`.
- Updated `geode.rs` unit tests to assert against the canonical constants (no more stale numeric literals / outdated ID ranges).

### Verification (post-change 22)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Aquifer generation uses canonical block IDs (WIP)

- Fixed `mdminecraft_world::aquifer` to use canonical block IDs for air/water/lava and magma blocks (no more stale numeric IDs that mapped to unrelated blocks).
- Updated `aquifer.rs` unit tests to assert against `BLOCK_*` constants rather than hardcoded values.

### Verification (post-change 23)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Step-up movement for partial blocks (WIP)

- Added a vanilla-ish step-up path to player movement collision resolution so walking into low obstacles (e.g. bottom slabs) can raise the player up onto the surface instead of stopping.
- Implemented step height as a power-of-two fraction (`19/32`) for stability, and included a deterministic “step down” probe to settle onto the top surface.
- Added a regression test that proves stepping onto a bottom slab results in horizontal progress plus a +0.5 Y offset.

### Verification (post-change 24)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Stairs are walkable steps (WIP)

- Updated `mdminecraft_world::get_collision_type` to treat stairs as a 0.5-block step (simplified), so player step-up can traverse them instead of treating stairs like full blocks.
- Added a regression test ensuring step-up onto stairs produces horizontal movement plus a +0.5 Y offset.

### Verification (post-change 25)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Ladder contact + climbing (WIP)

- Added ladder contact detection for the player AABB and a simple ladder movement model: ladders cancel gravity, `jump` climbs up, `crouch` climbs down, and idle clamps to a slow slide.
- Added a regression test asserting ladders are detected for movement logic while remaining non-collidable.

### Verification (post-change 26)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Door collision is a thin plane (WIP)

- Implemented a thin door collision AABB (3/16 thickness) that depends on door facing and open state (simplified hinge: doors always swing “left”), instead of treating closed doors as full cubes and open doors as non-collidable.
- Updated ground-height logic to treat doors as non-ground (no `top_offset`) since door collision is not a horizontal surface.
- Updated tests: removed the overly-broad “open door is non-collidable” assertion and replaced it with a shape-based regression test that checks edge collisions for closed vs open door.

### Verification (post-change 27)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Fence connectivity collision (incremental) (WIP)

- Implemented a neighbor-aware fence collision AABB: isolated fences collide as a narrow post; when connected to adjacent solid blocks/fences/fence gates, the collision bounds expand toward those neighbors (simplified union bounding box).
- Added a regression test proving an isolated fence doesn’t fill the block corner but does expand when a solid neighbor is placed.

### Verification (post-change 28)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Fence gate collision (incremental) (WIP)

- Implemented a thin centered collision plane for closed fence gates (orientation derived from facing bits). Open fence gates remain non-collidable (simplified), but closed gates no longer behave like full 1×1 fence blocks.
- Added a regression test asserting “closed collides in the middle, open does not” for fence gates.

### Verification (post-change 29)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Multi-AABB collision plumbing (WIP)

- Introduced a small fixed-size `AabbSet` and refactored block collision queries to support **multiple AABBs per block**, enabling accurate non-cube shapes without resorting to overly-broad union bounding boxes.
- Updated world-collision checks to test against all colliders returned for a block.

### Stage 4 — Glass pane connectivity collision (WIP)

- Implemented neighbor-aware glass pane collision: a thin post plus connecting arms that extend toward connected neighbors.
- Added a regression test that verifies pane arms connect to neighbors while the far corner remains empty (proves multi-AABB is used, not a union bbox).

### Stage 4 — Fence gate open collision (WIP)

- Implemented an open fence gate collision plane that swings to the hinge side (simplified “left hinge”), so the center passage is open while the hinge side still collides.
- Updated the fence gate regression test to assert “closed collides in the middle; open clears the middle but collides near the hinge”.

### Verification (post-change 30)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `cargo test -p mdminecraft-world --test determinism_worldtest -- --nocapture`

### Stage 4 — Fence collision uses arms (multi-AABB) (WIP)

- Replaced the fence “union bounding box” with a **post + arms** collision model, so a fence connected in multiple directions no longer blocks the far block corners.
- Added a regression test that asserts a connected fence does not fill the diagonal corner while still colliding on each connected arm.

### Stage 4 — Trapdoor open collision (WIP)

- Implemented open trapdoor collision as a thin vertical plane (3/16) based on facing, so open trapdoors behave like real obstacles instead of becoming fully non-collidable.
- Updated the trapdoor regression test accordingly.

### Stage 4 — Stairs collision shape (incremental) (WIP)

- Implemented a 2-AABB “two-step” collision for stairs (bottom half + upper half footprint based on facing), replacing the previous single 0.5-step approximation.
- Updated the stairs step-up regression test to use a facing that exercises the lower step without intersecting the upper step in a single tick.

### Verification (post-change 31)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Placement-facing state (WIP)

- Block placement now assigns facing bits for oriented blocks (stairs, trapdoors, fence gates) based on player yaw, so collision/interaction reflects the placed orientation instead of always defaulting to `North`.
- Ladder placement now encodes facing based on the clicked block face (and refuses placement on non-wall faces), matching basic vanilla constraints.

### Stage 4 — Door placement (WIP)

- Placing a door lower block now attempts to place the matching upper block automatically (2-block placement), with both halves sharing the same facing/open state bits.

### Tests

- Added unit tests validating ladder facing state derivation and that door placement succeeds/fails depending on available space.

### Verification (post-change 32)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Hit-point aware placement (WIP)

- Extended `RaycastHit` with a world-space `hit_pos` so placement logic can use the **within-block hit fraction**.
- Slab placement now chooses top/bottom slabs based on the hit height when placing on side faces (and forces top/bottom when placing against bottom/top faces).
- Trapdoor placement now sets a new “top-half when closed” bit from hit height (and forces top when placed against a bottom face).

### Stage 4 — Trapdoor collision respects top-half bit (WIP)

- Added `is_trapdoor_top` / `set_trapdoor_top` in `mdminecraft_world` and updated `get_collision_type` so closed trapdoors collide either as a bottom plate or a top plate depending on state.
- Updated world/unit tests and added client-side placement-state tests for slabs/trapdoors.

### Verification (post-change 33)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Upside-down stairs (WIP)

- Added a stairs “top half” bit (0x04) during placement, derived from hit height / face, so players can place upside-down stairs.
- Updated stairs collision AABBs to respect the top-half bit (inverted shape): full top half plus a lower half-footprint step.
- Added regression tests for both placement state and inverted collision behavior.

### Verification (post-change 34)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Door break removes both halves (WIP)

- Mining either half of a placed door now also removes the paired half, preventing floating door remnants.
- Added a regression test around `GameWorld::try_remove_other_door_half`.

### Verification (post-change 35)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Glass pane rendering (WIP)

- Added a custom meshing path for glass panes in `mdminecraft-render` so they render as a thin post + connecting arms instead of a full cube.
- Excluded glass panes from the greedy cube mesher to avoid duplicate “pane-as-cube” geometry.

### Verification (post-change 36)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Fence rendering (WIP)

- Added a custom meshing path for `oak_fence` that renders a tall post plus connecting rails (two heights) based on neighbor connectivity.
- Excluded `oak_fence` from the greedy cube mesher to remove incorrect full-cube geometry.

### Verification (post-change 37)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Fence gate rendering (WIP)

- Added a custom meshing path for `oak_fence_gate` that renders as a thin gate plane (open vs closed) based on facing + open state.
- Excluded `oak_fence_gate` from the greedy cube mesher to remove incorrect full-cube geometry.

### Verification (post-change 38)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Stairs rendering (WIP)

- Added a custom meshing path for `stone_stairs` and `oak_stairs` so they render as a two-box step shape (bottom or upside-down), based on facing + the top-half (0x04) bit.
- Excluded stairs from the greedy cube mesher and forced them to be treated as non-opaque for face culling, preventing “holes” in adjacent full-block geometry.

### Verification (post-change 39)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Slabs/trapdoors/doors/ladders rendering (WIP)

- Added custom meshing paths for slabs (top/bottom), trapdoors (open/closed + top-half), doors (thin cuboid with open rotation; seam faces between halves culled), and ladders (thin inset plate on the correct wall face).
- Excluded these blocks from the greedy cube mesher; forced slabs to be treated as non-opaque for face culling to avoid “holes” in adjacent full-block geometry.

### Verification (post-change 40)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Torch rendering (WIP)

- Added a custom meshing path for `torch` and `redstone_torch` so they render as a small centered pillar (instead of a full cube).
- Excluded torches from the greedy cube mesher.

### Verification (post-change 41)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Neighbor-aware meshing across chunk seams (WIP)

- Added `mdminecraft-render::mesh_chunk_with_voxel_at` so meshing can query world voxels (needed for neighbor-aware blocks).
- Updated glass panes + oak fences meshing to query neighbors via the sampler, enabling correct connectivity across chunk borders.
- Updated the game’s mesh upload paths to use the sampler-based mesher and to refresh neighboring chunk meshes after seam-lighting updates, chunk load/unload, and explosions.

### Verification (post-change 42)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Crop rendering (WIP)

- Added crossed-quad (“X”) meshing for crop blocks (wheat/carrots/potatoes stages), scaling plant height by growth stage.
- Excluded crop blocks from the greedy cube mesher.

### Verification (post-change 43)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Redstone component rendering (WIP)

- Added custom meshing for redstone wire (flat line with neighbor connectivity across chunk seams), pressure plates (pressed/unpressed), buttons (pressed/unpressed; default north-facing for now), and levers (simplified handle offset).
- Excluded these blocks from the greedy cube mesher to remove incorrect full-cube geometry.

### Verification (post-change 44)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Cave decoration rendering (WIP)

- Added simple non-cube meshing for several non-solid cave decoration blocks (moss carpet as a thin layer; dripstone as a thin column; lichen/vines/roots/spore blossom/sculk vein as crossed quads).
- Excluded these blocks from the greedy cube mesher to avoid full-block geometry that didn’t match collision.

### Verification (post-change 45)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Bed/chest rendering (WIP)

- Added simple partial-height meshing for beds (9/16) and chests (14/16) to match their collision heights.
- Excluded bed and chest blocks from the greedy cube mesher to remove full-block geometry.

### Verification (post-change 46)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Farmland collision/render parity (WIP)

- Implemented farmland (`farmland`/`farmland_wet`) collision as a 15/16-height partial block.
- Added partial-height farmland meshing and excluded farmland from the greedy cube mesher; also forced farmland to be treated as non-opaque for face culling to avoid holes around the lowered top surface.

### Verification (post-change 47)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Seam connectivity render tests (WIP)

- Hardened the glass pane seam-connectivity test by building a `BlockRegistry` large enough to define the pane id (and mark it non-opaque), avoiding registry-related artifacts during meshing.
- Added render unit tests to lock in sampler-based chunk-seam connectivity for:
  - oak fences
  - redstone wire

### Verification (post-change 48)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Enchanting table / brewing stand collision + rendering (WIP)

- Implemented partial-height collision types for `enchanting_table` (12/16) and `brewing_stand` (14/16).
- Added a narrower brewing stand collision AABB (matches a centered 8/16×8/16 footprint) to reduce “full-block” over-collision.
- Added custom meshing for enchanting tables and brewing stands; excluded them from the greedy cube mesher and treated them as non-opaque for face culling to avoid missing faces adjacent to the partial shape.
- Added unit tests to lock in the collision type and the rendered max height for both blocks.

### Verification (post-change 49)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Fence/pane connectivity parity (WIP)

- Updated glass pane and oak fence connectivity rules in the renderer to use `BlockPropertiesRegistry::is_solid` (cached via `OnceLock`) instead of `opaque`, matching the collision/connectivity logic and avoiding “invisible arms” against non-opaque solid blocks like glass/leaves.

### Verification (post-change 50)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
