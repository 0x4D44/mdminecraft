# Comprehensive Code Review Plan
**Date:** 2025-12-10
**Goal:** Thoroughly review the `mdminecraft` codebase for architectural integrity, determinism adherence, performance, safety, and code quality.

## Review Strategy

The review will be conducted in passes, organized by crate and functional area. Each pass will utilize `read_file` to inspect key files and `search_file_content` to identify patterns.

### Pass 1: Foundation & Core Types (`crates/core`, `crates/ecs`)
**Focus:** Type safety, data layout, fundamental primitives.
*   **Key Files:**
    *   `crates/core/src/lib.rs` (SimTick, Voxel)
    *   `crates/core/src/item.rs`
    *   `crates/ecs/src/lib.rs` (Bevy wrapper logic)
*   **Checks:**
    *   Are fundamental types (`Voxel`, `BlockId`) memory efficient?
    *   Is the ECS abstraction leaking implementation details?
    *   Are `SimTick` and time handling consistent?

### Pass 2: World Simulation & Determinism (`crates/world`)
**Focus:** **DETERMINISM**, procedural generation, state management.
*   **Key Files:**
    *   `crates/world/src/chunk.rs`
    *   `crates/world/src/terrain.rs`
    *   `crates/world/src/noise.rs`
    *   `crates/world/src/persist.rs`
    *   `crates/world/src/lighting.rs`
*   **Checks:**
    *   **CRITICAL:** Search for `std::time`, `rand::thread_rng`, `HashMap` iteration.
    *   Verify noise generation inputs (are they properly seeded?).
    *   Check persistence safety (untrusted input handling in `persist.rs`).
    *   Analyze lighting propagation efficiency (flood fill algorithms).

### Pass 3: Networking & Protocol (`crates/net`, `crates/server`, `crates/client`)
**Focus:** Security, bandwidth efficiency, prediction logic.
*   **Key Files:**
    *   `crates/net/src/protocol.rs` (Message definitions)
    *   `crates/net/src/prediction.rs` (Rollback logic)
    *   `crates/server/src/lib.rs` (Authoritative loop)
    *   `crates/client/src/multiplayer.rs` (Reconciliation)
*   **Checks:**
    *   Are network messages properly size-bounded?
    *   Is input validation performed on the server?
    *   Does prediction logic handle edge cases (e.g., lag spikes)?

### Pass 4: Rendering & Performance (`crates/render`, `crates/ui3d`)
**Focus:** GPU resource management, meshing performance, WGPU usage.
*   **Key Files:**
    *   `crates/render/src/chunk_manager.rs` (Mesh generation/caching)
    *   `crates/render/src/mesh.rs` (Vertex generation)
    *   `crates/render/src/driver.rs` (WGPU render loop)
*   **Checks:**
    *   Is "Greedy Meshing" implemented efficiently?
    *   Are buffers managed correctly (avoiding constant re-allocation)?
    *   Is the frame loop blocked by CPU operations?

### Pass 5: Application Glue (`src/`)
**Focus:** Integration, input handling, initialization.
*   **Key Files:**
    *   `src/main.rs`
    *   `src/game.rs`
*   **Checks:**
    *   How is the loop paced?
    *   Is error handling robust at the top level?

## Specific Patterns to Hunt
*   **Determinism Killers:** `std::time::SystemTime`, `rand::random`, `HashMap::keys()`, `HashSet::iter()`.
*   **Performance Killers:** `clone()` in hot loops, `Vec::insert(0, ...)`, blocking I/O in async contexts.
*   **Safety Risks:** `unsafe` blocks (audit all), `unwrap()` on network data.

## Deliverable
A comprehensive report (`wrk_docs/2025.12.10 - CR - Comprehensive Code Review.md`) detailing:
1.  Executive Summary
2.  Critical Issues (Must Fix)
3.  Major Recommendations (Should Fix)
4.  Minor Improvements (Nice to Have)
5.  Component-specific Deep Dives
