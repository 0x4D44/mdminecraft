# 2025.12.25 - JRN - Headless Automation Harness

## Goal

Implement the automation harness described in:

- `wrk_docs/2025.12.25 - HLD - Headless Automation Harness.md`
- `wrk_docs/2025.12.25 - PLN - Headless Automation Harness Implementation Plan.md`

Deliverables include: NDJSON automation server, action injection, deterministic step mode, headless/offscreen rendering, and screenshot capture.

## Progress Log

### 2025-12-25

- Initialized implementation work (Stage 0/1): added journal + started scaffolding.
- Added initial automation scaffolding:
  - CLI flags: `--automation-listen`, `--automation-token`, `--automation-log`.
  - `src/automation/` module with protocol parsing and a TCP server thread.
  - Protocol v1 supports `hello` + structured `error` and enforces max line size.
- Server is started from `src/main.rs` when `--automation-listen` is provided (currently handshake-only; no game control yet).
- Ran fmt/clippy/tests to ensure the scaffolding is warning-free and does not break existing behavior.
- Stage 2 (windowed automation control) landed:
  - Added controller → game-thread bridge (`AutomationMsg`, `AutomationEndpoint`) and integrated it into `GameWorld`.
  - Implemented automation ops: `set_actions`, `pulse`, `set_view`, `command`, `get_state`, `shutdown`.
  - Added protocol unit tests for common parsing/error cases.
- Fixed a runtime WGSL validation failure in the voxel shader (“entry point cannot be called”) by removing the fragment helper’s dependency on the stage IO struct and added always-on WGSL validation tests in `mdminecraft-render`.
- Stage 3 (screenshots) landed in windowed mode:
  - New CLI flags: `--resolution <WxH>`, `--screenshot-dir <path>`, `--screenshot-every-ticks <N>`, `--screenshot-max <N>`.
  - Added a screenshot readback API in `mdminecraft-render` (`record_texture_readback` + `write_png`).
  - Windowed capture uses an offscreen texture on screenshot frames, then copies to the swapchain for display (avoids relying on surface `COPY_SRC`).
  - Added automation op `screenshot` returning `{"event":"screenshot", ...}` and writing `run.json` metadata into the screenshot directory.
- Stage 4/5 (headless harness) progressed:
  - `mdminecraft-render` now supports headless/offscreen initialization (no surface/window) via `Renderer::initialize_gpu_headless()`.
  - Added headless execution path (`--headless`) with a deterministic tick loop (`GameWorld::automation_tick`) and a headless runner:
    - Free-run mode (`run_headless_free`) advances ticks continuously.
    - Step mode (`--automation-step`, `run_headless_step`) advances only on `{"op":"step","ticks":N}` and responds with `{"event":"stepped",...}`.
  - Added `--no-render` (simulation-only) semantics:
    - Screenshot requests return `unsupported` with `"render disabled"`.
  - Step-mode periodic screenshots (`--screenshot-every-ticks`) are emitted as streamed `screenshot` events during the step response when rendering is enabled.
  - Added new CLI flags for harness operation: `--no-audio`, `--save-dir`, `--no-save`, `--reset-world`, `--world-seed`, `--max-ticks`, `--automation-exit-when-disconnected`.
  - Added a CI-friendly integration test (`tests/headless_automation_no_render.rs`) that spawns `mdminecraft --headless --no-render --automation-step` and verifies `hello/get_state/command/step/screenshot/shutdown`.
- Stage 6 additions:
  - Added a gated GPU screenshot smoke test (`tests/headless_automation_gpu_screenshot.rs`) enabled via `MDM_RUN_HEADLESS_GPU_TESTS=1`.
  - Hardened the automation server to avoid blocking on the game-thread channel by using `try_send` and returning a structured `busy` error when overloaded.
  - Added unix-only UDS support (`--automation-uds`) and a no-render step-mode smoke test (`tests/headless_automation_uds_no_render.rs`).
  - Added a small reference automation client for running NDJSON scripts: `tools/harness_client/mdm_harness_client.py`.
- Follow-up harness polish:
  - Improved JSONL logging (`--automation-log`) to record inbound requests, outbound responses, and parse errors (with hello token redacted as `token_present`).
  - Added `--exit-when-script-finished` (headless): exits once `--command-script` completes.

## Decisions / Notes

- Start with **windowed automation server** + **protocol v1** scaffolding before touching headless rendering.
- Keep changes **feature-gated by CLI flags** to avoid altering existing gameplay behavior until headless paths are ready.
- For windowed screenshots, capture frames by rendering into a dedicated offscreen texture (COPY_SRC) and then copying into the surface (COPY_DST), so we don’t depend on swapchain readback support.

## Next Steps

- All plan stages are complete; fmt/clippy/tests are green.

## Commands Run

- `cargo check`
- `cargo fmt --all`
- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `cargo test -p mdminecraft`
- `cargo test -p mdminecraft-render --tests`
- `cargo test -p mdminecraft --test headless_automation_no_render`
