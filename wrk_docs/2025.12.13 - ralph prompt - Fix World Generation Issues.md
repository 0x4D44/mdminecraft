# Ralph Wiggum Implementation Prompt: Fix World Generation Issues

## Overview

Fix critical world generation and rendering issues that prevent players from seeing a fully populated world. The game currently has invisible leaves, missing structures, very low mob spawn rates, and no villagers/NPCs.

---

## Issue 1: Transparent Blocks Not Rendering (CRITICAL)

### Problem
The mesh generator in `crates/render/src/mesh.rs` only generates faces at opaque/non-opaque boundaries. Since leaves, glass, water, and other transparent blocks have `opaque: false`, and air also has `opaque: false`, no faces are generated for transparent blocks - they are completely invisible.

### Location
`crates/render/src/mesh.rs` lines 262-283 in `sample_face` function

### Current Broken Logic
```rust
match (is_opaque(a, registry), is_opaque(b, registry)) {
    (true, false) => { /* emit face for opaque block */ }
    (false, true) => { /* emit face for opaque block */ }
    _ => None,  // Both non-opaque = no face (BUG!)
}
```

### Required Fix
Change the logic to also generate faces for **non-air transparent blocks** when adjacent to air or other different blocks. The mesher needs to distinguish between:
1. Air (block_id = 0) - truly empty, never render
2. Transparent solid blocks (leaves, glass, water) - render faces when adjacent to air or different blocks
3. Opaque blocks - current behavior is correct

### Implementation Approach
1. Create a helper function `is_solid(voxel, registry) -> bool` that returns true for any non-air block
2. Create a helper function `is_transparent(voxel, registry) -> bool` that returns true for non-opaque, non-air blocks
3. Modify `sample_face` to generate faces when:
   - Opaque block adjacent to non-opaque (current behavior)
   - Transparent block adjacent to air
   - Transparent block adjacent to different transparent block (for glass next to water, etc.)

### Affected Blocks (from config/blocks.json)
All blocks with `opaque: false` that aren't air:
- oak_leaves, birch_leaves, spruce_leaves, azalea_leaves
- water, water_flowing, lava, lava_flowing
- glass, glass_pane
- All doors (oak_door_lower/upper, iron_door_lower/upper)
- ladder, oak_fence, oak_fence_gate
- All crops (wheat_0-7, carrots_0-3, potatoes_0-3)
- torch, redstone_torch, redstone_wire
- All pressure plates, buttons, levers
- trapdoor, chest, bed_head/foot
- cave_vines, moss_carpet, spore_blossom, hanging_roots
- glow_lichen, sculk_vein, pointed_dripstone
- brewing_stand

### Test
After fix, create a world and verify:
- Trees have visible leaf canopies
- Water is visible
- Glass blocks render
- Torches are visible

---

## Issue 2: Structures Not Generating

### Problem
Structure generation (aquifers, geodes) is commented out in terrain generation.

### Location
`crates/world/src/terrain.rs` lines 140-141

### Current Code
```rust
// Decorators (Aquifers, Geodes, etc. - simplified/removed for now or re-enabled later)
// self.aquifer_gen.fill_aquifers(&mut chunk, chunk_pos.x, chunk_pos.z);
```

### Required Fix
1. Check if `aquifer.rs` and `geode.rs` have working implementations
2. Add the generators to `TerrainGenerator` struct
3. Uncomment/implement the decorator calls in `generate_chunk`
4. Add appropriate generation passes:
   - Aquifers (underground water pools)
   - Geodes (amethyst structures)
   - Possibly add: dungeons, mineshafts, villages

### Implementation
In `TerrainGenerator::new()`:
```rust
// Add fields for structure generators
aquifer_gen: AquiferGenerator::new(world_seed),
geode_gen: GeodeGenerator::new(world_seed),
```

In `generate_chunk()` after ore generation:
```rust
// Structure decoration pass
self.aquifer_gen.generate(&mut chunk, chunk_pos);
self.geode_gen.generate(&mut chunk, chunk_pos);
```

### Test
Generate chunks at various locations and verify structures appear underground.

---

## Issue 3: Very Low Mob Spawn Rates

### Problem
Passive mob spawn rate is only 5% per spawn point with only 4 spawn points per chunk, resulting in ~0.2 mobs per chunk average. Players see almost no animals.

### Location
`crates/world/src/mob.rs` lines 606-616

### Current Code
```rust
// Try to spawn mobs on a grid pattern (every 8 blocks)
for local_x in (0..CHUNK_SIZE_X).step_by(8) {
    for local_z in (0..CHUNK_SIZE_Z).step_by(8) {
        // ...
        // Spawn chance: 5% per spawn point
        let spawn_roll = (pos_seed % 100) as f32 / 100.0;
        if spawn_roll > 0.05 {
            continue;
        }
```

### Required Fix
Increase spawn rates to provide a more populated world:
1. Reduce grid step from 8 to 4 (16 spawn points per chunk instead of 4)
2. Increase spawn chance from 5% to 15-20%
3. This gives ~2.4-3.2 mobs per chunk in mob-supporting biomes

### Implementation
```rust
// Try to spawn mobs on a grid pattern (every 4 blocks)
for local_x in (0..CHUNK_SIZE_X).step_by(4) {
    for local_z in (0..CHUNK_SIZE_Z).step_by(4) {
        // ...
        // Spawn chance: 15% per spawn point
        let spawn_roll = (pos_seed % 100) as f32 / 100.0;
        if spawn_roll > 0.15 {
            continue;
        }
```

### Also Consider
- Add mob spawning to more biomes (currently missing: Mountains, RainForest has none)
- Add fish/squid spawning in Ocean biomes
- Ensure hostile mobs spawn at night with reasonable rates

### Test
Create a new world and walk around Plains/Forest biomes - should see multiple animals (pigs, cows, sheep, chickens) within view distance.

---

## Issue 4: No Villagers/NPCs

### Problem
There are no villager or NPC entities in the game. The mob system only has passive animals and hostile mobs.

### Location
`crates/world/src/mob.rs` - MobType enum and spawning logic

### Required Implementation

#### 4.1 Add Villager MobType
```rust
pub enum MobType {
    // Existing passive mobs...
    Pig, Cow, Sheep, Chicken,

    // Add villager
    Villager,

    // Existing hostile mobs...
    Zombie, Skeleton, Spider, Creeper,
}
```

#### 4.2 Villager Properties
```rust
impl MobType {
    pub fn movement_speed(&self) -> f32 {
        match self {
            MobType::Villager => 0.2,
            // ...
        }
    }

    pub fn size(&self) -> f32 {
        match self {
            MobType::Villager => 0.6,
            // ...
        }
    }

    pub fn max_health(&self) -> f32 {
        match self {
            MobType::Villager => 20.0,
            // ...
        }
    }
}
```

#### 4.3 Villager Spawning
Option A: Spawn villagers rarely in Plains biomes
```rust
pub fn for_biome(biome: BiomeId) -> Vec<(MobType, f32)> {
    match biome {
        BiomeId::Plains => vec![
            (MobType::Pig, 10.0),
            (MobType::Cow, 8.0),
            (MobType::Sheep, 12.0),
            (MobType::Chicken, 10.0),
            (MobType::Villager, 2.0),  // Rare villager spawns
        ],
        // ...
    }
}
```

Option B (Better): Generate village structures with villagers
- Create a `VillageGenerator` that places village structures
- Spawn villagers inside village bounds during structure generation
- This requires structure generation (Issue 2) to be working first

#### 4.4 Villager AI
Add basic villager behavior to `Mob::update()`:
- Wander during day
- Go indoors at night (if villages exist)
- Flee from hostile mobs
- Don't attack player

#### 4.5 Villager Rendering
Ensure `game.rs` mob rendering handles villagers:
- Add villager model/texture or use placeholder
- Villagers should be visually distinct from animals

### Test
Create world, find Plains biome, verify villagers spawn and wander around without attacking.

---

## Implementation Order

1. **Fix transparent block rendering first** (Issue 1) - This is blocking tree visibility
2. **Increase mob spawn rates** (Issue 3) - Quick win, immediate visual improvement
3. **Add villager mob type** (Issue 4) - Extends existing mob system
4. **Enable structure generation** (Issue 2) - May require more work depending on state of generators

---

## Files to Modify

| File | Changes |
|------|---------|
| `crates/render/src/mesh.rs` | Fix transparent block face generation |
| `crates/world/src/mob.rs` | Add Villager type, increase spawn rates |
| `crates/world/src/terrain.rs` | Uncomment/enable structure generators |
| `crates/world/src/aquifer.rs` | Verify/fix aquifer generation |
| `crates/world/src/geode.rs` | Verify/fix geode generation |
| `src/game.rs` | Ensure villager rendering works |

---

## Verification Checklist

- [ ] Trees have visible green leaf canopies
- [ ] Glass blocks are visible and transparent
- [ ] Water renders correctly
- [ ] Torches and other small blocks are visible
- [ ] 2-4 passive mobs visible per chunk in Plains/Forest
- [ ] Villagers spawn and wander in Plains
- [ ] Underground structures (aquifers, geodes) generate
- [ ] All existing tests pass (`cargo test --all`)
- [ ] Game runs without crashes (`cargo run -- --auto-play`)
