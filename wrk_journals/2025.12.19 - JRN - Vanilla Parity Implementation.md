# Vanilla Parity Implementation Journal

**Date:** 2025-12-19  
**Repo:** `/home/md/language/mdminecraft`  
**Plan:** `wrk_docs/2025.12.19 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  

---

## 2025-12-19

### Stage 3 — Farming expansion: carrots + potatoes (+ baked potato)

- Added dropped-item support for **carrot**, **potato**, and **baked potato** (stable IDs appended), plus dropped↔core conversion mappings so pickup/drop works end-to-end.
- Extended core food types to include **Carrot**, **Potato**, and **BakedPotato**, and tuned hunger restore values.
- Expanded right-click farmland interactions:
  - wheat seeds → wheat (`wheat_0`)
  - carrot → carrots (`carrots_0`)
  - potato → potatoes (`potatoes_0`)
  - clicks on farmland now “belong” to planting attempts (so they don’t accidentally eat the held food when the spot is blocked).
- Added vanilla-ish deterministic drops:
  - mature carrots/potatoes drop extra produce in addition to the base drop.
- Added a vanilla-ish deterministic acquisition path:
  - zombies can drop carrots/potatoes (small deterministic chance) to bootstrap farming.
- Added furnace parity:
  - potato → baked potato smelting recipe in the world furnace.

### Verification (post-change 77)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing: gunpowder → splash potions

- Added `bottle_is_splash` to `BrewingStandState` (serde-defaulted for backwards-compatible deserialization) and implemented the gunpowder brewing step to convert drinkable potions into splash variants.
- Wired client↔world mappings so gunpowder is accepted as a brewing ingredient and bottles preserve splash state through the UI/hotbar.
- Added dropped-item support for splash potions so dropping/spilling/brewing-stand-break drops are safe.
- Added a micro snapshot for the gunpowder→splash conversion step.

### Verification (post-change 78)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: spider eyes → poison

- Added dropped-item support for **spider eyes** (stable IDs appended) and wired dropped↔core conversion so pickup/drop works end-to-end.
- Added a client-side core item ID for spider eyes and mapped it into the brewing ingredient pipeline (`SPIDER_EYE`), enabling brewing stand UI placement and shift-move.
- Added vanilla-ish deterministic spider-eye drops to spiders (0–1 per kill) to support acquiring the ingredient in survival.
- Added a micro snapshot covering **Awkward + Spider Eye → Poison**.

### Verification (post-change 79)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: golden carrots → night vision

- Added `FoodType::GoldenCarrot` (edible) and dropped-item support so pickup/drop works end-to-end.
- Added a vanilla-ish crafting recipe: **carrot + gold ingot → golden carrot**.
- Wired brewing ingredient mapping so golden carrots are accepted by the brewing stand (enables **Awkward + Golden Carrot → Night Vision**).
- Added unit coverage for crafting + brewing-slot shift-move behavior and conversion mappings.

### Verification (post-change 80)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Sugar cane + paper/books chain (+ brewing sugar → swiftness)

- Added **sugar cane** as a real block (appended to `config/blocks.json` and block ID constants) with:
  - vanilla-ish placement rules (must be on dirt/grass/sand adjacent to water, or stacked on sugar cane)
  - support removal behavior (column breaks when support is removed)
  - deterministic worldgen near water + deterministic growth system
- Added dropped-item support (stable IDs appended) for:
  - **SugarCane** (placeable block item)
  - **Sugar**, **Paper**, **Book** (generic items)
  - plus dropped↔core conversion mappings so pickup/drop/spill works end-to-end.
- Added vanilla-ish crafting chain:
  - sugar cane → sugar
  - 3 sugar cane → 3 paper
  - 3 paper + leather → book
  - updated bookshelf recipe to **6 planks + 3 books → bookshelf** (removes the old wheat placeholder).
- Wired sugar into brewing ingredient mapping so **Awkward + Sugar → Swiftness** is playable via the brewing stand UI.
- Added a micro snapshot covering **Awkward + Sugar → Swiftness**, plus unit coverage for crafting/conversions/support removal.

### Verification (post-change 81)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: brown mushrooms + fermented spider eye

- Added **brown mushrooms** as a real block (appended to `config/blocks.json` as ID 105) with:
  - vanilla-ish placement rules (top-face only; requires a solid support block)
  - support removal behavior (pops if the supporting block is removed)
  - deterministic worldgen (cave-ish placements; constrained to avoid altering surface-scanning worldtests)
- Added dropped-item support (stable IDs appended) for:
  - **BrownMushroom** (placeable block item)
  - **FermentedSpiderEye** (brewing ingredient item)
  - plus dropped↔core conversion mappings so pickup/drop/spill works end-to-end.
- Added a vanilla-ish crafting recipe:
  - **brown mushroom + sugar + spider eye → fermented spider eye** (shapeless; works in 2×2).
- Wired fermented spider eyes into the brewing ingredient pipeline (`FERMENTED_SPIDER_EYE`), enabling brewing stand UI placement + shift-move.
- Added a micro snapshot covering **Swiftness + Fermented Spider Eye → Slowness**, plus unit coverage for crafting, shift-move, and conversion mappings.

### Verification (post-change 82)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: magma cream + fire resistance

- Added a deterministic Overworld proxy block **magma_cream_ore** (appended to `config/blocks.json` as ID 106) and integrated it into ore generation at low Y so magma cream is obtainable before Nether content exists.
- Added dropped-item + core-item wiring for **Magma Cream**, including brewing stand UI acceptance + shift-move behavior.
- Added a micro snapshot covering **Awkward + Magma Cream → Fire Resistance**.

### Verification (post-change 83)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: ghast tears + regeneration

- Added a deterministic Overworld proxy block **ghast_tear_ore** (appended to `config/blocks.json` as ID 107) and integrated it into low-Y ore generation to provide an early access path to ghast tears before Nether content exists.
- Added dropped-item + core-item wiring for **Ghast Tear**, including brewing stand UI acceptance + shift-move behavior.
- Added a micro snapshot covering **Awkward + Ghast Tear → Regeneration**.

### Verification (post-change 84)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: glistering melons + rabbit feet (healing + leaping)

- Added deterministic Overworld proxy ore blocks:
  - **glistering_melon_ore** (appended to `config/blocks.json` as ID 108)
  - **rabbit_foot_ore** (appended to `config/blocks.json` as ID 109)
  - integrated into low-Y ore generation so the ingredients are obtainable without Nether/mob additions.
- Added dropped-item + core-item wiring for **Glistering Melon** and **Rabbit Foot**, including brewing stand UI acceptance + shift-move behavior.
- Added micro snapshots covering:
  - **Awkward + Glistering Melon → Healing**
  - **Awkward + Rabbit Foot → Leaping**

### Verification (post-change 85)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: phantom membranes + slow falling

- Added a deterministic Overworld proxy ore block **phantom_membrane_ore** (appended to `config/blocks.json` as ID 110) and integrated it into low-Y ore generation so phantom membranes are obtainable without Nether/mob additions.
- Added dropped-item + core-item wiring for **Phantom Membrane**, including brewing stand UI acceptance + shift-move behavior.
- Completed client-side potion plumbing for **Slow Falling** (drink + splash), including dropped↔core conversions for both bottle types.
- Added a micro snapshot covering **Awkward + Phantom Membrane → Slow Falling**.

### Verification (post-change 86)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Potions: gameplay effects + glass bottle return

- Implemented core potion gameplay effects so brewed potions are no longer “cosmetic-only”:
  - **Swiftness/Slowness** now modify player movement speed.
  - **Leaping** now boosts jump velocity.
  - **Strength/Weakness** now modify melee damage.
  - **Slow Falling** now reduces falling gravity/terminal velocity and prevents fall damage while active.
  - **Regeneration/Poison** now tick health over time (vanilla-ish intervals; poison won’t kill).
  - **Healing/Harming** now apply instantly when drunk.
- Drinking a potion now returns an **empty glass bottle** to storage (or spills if full).
- Added focused unit coverage for instant + over-time potion health effects.

### Verification (post-change 87)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing modifiers: redstone/glowstone (Long/Strong variants)

- Added deterministic Overworld proxy ore blocks:
  - `redstone_dust_ore` (ID 111) → drops **Redstone Dust**
  - `glowstone_dust_ore` (ID 112) → drops **Glowstone Dust**
- Implemented per-bottle modifier state in `BrewingStandState`:
  - `bottle_is_extended` (redstone “long” duration)
  - `bottle_amplifier` (glowstone “strong” level; currently 0–1)
  - both are `serde(default)` for backwards-compatible save loads.
- Implemented redstone/glowstone brewing behavior (vanilla-ish constraints):
  - **Redstone Dust** extends duration for duration potions (no effect on instant potions).
  - **Glowstone Dust** strengthens supported potions (Swiftness/Leaping/Healing/Harming/Poison/Regeneration/Strength).
  - Modifiers are preserved across normal recipe transformations when meaningful, otherwise clamped/cleared.
- Appended stable core potion IDs for long/strong variants and wired UI naming + bottle↔core conversions so inventories represent variants correctly.
- Updated potion gameplay application (drink + splash) to honor **extended duration** and **amplifier** (including strong Healing/Harming).
- Added dropped-item variants for long/strong potions (drinkable + splash) plus dropped↔core conversion mappings so pickup/drop works end-to-end.
- Added parity micro snapshots covering:
  - Swiftness + Redstone Dust → **Long Swiftness**
  - Healing + Glowstone Dust → **Strong Healing**

### Verification (post-change 88)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `MDM_UPDATE_SNAPSHOTS=1 cargo test -p mdminecraft-world --test parity_micro_snapshots`

### Stage 3 — Brewing expansion: pufferfish + water breathing

- Added a deterministic Overworld proxy ore block **pufferfish_ore** (appended to `config/blocks.json` as ID 113) so water-breathing ingredients are obtainable without fishing/ocean mobs.
- Added dropped-item + core-item wiring for **Pufferfish**, including brewing-stand UI acceptance and shift-move behavior.
- Implemented the missing brewing step: **Awkward + Pufferfish → Water Breathing** (with Redstone extension supported via the existing modifier system).
- Added a micro snapshot covering **Awkward + Pufferfish → Water Breathing**.

### Verification (post-change 89)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `MDM_UPDATE_SNAPSHOTS=1 cargo test -p mdminecraft-world --test parity_micro_snapshots`

### Stage 3 — Potions: invisibility hostile detection + night vision visuals

- Invisibility now reduces **hostile mob detection range** (simple visibility multiplier; currently `0.25`).
- Night Vision now boosts the **minimum brightness** of voxel rendering (visual-only; simulation unchanged).
- Test runtime hygiene: tuned `terrain::tests::test_biome_specific_surface_blocks` to sample fewer chunks (avoids the “looks hung” 60s warning in `cargo test` runs).

### Verification (post-change 90)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `cargo test -p mdminecraft-world terrain::tests::test_biome_specific_surface_blocks`

### Stage 3 — UX: status effects HUD overlay

- Added a top-right HUD overlay listing active status effects with **level** and **remaining time** (sorted deterministically; green for positive effects, red for negative).

### Verification (post-change 91)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test -p mdminecraft`
- `cargo test --workspace`

### Stage 3 — Buckets: crafting + fluid pickup/place

- Added client-reserved core item IDs for **Bucket**, **Water Bucket**, and **Lava Bucket** and enforced **non-stackable** behavior in both core stacks and dropped-item stacks.
- Added dropped-item variants (appended for stable IDs) and wired dropped↔core conversions so pickup/drop/spill works end-to-end.
- Added a vanilla-ish crafting recipe: **3 iron ingots → 1 bucket** (shaped: `I _ I / _ I _`).
- Implemented right-click bucket interactions:
  - empty bucket picks up **water/lava source blocks**
  - filled buckets place a **source block** into adjacent air/replaceable fluid space
  - placement/removal notifies the fluid simulator and refreshes affected chunk lighting/meshes.
- Added focused unit coverage for conversions + crafting + bucket pickup/place behavior.

### Verification (post-change 92)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: cobblestone walls (crafting + meshing + collisions)

- Added a new block `cobblestone_wall` (appended to `config/blocks.json` as ID `114`) and exposed it as `interactive_blocks::COBBLESTONE_WALL` for rendering/collision rules.
- Added dropped-item support (stable IDs appended) so walls can be dropped/picked up and breaking the block drops the correct item.
- Added a vanilla-ish crafting recipe: **6 cobblestone → 6 cobblestone walls**.
- Implemented neighbor-aware wall meshing (plus a chunk-seam connectivity unit test) and fence-height collision with thicker post/arms (plus a unit test).

### Verification (post-change 93)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: iron bars (crafting + meshing + collisions)

- Added a new block `iron_bars` (appended to `config/blocks.json` as ID `115`) and exposed it as `interactive_blocks::IRON_BARS`.
- Added dropped-item support (stable IDs appended) so iron bars can be dropped/picked up and breaking the block drops the correct item.
- Added a vanilla-ish crafting recipe: **6 iron ingots → 16 iron bars**.
- Extended thin-pane meshing and collision logic to support both glass panes and iron bars, including chunk-seam connectivity coverage and a collision shape unit test for bars.

### Verification (post-change 94)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: stone bricks family (crafting + drops + meshing + collisions)

- Added new blocks `stone_bricks` (ID `116`), `stone_brick_slab` (ID `117`), `stone_brick_stairs` (ID `118`), and `stone_brick_wall` (ID `119`).
- Added dropped-item support (stable IDs appended) so each block can be dropped/picked up and breaking the block drops the correct item.
- Added crafting recipes:
  - **4 stone → 4 stone bricks**
  - **3 stone bricks → 6 stone brick slabs**
  - **6 stone bricks → 4 stone brick stairs**
  - **6 stone bricks → 6 stone brick walls**
- Extended meshing/collision logic:
  - stairs meshing uses `is_stairs` (now includes stone brick stairs)
  - wall meshing now handles both cobblestone and stone brick walls (chunk-seam connectivity test added)
  - wall collision thickness now applies to stone brick walls (unit test added).

### Verification (post-change 95)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: stairs connectivity (inner/outer corners)

- Implemented vanilla-like **inner/outer corner shape resolution** for stairs based on neighboring stairs (front/back checks), and exposed reusable helpers:
  - `stairs_shape_at(...)` computes `StairsShape`
  - `stairs_step_footprints(...)` provides the step AABB footprints for the resolved shape.
- Rendering: stairs now mesh as straight/inner/outer shapes (including chunk seam neighbor sampling).
- Collision: stairs now collide with the same resolved corner shapes, avoiding “visible-but-non-solid” and “solid-but-invisible” mismatches.
- Added focused unit tests for stairs shape resolution and collision expectations.

### Verification (post-change 96)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: double slabs (slab stacking + correct drops)

- Added full-block **double slab** blocks for the currently-supported slab set (stone / oak / stone brick):
  - placing a slab onto an existing slab now merges into the corresponding double-slab block (vanilla-ish “stacking” behavior).
  - breaking a double slab drops **two** of the underlying slab items.
- Implemented merge rules to match vanilla-ish expectations:
  - clicking the “exposed half” of an existing slab merges regardless of which side face you click
  - clicking the “occupied half” does not merge (it behaves like a normal placement attempt).
- Added unit coverage for merge rules + mapping completeness, and drop-item mapping coverage for the new block IDs.

### Verification (post-change 97)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Redstone: powerable blocks (doors/trapdoors/fence gates)

- Added a `redstone_powered` state bit for powerable interactive blocks (doors, trapdoors, fence gates).
- Extended the redstone simulator to update these blocks when neighboring power changes:
  - powered → open, unpowered → closed
  - open state is only forced when the powered flag changes (so manual open/close is preserved while unpowered).
- Interaction parity: while a block is redstone-powered, manual toggling is suppressed (vanilla-ish behavior).
- Added focused redstone unit coverage:
  - iron doors open/close with power
  - trapdoors + fence gates open/close with power
  - unpowered manual door-open survives “no-op” redstone updates.

### Verification (post-change 98)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: connectivity rules (full-cube neighbor classification + pane/bar connection)

- Added `is_full_cube_block(...)` helper for connectivity checks (separates “has collision” from “has a full solid face”).
- Updated meshing + collision connectivity for:
  - fences / walls (connect to full blocks + same-family blocks; walls also connect to fence gates)
  - glass panes / iron bars (connect to full blocks + **each other**, vanilla-ish).
- Avoids visibly-wrong “connection arms” to non-full blocks like doors/trapdoors, and keeps collisions consistent with visuals.
- Added focused unit coverage:
  - pane↔bars mesh connectivity across a chunk seam
  - pane↔bars collision connectivity
  - pane does **not** connect to doors.

### Verification (post-change 99)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Redstone: dust places wire + wire drops dust

- Updated dropped-item mapping so breaking **redstone wire** drops **redstone dust** (vanilla-ish).
- Updated hotbar placement rules so holding **redstone dust** places **redstone wire**.
- Added focused unit coverage for the new mappings.

### Verification (post-change 100)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Crafting: redstone torch

- Added a vanilla-ish crafting recipe: **1 redstone dust + 1 stick → 1 redstone torch** (craftable in 2×2).
- Added unit coverage for the recipe.

### Verification (post-change 101)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Crafting: redstone lamp

- Added a crafting recipe for **redstone lamps** (vanilla-inspired): alternating redstone/glowstone dust in a 3×3 grid.
- Added unit coverage for the recipe.

### Verification (post-change 102)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Redstone: repeater (delay + directional power)

- Added a new `redstone_repeater` block (append-only `blocks.json` ID: 123) with non-cube collision + custom meshing.
- Added a vanilla-ish crafting recipe: `torch dust torch / stone stone stone` → repeater.
- Placement sets facing; right-click cycles repeater delay (1→4).
- Redstone sim:
  - reads input from “behind” and emits power only out the “front”
  - output changes after the configured delay (tick-scheduled), enabling clocks/delay lines.
- Added dropped-item mappings + focused unit coverage (delay roundtrip + directional/delayed output).

### Verification (post-change 103)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 10 — Redstone: comparator (compare/subtract + 1-tick delay)

- Added `redstone_comparator` block (append-only `blocks.json` ID: 124) with:
  - facing on placement
  - right-click toggles **subtract mode**
  - directional output (front-only) with a 1-tick update delay (vanilla-ish).
- Added `nether_quartz_ore` (append-only `blocks.json` ID: 125) as a deterministic Overworld proxy to unlock comparator crafting:
  - generates during the ore pass (rare, like other proxy ores)
  - mining drops **Nether Quartz** (core item id `2023`).
- Added a vanilla crafting recipe: torches + nether quartz over stone → comparator.
- Rendering: added custom meshing for comparators and wire connectivity to comparator.
- Added focused unit coverage:
  - compare vs subtract output behavior
  - directional output + delay.

### Verification (post-change 104)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 10 — Redstone: observer (block-update pulse source)

- Added `redstone_observer` block (append-only `blocks.json` ID: 126).
- Added a vanilla crafting recipe: cobblestone ring + 2 redstone dust + nether quartz → observer.
- Placement (current restriction): top-face only; facing set from player yaw.
- Redstone sim:
  - stores a small “observed block” fingerprint in state bits (no extra block-entity needed)
  - detects changes in the “behind” voxel and emits a **2-tick pulse** after a **1-tick delay**
  - output is directional (front-only).
- Rendering: redstone wire connectivity recognizes observers (for more vanilla-ish wire visuals).
- Added focused unit coverage for pulse timing + directionality.

### Verification (post-change 105)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 10 — Redstone: piston (block push)

- Added `piston` + `piston_head` blocks (append-only `blocks.json` IDs: 127/128).
- Added a vanilla-ish crafting recipe: planks / cobble+iron+cobble / cobble+redstone+cobble → piston.
- Placement (current restriction): top-face only; facing set from player yaw (**horizontal-only** pistons for now).
- Redstone sim:
  - extends/retracts with a **1-tick delay** when powered/unpowered
  - pushes up to **12 blocks** in the facing direction (vanilla limit)
  - treats **air + fluids** as replaceable; current pushable set is intentionally conservative (no block-entities, doors/beds/crops, or other pistons)
  - emits “geometry changed” signals so the game recomputes **skylight + blocklight** and wakes the **fluid sim** after piston movement.
- Block-break handling: breaking either the base or head drops a piston and removes the paired part (no orphan heads).
- Added focused unit coverage for timing + push behavior.

### Verification (post-change 106)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
