# Journal — Vanilla Parity Implementation

**Date:** 2025-12-17  
**Repo:** `mdminecraft`  
**Plan reference:** `wrk_docs/2025.12.16 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  
**Previous journal:** `wrk_journals/2025.12.16 - JRN - Vanilla Parity Implementation.md`  

## Focus (Stage 1 kick-off)

- Begin Stage 1 (registry/metadata/dimension baseline) with minimal blast radius.
- Thread **DimensionId** through persistence + networking now (Overworld-only behavior remains the default).
- Add deterministic building blocks for later Stage 2 persistence (component metadata).

## Work Log

### 2025-12-17

- Added shared primitives in `mdminecraft-core`:
  - `crates/core/src/dimension.rs` (`DimensionId`)
  - `crates/core/src/registry.rs` (`RegistryKey`)
  - `crates/core/src/components.rs` (`ComponentMap`, `ComponentValue`)
- Networking dimension baseline (`mdminecraft-net`):
  - Protocol now includes `DimensionId` on `Transform` and `ChunkDataMessage`; bumped `PROTOCOL_VERSION` to `2`.
  - Chunk streaming made dimension-aware (keys include `(dimension, x, z)`), plus deterministic tie-breakers in heap ordering.
  - Entity replication visibility filters by dimension.
  - Restored `cargo clippy -p mdminecraft-net -- -D warnings` cleanliness (minor lints in transport + RLE decode).
- Persistence dimension baseline (`mdminecraft-world`):
  - `RegionStore` now supports dimension-aware read/write via `save_chunk_in_dimension` / `load_chunk_in_dimension` / `chunk_exists_in_dimension` while keeping legacy `save_chunk`/`load_chunk` as Overworld wrappers.
  - Region header version is now validated on load.
  - Added unit test: `persist::tests::save_and_load_chunk_across_dimensions`.
- Registry key adoption (start of “single registry truth” work):
  - `mdminecraft-assets` block registry now stores a `RegistryKey` per block and resolves ids via key (`id_by_name` accepts `stone` and `mdm:stone`).
  - `config/blocks.json` remains compatible; an optional `key` field is now supported and validated at load time.
  - Assets recipe parsing gained `parse_item_type_with_blocks(...)` so recipes can reference blocks by stable key/name when a `BlockRegistry` is available.
- Dimension-scoped chunk keys (deeper Stage 1 dimension baseline):
  - Added `ChunkKey { dimension, pos }` in `mdminecraft-world` and updated `ChunkStorage` to store chunks keyed by `(dimension, x, z)` while preserving Overworld-only adapter methods.
- Tags groundwork in the asset registry:
  - `config/blocks.json` can now include `tags: [...]` (optional; defaults empty).
  - `BlockRegistry` gained deterministic tag queries (`has_tag`, `blocks_with_tag`) with validation.
- Clippy cleanup on touched multiplayer plumbing:
  - Fixed a client-side unused variable.
  - Made server iteration + `Default` impl clippy-clean so `cargo clippy -p mdminecraft-client -- -D warnings` passes.

## Commands Run

- `cargo test -p mdminecraft-core`
- `cargo test -p mdminecraft-net`
- `cargo clippy -p mdminecraft-net -- -D warnings`
- `cargo test -p mdminecraft-world save_and_load_chunk_across_dimensions -- --nocapture`
- `cargo clippy -p mdminecraft-world --tests -- -D warnings`
- `cargo test -p mdminecraft-world --test parity_micro_snapshots`
- `cargo test -p mdminecraft-assets`
- `cargo clippy -p mdminecraft-assets -- -D warnings`
- `cargo clippy -p mdminecraft-client -- -D warnings`
- `cargo test -p mdminecraft-assets`
- `cargo clippy -p mdminecraft-net -- -D warnings`

## Next Steps

- Stage 1: start converging on a single registry truth (blocks/items/entities) using `RegistryKey` as authoring ID.
- Stage 2: extend persistence beyond chunks (player/global/entity/block-entity state) using `ComponentMap` + deterministic ordering by position.
