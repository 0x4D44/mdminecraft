# Vanilla Parity Implementation Journal

**Date:** 2025-12-24  
**Plan:** `wrk_docs/2025.12.24 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  
**Comparison:** `wrk_docs/2025.12.24 - DOC - Feature Comparison vs Vanilla Minecraft.md`  
**Previous journal:** `wrk_journals/2025.12.23 - JRN - Vanilla Parity Implementation.md`  

---

## Slice: Preserve durability through dropped items (player drop/pickup)

### Goals

- Preserve durability for damaged tools/weapons when dropped into the world and picked back up.
- Keep determinism and serialization compatibility.

### Implementation notes

- Add `durability: Option<u32>` to `mdminecraft_world::DroppedItem` (serde default for backward-compatible loads).
- Add `ItemManager::spawn_item_with_durability(...)` and return durability from `ItemManager::pickup_items(...)`.
- Wire `GameWorld` to pass durability when dropping items and to restore durability when picking them up (including the “inventory full → respawn remainder” path).

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Burning pigs/cows drop cooked meat

### Goals

- Improve vanilla feel: pigs/cows killed while burning should drop cooked meat instead of raw.

### Implementation notes

- Mob loot now uses `GameWorld::mob_meat_drop_type(...)` so pig/cow drops switch to cooked variants when `fire_ticks > 0`.
- Added a focused unit test: `mob_meat_drop_type_cooks_when_burning`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Speed up `determinism_worldtest` debug defaults

### Goals

- Prevent the determinism worldtest from looking “hung” under `cargo test` on slower machines (the harness prints a warning after 60 seconds).

### Implementation notes

- Reduced `CHUNK_RADIUS_DEBUG` in `mdminecraft-world` `determinism_worldtest` to generate a single chunk by default (env overrides remain for heavier runs).

### Verification

- `cargo test -p mdminecraft-world --test determinism_worldtest -- --nocapture`
- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Zombies can drop iron ingots

### Goals

- Match a familiar vanilla-ish drop: zombies can rarely drop iron ingots (alongside carrot/potato).

### Implementation notes

- Zombie “rare drop” logic is now centralized in `GameWorld::zombie_rare_drop(...)` and expanded to include `IronIngot`.
- Added a focused unit test: `zombie_rare_drop_rolls_expected_items`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Persist dropped-item durability/enchantments

### Goals

- Ensure dropped-item metadata survives save/load cycles so durability/enchantments aren’t lost when exiting and reloading a world.

### Implementation notes

- Extended `mdminecraft-world` persistence coverage by updating `world_state_roundtrip_with_content_is_stable_over_cycles` to include a dropped bow with durability and enchantments.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Chickens lay eggs (deterministic)

### Goals

- Add a recognizable vanilla-ish passive behavior: chickens periodically lay eggs.

### Implementation notes

- Added `GameWorld::chicken_should_lay_egg(...)` to compute a deterministic per-chicken egg schedule (seeded by world seed + mob identity).
- `GameWorld::update_mobs` spawns `DroppedItemType::Egg` at the chicken’s position when the schedule triggers.
- Added a focused unit test: `chicken_egg_laying_is_periodic_and_deterministic`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Container break/spill drops preserve durability + enchantments

### Goals

- Ensure breaking a chest/hopper/dispenser/dropper doesn’t strip durability/enchantments from stored items when they spill into the world.

### Implementation notes

- `GameWorld::on_block_entity_removed` now routes core stacks through `GameWorld::spill_core_stack_to_world(...)`, which uses `ItemManager::spawn_item_with_metadata(...)`.
- Added a focused unit test: `spill_core_stack_to_world_preserves_metadata`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Skeleton bow drops carry durability + rare enchantments

### Goals

- Make mob equipment drops feel more vanilla-ish (dropped bows aren’t always pristine).
- Preserve determinism and reuse the dropped-item metadata pipeline end-to-end.

### Implementation notes

- Mob loot drop spawning now uses `ItemManager::spawn_item_with_metadata(...)` so loot drops can optionally carry durability/enchantments while preserving insertion order.
- Skeleton bow drops now use `GameWorld::mob_bow_drop_metadata(...)` to produce deterministic remaining durability and a small chance of compatible bow enchantments.
- Added a focused unit test: `mob_bow_drop_metadata_is_deterministic_and_valid`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Preserve durability through automation (hoppers/dispensers/droppers)

### Goals

- Preserve durability metadata when:
  - a dispenser/dropper emits an item into the world
  - a hopper pulls an item entity from the world

### Implementation notes

- `ItemManager::take_one_near{,_if}` now returns durability metadata for the removed unit.
- Hopper pickup path applies dropped-item durability to the inserted `CoreItemStack`.
- Dispenser/dropper drop path uses `spawn_item_with_durability(...)` and forwards durability from the source core stack.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Preserve enchantments through dropped items (drop/pickup + automation)

### Goals

- Preserve enchantments for dropped items so enchanted bows/tools don’t lose their enchants when:
  - dropped by the player
  - emitted by dispensers/droppers
  - picked up by the player or pulled by hoppers

### Implementation notes

- `mdminecraft_world::DroppedItem` now stores `enchantments` metadata (serde default for backward-compatible loads).
- Added `ItemManager::spawn_item_with_metadata(...)`; drop/pickup and automation paths now forward durability + enchantments together.
- Hopper pickup path applies dropped-item enchantments to the inserted `CoreItemStack`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Expand flammability coverage (fire/lava)

### Goals

- Treat common logs/leaves and wood-derivative blocks as flammable so lava ignition and fire spread/burning behave more vanilla-ish.

### Implementation notes

- Expanded `mdminecraft_world::is_flammable` to cover additional logs/leaves and common wood derivatives (doors, fences, slabs/stairs, chest/bed, etc.).
- Updated the `is_flammable` unit test to cover the new expectations.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
