# Code Coverage Improvement Plan

**Date:** 2025-12-13
**Project:** mdminecraft
**Current Coverage:** 65.07% (10,154 / 15,605 lines)
**Target Coverage:** 98%
**Lines to Cover:** ~5,139 additional lines

---

## Stage 1: Critical World Simulation Gaps (Target: 75%)

Focus on the lowest-coverage world modules that are fully testable without mocks.

### 1.1 Redstone System (world/src/redstone.rs)
- **Current:** 20.81% (82/394 lines)
- **Gap:** 312 lines
- **Tests to add:**
  - Power propagation through different block types
  - Repeater delay and state machines
  - Comparator signal strength calculations
  - Redstone torch inversion logic
  - Wire connection rules
  - Update order determinism

### 1.2 Fluid Simulation (world/src/fluid.rs)
- **Current:** 26.78% (98/366 lines)
- **Gap:** 268 lines
- **Tests to add:**
  - Water flow mechanics (horizontal spread, falling)
  - Lava flow (slower spread rate)
  - Source block creation (infinite water)
  - Fluid level calculations
  - Block displacement by fluids
  - Flow direction priority

### 1.3 Farming System (world/src/farming.rs)
- **Current:** 30.04% (82/273 lines)
- **Gap:** 191 lines
- **Tests to add:**
  - Crop growth stages for all crop types
  - Farmland hydration mechanics
  - Light level requirements
  - Growth tick probability
  - Bone meal acceleration
  - Crop harvesting yields

### 1.4 Mob AI (world/src/mob.rs)
- **Current:** 48.30% (256/530 lines)
- **Gap:** 274 lines
- **Tests to add:**
  - Pathfinding algorithms
  - Target selection logic
  - Attack damage calculations
  - Spawn conditions
  - Despawn distance checks
  - Mob-specific behaviors (creeper explosion, skeleton shooting)

### 1.5 Block Interaction (world/src/interaction.rs)
- **Current:** 44.42% (183/412 lines)
- **Gap:** 229 lines
- **Tests to add:**
  - Block placement validation
  - Block breaking mechanics
  - Container interactions (chest, furnace)
  - Door/trapdoor state toggling
  - Bed mechanics
  - Tool effectiveness

**Stage 1 Expected Coverage:** ~75% (+1,274 lines)

---

## Stage 2: Medium Priority Modules (Target: 85%)

### 2.1 Cave Generation (world/src/caves.rs)
- **Current:** 70.04% (491/701 lines)
- **Gap:** 210 lines
- **Tests to add:**
  - Cave carver algorithms
  - Ravine generation
  - Ore pocket placement
  - Cave decoration (stalactites, moss)
  - Aquifer integration

### 2.2 Potion Effects (world/src/potion.rs)
- **Current:** 77.06% (346/449 lines)
- **Gap:** 103 lines
- **Tests to add:**
  - Effect duration and amplifier
  - Stacking rules
  - Effect tick application
  - Splash/lingering mechanics
  - Beacon effect range

### 2.3 Projectiles (world/src/projectile.rs)
- **Current:** 70.21% (165/235 lines)
- **Gap:** 70 lines
- **Tests to add:**
  - Arrow trajectory physics
  - Fireball explosion
  - Ender pearl teleportation
  - Trident mechanics
  - Projectile-entity collision

### 2.4 Biome System (world/src/biome.rs)
- **Current:** 78.98% (278/352 lines)
- **Gap:** 74 lines
- **Tests to add:**
  - Biome blending
  - Temperature/humidity mapping
  - Biome-specific features
  - Structure placement rules

### 2.5 Network Transport (net/src/transport.rs)
- **Current:** 72.73% (184/253 lines)
- **Gap:** 69 lines
- **Tests to add:**
  - Connection establishment
  - Packet fragmentation
  - Reliability layer
  - Bandwidth throttling

### 2.6 Geode Generation (world/src/geode.rs)
- **Current:** 60.98% (100/164 lines)
- **Gap:** 64 lines
- **Tests to add:**
  - Geode shell generation
  - Crystal placement
  - Budding amethyst mechanics

### 2.7 Inventory Management (world/src/inventory.rs)
- **Current:** 76.25% (183/240 lines)
- **Gap:** 57 lines
- **Tests to add:**
  - Stack merging logic
  - Slot swapping
  - Armor slot validation
  - Creative mode inventory

### 2.8 Furnace Processing (world/src/furnace.rs)
- **Current:** 77.60% (142/183 lines)
- **Gap:** 41 lines
- **Tests to add:**
  - Fuel consumption rates
  - Smelting recipes
  - XP accumulation
  - Hopper interaction

**Stage 2 Expected Coverage:** ~85% (+688 lines)

---

## Stage 3: Infrastructure and Final Push (Target: 98%)

### 3.1 UI3D Components
- **Current:** 63.61% (465/731 lines)
- **Gap:** 266 lines
- **Tests to add:**
  - Billboard rendering calculations
  - Text layout algorithms
  - Font atlas lookups
  - UI element positioning

### 3.2 Assets Registry
- **Current:** 76.27% (360/472 lines)
- **Gap:** 112 lines
- **Tests to add:**
  - Block registry lookups
  - Texture coordinate calculations
  - Missing asset fallbacks

### 3.3 Physics (AABB Collision)
- **Current:** 0% (0/12 lines)
- **Gap:** 12 lines
- **Tests to add:**
  - AABB intersection
  - Collision response
  - Sweep tests

### 3.4 ECS Wrapper
- **Current:** 0% (0/13 lines)
- **Gap:** 13 lines
- **Tests to add:**
  - System scheduling
  - Component queries
  - Deterministic iteration

### 3.5 Render Logic (Non-GPU)
- **Current:** 2.65% (62/2342 lines)
- **Testable portion:** ~500 lines
- **Tests to add:**
  - Mesh generation algorithms
  - Frustum culling math
  - LOD calculations
  - Texture coordinate mapping

### 3.6 Network Edge Cases
- **Replay:** 75.56% gap of 64 lines
- **Connection:** gap of 52 lines
- **Tests to add:**
  - Replay recording/playback
  - Connection state machine
  - Timeout handling
  - Packet ordering

**Stage 3 Expected Coverage:** ~98% (+3,177 lines)

---

## Implementation Strategy

### Test Infrastructure

1. **Chunk Test Helpers** - Create reusable test chunks with known block configurations
2. **Mock RNG** - Seeded RNG for deterministic test scenarios
3. **Time Simulation** - Fast-forward tick simulation for growth/decay tests
4. **Snapshot Testing** - Compare world state before/after operations

### Test Categories

1. **Unit Tests** - Individual function behavior
2. **Integration Tests** - Multi-system interactions
3. **Property Tests** - Invariant fuzzing with proptest
4. **Determinism Tests** - Same seed = same output

### Priority Order

1. Start with highest-gap modules (redstone, fluid)
2. Focus on deterministic, pure functions first
3. Add integration tests for complex interactions
4. Use property testing for edge case discovery

---

## Progress Tracking

| Stage | Target | Lines | Status |
|-------|--------|-------|--------|
| 1 | 75% | +1,274 | Pending |
| 2 | 85% | +688 | Pending |
| 3 | 98% | +3,177 | Pending |

---

## Files to Create/Modify

### Stage 1
- `crates/world/src/redstone.rs` - Add `#[cfg(test)] mod tests`
- `crates/world/src/fluid.rs` - Add `#[cfg(test)] mod tests`
- `crates/world/src/farming.rs` - Expand existing tests
- `crates/world/src/mob.rs` - Add comprehensive tests
- `crates/world/src/interaction.rs` - Add interaction tests

### Stage 2
- `crates/world/src/caves.rs` - Add cave generation tests
- `crates/world/src/potion.rs` - Add effect tests
- `crates/world/src/projectile.rs` - Add physics tests
- `crates/net/src/transport.rs` - Add network tests

### Stage 3
- `crates/ui3d/src/` - Add component tests
- `crates/assets/src/` - Add registry tests
- `crates/physics/src/lib.rs` - Add collision tests
- `crates/render/src/mesh.rs` - Add mesh generation tests
