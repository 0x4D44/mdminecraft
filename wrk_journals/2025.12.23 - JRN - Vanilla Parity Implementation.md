# Vanilla Parity Implementation Journal

**Date:** 2025-12-23  
**Repo:** `/home/md/language/mdminecraft`  
**Plan:** `wrk_docs/2025.12.23 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  
**Previous journal:** `wrk_journals/2025.12.21 - JRN - Vanilla Parity Implementation.md`  

---

## 2025-12-23

### Stage 4 hardening — Waterlogged water volumes

- Rendering: the chunk mesher emits water volumes for waterlogged blocks (shape-aware for slabs/stairs/trapdoors; fallback full-cube water for other supported blocks).
- Tests: added a render regression test that asserts a waterlogged slab produces the expected number of water faces.

### Stage 4 hardening — Alpha-blended fluid pass

- Rendering: voxel drawing now runs in two passes:
  - opaque pass discards fluid fragments
  - alpha-blended fluid pass (water/lava) loads the opaque depth buffer so fluids blend correctly without hiding underlying block geometry (notably for waterlogged non-cube blocks).
- Stability: translucent-fluid chunks are drawn back-to-front with deterministic tie-breaking to reduce blending flicker.

### Stage 4 hardening — Texture alpha cutouts

- Rendering: the opaque pass now alpha-tests atlas textures and discards fragments with `alpha < 0.5`, enabling cutout-style transparency for textures like glass/leaves without requiring a separate translucent block pass.

### Stage 4 hardening — Flowing fluid surface heights

- Rendering: fluid blocks are now meshed with a per-block fluid height derived from the encoded fluid level, instead of rendering as full cubes.
- Rendering: greedy meshing no longer generates faces for fluids, which prevents internal faces between e.g. water vs flowing-water IDs; fluid faces are emitted by a dedicated meshing pass that treats all water IDs as the same fluid.
- Rendering: fluid top surfaces now use **per-corner heights** (vanilla-ish sloped surface) so adjacent same-type fluids connect smoothly without vertical “step” faces.
- Performance: base heights are cached per-chunk (including a 1-block x/z border) to avoid repeated `voxel_at_world` sampling during meshing.
- Tests: added render regression tests for (1) flowing water emitting a partial-height top face, (2) adjacent same-height flowing water emitting no internal side faces, and (3) a flowing block sloping toward a neighboring source.

### Stage 4 hardening — Flow-direction fluid animation

- Rendering: fluids now encode a coarse flow direction in a spare byte in the voxel vertex format; the voxel shader uses it to orient the procedural wave animation along the flow direction (water/lava), improving “flowing” readability without a new vertex attribute.

### Stage 4 hardening — Translucent ice rendering

- Rendering: `ice` is now rendered in the alpha-blended pass (same pass as fluids), so its texture alpha is respected (visual translucency) rather than being forced opaque by the cutout/opaque pipeline.
- Meshing: `ice` is treated as non-opaque for greedy face culling so adjacent opaque block faces are still emitted (you can see blocks “behind” ice); added a small render regression test.

### Stage 4 hardening — Translucent glass rendering

- Rendering: `glass` and `glass_pane` now render in the alpha-blended pass (same pass as fluids/ice), so they behave like true translucent blocks instead of cutout-only textures.
- Rendering: shader uses the atlas alpha as an edge mask but enforces a base translucency (center remains visible and tinted), improving vanilla-like readability without swapping textures.

### Stage 4 hardening — Split opaque vs alpha index buffers

- Performance: chunk meshes now keep **separate index buffers** for opaque+cutout vs alpha-blended geometry, so chunks with water/glass no longer re-draw the entire index buffer twice each frame.
- Rendering: the alpha-blended pass now draws only the alpha index buffer while reusing the shared vertex buffer, preserving depth-tested translucency while reducing wasted work.
- Tests: added small render regression tests to ensure fluids and glass emit **alpha indices only** (prevents “invisible glass/water” regressions if the render-layer classification changes).

### Stage 4 hardening — Data-driven translucency + alpha-flagged vertices

- Rendering: translucency is now data-driven via the `mdm:render/translucent` block tag (configured in `config/blocks.json` for `ice`, `glass`, `glass_pane`, `nether_portal`, `end_portal`).
- Rendering: the voxel vertex format reserves the top bit of the `extra` byte to mark **alpha-pass membership**; shaders use this bit to discard fragments in the wrong pass, avoiding hard-coded block-id lists.
- Rendering: fluid flow direction continues to use the low 7 bits of `extra` (the alpha flag is masked out in the shader).

### Stage 4 hardening — End portal surface rendering

- Rendering: `end_portal` is now meshed as a **flat surface** at `12/16` block height (vanilla-ish), rendered in the alpha-blended pass instead of as a full cube.
- Tests: added a regression test verifying end portal surfaces emit alpha indices and the expected surface height.

### Stage 4 hardening — Nether portal plane rendering

- Rendering: `nether_portal` is now meshed as a thin vertical plane (2/16 thickness) oriented by the portal axis bit in voxel state (from activation logic), rendered in the alpha-blended pass instead of as a full cube.
- Rendering: portals get simple procedural shader effects (nether portal swirl + end portal starfield-ish).
- Tests: added regression coverage for portal plane orientation across chunk seams (state-driven).

### Stage 4 hardening — Texture atlas mipmaps

- Rendering: runtime atlas upload now generates a mip chain (nearest filtered), reducing distant texture shimmer and matching vanilla-ish mip behavior.
- Rendering: atlas loading now “bleeds” each tile’s edge pixels into its padding region before mip generation, avoiding black halos from empty padding.
- Rendering: mip generation is alpha-aware (RGB weighted by alpha; alpha uses max coverage) so cutout textures retain coverage more reliably in distant mips.
- Tooling: `atlas_packer` now extrudes tile edges into padding when building `atlas.png`, keeping authored atlases mip-safe (runtime still bleeds for backwards compatibility).

### Stage 4 hardening — Biome tinting (grass + foliage)

- Rendering: chunk uniforms now include biome-derived **grass** + **foliage** tint colors (sampled at chunk center via the deterministic `BiomeAssigner`).
- Rendering: blocks can opt into tinting via data tags:
  - `mdm:render/tint/grass` (applies to `grass` top faces only)
  - `mdm:render/tint/foliage` (applies to leaf blocks)
- Rendering: tint intent is encoded per-vertex (packed into the `extra` byte), avoiding hard-coded block-id checks in the shader.
- Tests: added a regression test verifying tint extra bits are emitted for tagged blocks.

### Stage 4 hardening — Biome tinting (water)

- Rendering: chunk uniforms now include a biome-derived **water** tint color (sampled at chunk center via the deterministic `BiomeAssigner`), and the water shader uses it to tint fluid surfaces (vanilla-ish).
- World: `BiomeData` now defines per-biome `water_color` and blends it in `get_blended_biome` alongside grass/foliage colors.

### Visual parity — Dimension sky + environment fog

- Rendering: the time uniform now encodes the active dimension ID; the skybox shader uses it to switch to Nether/End sky approximations (no sun/moon/overworld clouds).
- Rendering: fog parameters are now environment-aware:
  - Nether/End use dimension-colored fog with shorter fog distances (vanilla-ish “thick” atmosphere).
  - Underwater uses biome-derived water tint fog with short visibility; precipitation is suppressed.

### Rendering fidelity — Ambient occlusion (AO)

- Rendering: greedy-meshed cube faces now compute a Minecraft-like per-vertex AO factor (based on opaque neighbor occupancy around each vertex) and apply it in the voxel shader.
- Rendering: AO is packed into the existing vertex format (high 4 bits of the `light` byte), preserving vertex layout and keeping the feature deterministic.

### Rendering fidelity — Smooth lighting (per-vertex light)

- Rendering: greedy-meshed cube faces now also compute per-vertex light values (averaging neighbor light samples on the face-adjacent layer) so lighting gradients interpolate across quads (vanilla-ish “smooth lighting”).
- Rendering: per-vertex light continues to use the existing vertex format (low 4 bits of the `light` byte), avoiding any new vertex attributes.

### Rendering fidelity — Grass side tint overlay

- Rendering: `grass` side faces now apply biome tint only to the top “grass” band (top 4px of the tile), approximating vanilla’s grass-side overlay behavior without tinting the dirt portion.
- Rendering: added a small atlas-params uniform so the shader can compute in-tile UVs even with packed atlases/padding.

### Visual parity — Dimension-aware voxel lighting

- Rendering: voxel shading now treats Nether/End as having no sun-driven lighting (constant low ambient), so block lighting carries the scene (more vanilla-ish).

### Rendering fidelity — Leaf tint variants (birch/spruce)

- Rendering: birch + spruce leaves now use fixed foliage tints (vanilla-ish) rather than biome foliage tint.

### Visual parity — Biome-tinted Overworld sky

- World: `BiomeData` now includes `sky_color` / `fog_color` / `water_fog_color` (vanilla-ish hooks; currently fog colors are constant and water fog follows water color).
- Rendering: added `TimeUniform.sky_color`; the skybox shader tints the daytime zenith toward this value, enabling per-biome sky hue variation without affecting simulation determinism.

### Verification

- `cargo fmt --all` (ok)
- `cargo clippy --workspace --all-targets -- -D warnings` (ok)
- `cargo test -p mdminecraft-render` (ok)
- `cargo test --workspace` (ok)
- `cargo test -p mdminecraft-world --test determinism_worldtest` (ok)
