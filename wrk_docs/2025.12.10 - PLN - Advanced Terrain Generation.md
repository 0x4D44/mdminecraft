# Implementation Plan: Advanced Terrain Generation (3D Density)
**Date:** 2025-12-10
**Goal:** Fix floating blocks and "missing block" voids by implementing a modern 3D density-based terrain generator (similar to Minecraft 1.18+).

## Phase 1: 3D Density Function
**Objective:** Unify surface and cave generation into a single density field.

### 1.1 Density Module
**Target:** `crates/world/src/terrain.rs`
**Plan:**
1.  Implement `compute_density(x, y, z)`:
    *   **Base Height:** Calculate approximate surface height `h(x, z)` using 2D noise.
    *   **Vertical Gradient:** Start with `density = h(x, z) - y`. (Positive below ground, negative above).
    *   **3D Noise:** Add `Simplex(x, y, z) * factor`. This creates overhangs and variations.
    *   **Cave Noise:** Subtract `Cheese/Spaghetti` noise values directly from density.
2.  **Threshold:** If `density > 0`, block is solid.

### 1.2 Chunk Generation Update
**Target:** `TerrainGenerator::generate_chunk`
**Plan:**
1.  Replace the "2D Heightmap -> Fill Column -> Carve" pipeline.
2.  New Loop:
    *   Iterate `x, z`.
    *   Iterate `y` from `BOTTOM` to `TOP`.
    *   Sample `d = compute_density(x, y, z)`.
    *   If `d > 0`, set block (Stone/Dirt based on depth).
    *   Use `Biome` to determine topsoil (Grass/Sand) by checking `density(x, y+1, z) <= 0` (surface check).

## Phase 2: Cleanup and Optimization
**Objective:** Ensure performance and quality.

### 2.1 Optimization
*   **Noise Caching:** Reuse noise samplers.
*   **Early Exit:** If `y` is far above base height + max noise variance, skip (it's air).

### 2.2 Surface Decoration
*   **Tree/Vegetation:** Needs "Surface Finding". Scan down from top or use the density surface check to place trees.

## Benefits
*   **No Floating Blocks:** Gravity-defying terrain is now continuous (arches) rather than disconnected artifacts.
*   **No Holes:** Density functions don't "miss" spots unless mathematically designed to.
*   **Modern Look:** Supports overhangs, cliffs, and huge caves naturally.
