# Code Coverage Review (2026-01-01)

## Scope & Tooling
- **Tool:** cargo-llvm-cov 0.6.20
- **Command:**
  ```bash
  cargo llvm-cov --workspace --json --output-path target/coverage/coverage.json -- \
    --skip large_scale_terrain_worldtest \
    --skip stage4_metrics_worldtest \
    --skip headless_step_mode_no_render_smoke
  ```
- **Skipped tests (with reasons):**
  - `large_scale_terrain_worldtest` (fails on perf threshold on this machine)
  - `stage4_metrics_worldtest` (long-running in coverage run)
  - `headless_step_mode_no_render_smoke` (process timeout under coverage)

## Coverage Summary (current)
- **Line coverage:** **64.12%** (45,700 / 71,271)
- **Function coverage:** **73.05%** (3,164 / 4,331)
- **Region coverage:** **65.07%** (68,491 / 105,261)
- **Lines needed for 98%:** **+24,146** lines (target 69,846 covered)

## Coverage by Area (lines)
| Area | Lines | Covered | Coverage |
| --- | ---:| ---:| ---:|
| `crates/client` | 224 | 12 | 5.36% |
| `crates/server` | 115 | 20 | 17.39% |
| `crates/ui3d` | 730 | 248 | 33.97% |
| `crates/cli` | 1095 | 483 | 44.11% |
| `src` | 35452 | 16935 | 47.77% |
| `crates/render` | 6800 | 3325 | 48.90% |
| `crates/audio` | 348 | 172 | 49.43% |
| `crates/testkit` | 264 | 219 | 82.95% |
| `crates/net` | 2939 | 2523 | 85.85% |
| `crates/core` | 752 | 677 | 90.03% |
| `crates/assets` | 730 | 668 | 91.51% |
| `crates/world` | 21762 | 20359 | 93.55% |
| `crates/ecs` | 26 | 25 | 96.15% |
| `crates/scripting` | 7 | 7 | 100.00% |
| `crates/physics` | 27 | 27 | 100.00% |

## Largest Coverage Gaps (by uncovered lines)
| File | Lines | Covered | Coverage | Gap |
| --- | ---:| ---:| ---:| ---:|
| `src/game.rs` | 28843 | 13024 | 45.15% | 15819 |
| `crates/render/src/pipeline.rs` | 1369 | 29 | 2.12% | 1340 |
| `crates/render/src/mesh.rs` | 4004 | 2864 | 71.53% | 1140 |
| `src/menu.rs` | 719 | 0 | 0.00% | 719 |
| `src/commands.rs` | 2209 | 1769 | 80.08% | 440 |
| `src/automation/server.rs` | 481 | 162 | 33.68% | 319 |
| `src/main.rs` | 454 | 161 | 35.46% | 293 |
| `crates/world/src/mob.rs` | 1632 | 1342 | 82.23% | 290 |
| `crates/cli/src/bin/debug-world.rs` | 430 | 147 | 34.19% | 283 |
| `crates/ui3d/src/render/text_renderer.rs` | 246 | 0 | 0.00% | 246 |
| `src/commentary.rs` | 373 | 135 | 36.19% | 238 |
| `crates/cli/src/bin/metrics-diff.rs` | 439 | 219 | 49.89% | 220 |

## Zero-Coverage Files (largest first)
| File | Lines |
| --- | ---:|
| `src/menu.rs` | 719 |
| `crates/ui3d/src/render/text_renderer.rs` | 246 |
| `crates/client/src/multiplayer.rs` | 212 |
| `crates/render/src/texture_atlas.rs` | 127 |
| `crates/server/src/multiplayer.rs` | 92 |
| `crates/render/src/screenshot.rs` | 91 |

## Notes & Observations
- **Coverage is concentrated** in `crates/world`, `crates/net`, and `crates/assets` (85–94%+), but **`src/game.rs` and render/UI code dominate the uncovered lines**.
- **Render/UI + menu account for several thousand uncovered lines**; without targeted testability refactors, 98% is unrealistic.
- **CLI/tools** are now partially covered; remaining gaps in CLI bins are relatively small compared to render/UI and core game loop.
- **Client/server multiplayer modules** are still near 0% and will require deterministic transport harnessing.
- The skipped tests above should be revisited for CI-grade coverage runs (or explicitly excluded for coverage-only runs).

## Recent Improvements (this pass)
- Added focused unit tests for:
  - `crates/scripting`, `crates/physics`, `crates/ecs`, `crates/net`
  - `crates/server`, `crates/client`
  - `src/scripted_input.rs`, `src/commentary.rs`
  - `crates/cli/src/main.rs` + CLI bin refactors
  - `tools/atlas_packer`, `tools/ecs_compare`
- Line coverage moved **62.97% → 64.12%** (+1.15%).
