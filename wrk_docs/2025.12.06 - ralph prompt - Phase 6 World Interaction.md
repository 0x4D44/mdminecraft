# Ralph Wiggum Prompt: Phase 6 - World Interaction & Building

## Overview

Phase 6 focuses on expanding world interaction mechanics to make building and exploration more engaging. This includes fluid physics, new block types, redstone-like mechanisms, farming, and quality-of-life features like beds.

---

## TASK: Implement Phase 6 - World Interaction & Building

You are continuing development of **mdminecraft**, a deterministic voxel sandbox engine written in Rust. Phases 0-5 are complete. Your task is to implement Phase 6 features.

### JOURNAL REQUIREMENT

**Maintain a journal while you work.** Update `wrk_journals/YYYY.MM.DD - JRN - Phase 6 World Interaction.md`

- Log what you're working on, decisions made, problems encountered
- Update at least every major milestone
- Include timestamps for entries

### COMPLETION CRITERIA (ALL must be true to finish)

1. `cargo build` compiles with zero errors and zero warnings
2. `cargo clippy --all-targets --all-features` passes with zero warnings
3. `cargo fmt --all -- --check` passes (no formatting issues)
4. `cargo test --all` passes ALL tests
5. All Phase 6 features are implemented and functional (see checklist below)
6. New features have unit tests where applicable

### REFERENCE FILES

- `CLAUDE.md` - Build commands and architecture overview
- `wrk_docs/2025.11.19 - PLN - Near Minecraft Experience.md` - Original phase plan
- `crates/world/src/` - World simulation code
- `crates/render/src/` - Rendering code
- `src/game.rs` - Main game state and input handling

---

## PHASE 6 FEATURE CHECKLIST

### 6.1 Fluid Physics (Priority: HIGH)

Implement water and lava flow mechanics:

**Water:**
- [ ] Water source blocks that spread horizontally (up to 7 blocks)
- [ ] Water flows downward infinitely when possible
- [ ] Water level decreases with distance from source (7 levels)
- [ ] Two adjacent water sources create infinite water source
- [ ] Water breaks certain blocks (torches, flowers, etc.)
- [ ] Swimming physics (slower movement, oxygen meter optional)
- [ ] Water rendering with transparency and animation

**Lava:**
- [ ] Lava source blocks that spread (slower than water, 3 blocks)
- [ ] Lava flows downward
- [ ] Lava sets flammable blocks on fire
- [ ] Lava + water = cobblestone or obsidian (depending on source)
- [ ] Lava deals damage to player/mobs
- [ ] Lava emits light (level 15)
- [ ] Lava rendering with emissive effect

**Implementation Notes:**
- Add `FluidType` enum (Water, Lava)
- Add fluid level to `Voxel` or separate fluid storage
- Create `FluidSimulator` that runs each tick
- Use cellular automata approach for flow
- Ensure determinism (same seed = same flow)

### 6.2 New Block Types (Priority: HIGH)

Add these interactive/structural blocks:

**Doors:**
- [ ] Wooden door (craftable from planks)
- [ ] Iron door (craftable from iron ingots)
- [ ] Door has open/closed state
- [ ] Right-click to toggle
- [ ] Door occupies 2 vertical blocks
- [ ] Collision changes based on state

**Ladders:**
- [ ] Craftable from sticks
- [ ] Place on wall faces
- [ ] Player can climb (hold forward while on ladder)
- [ ] No fall damage while on ladder

**Fences:**
- [ ] Wooden fence (craftable)
- [ ] 1.5 block height for collision (can't jump over)
- [ ] Connects to adjacent fences
- [ ] Fence gates (openable)

**Slabs:**
- [ ] Stone slab, wooden slab
- [ ] Half-height blocks
- [ ] Can place on top or bottom of block space
- [ ] Two slabs in same space = full block

**Stairs:**
- [ ] Stone stairs, wooden stairs
- [ ] Auto-orient based on placement direction
- [ ] Proper collision shape

**Glass:**
- [ ] Transparent block
- [ ] Doesn't drop when broken (unless silk touch - optional)
- [ ] Glass panes (thin, connect to neighbors)

**Implementation Notes:**
- Extend `BlockId` enum with new types
- Add `BlockState` flags for orientation, open/closed
- Update mesh generation for non-cube shapes
- Update collision detection for partial blocks

### 6.3 Redstone Basics (Priority: MEDIUM)

Simple redstone-like mechanics:

**Components:**
- [ ] Lever - toggles on/off, provides power
- [ ] Button - momentary power (20 ticks)
- [ ] Pressure plate - powered when entity stands on it
- [ ] Redstone torch - inverts signal, provides light
- [ ] Redstone wire - transmits power (15 block range with decay)

**Powered Blocks:**
- [ ] Doors can be opened by redstone
- [ ] Lamps turn on when powered
- [ ] Pistons push blocks (optional, complex)

**Implementation Notes:**
- Add `power_level: u8` to blocks (0-15)
- Create `RedstoneSimulator` for power propagation
- Run redstone updates after block changes
- Ensure deterministic update order

### 6.4 Farming System (Priority: MEDIUM)

Basic agriculture:

**Mechanics:**
- [ ] Hoe tool tills dirt/grass into farmland
- [ ] Farmland block (slightly lower than full block)
- [ ] Farmland near water stays hydrated (darker texture)
- [ ] Dry farmland reverts to dirt over time
- [ ] Seeds (wheat, carrot, potato)
- [ ] Crops grow through stages (4-8 stages)
- [ ] Growth rate affected by light level and hydration
- [ ] Harvest by breaking (drops item + seeds)
- [ ] Bone meal accelerates growth (optional)

**Crops to Implement:**
- [ ] Wheat (seeds from grass, makes bread)
- [ ] Carrots (drop carrots, replant carrot)
- [ ] Potatoes (drop potatoes, replant potato)

**Implementation Notes:**
- Add crop growth stage to `BlockState`
- Create `CropGrowthSystem` that ticks crops
- Add farmland hydration check (4 block radius from water)
- Update existing `FoodType` enum for new foods

### 6.5 Beds & Spawn Points (Priority: MEDIUM)

Sleep and spawn mechanics:

**Bed Features:**
- [ ] Craftable from wool + planks
- [ ] Occupies 2 horizontal blocks
- [ ] Right-click to sleep (only at night)
- [ ] Sleeping sets spawn point
- [ ] Sleeping skips to dawn (in singleplayer)
- [ ] Can't sleep if monsters nearby
- [ ] Bed explosion in wrong dimension (optional/funny)

**Implementation Notes:**
- Add `BedBlock` with head/foot parts and orientation
- Store player spawn point in save data
- Add sleep animation/screen fade
- Check for hostile mobs in radius before allowing sleep

### 6.6 Block Interactions Polish (Priority: LOW)

Quality of life improvements:

- [ ] Chests (27 slot storage, GUI)
- [ ] Signs (place text in world)
- [ ] Trapdoors (horizontal doors)
- [ ] Torches on walls (not just floor)
- [ ] Item frames (display items)

---

## IMPLEMENTATION ORDER (Suggested)

1. **Fluid foundation** - Water/lava block types, basic spreading
2. **Fluid rendering** - Transparency, animated textures
3. **Doors & ladders** - Most impactful new blocks
4. **Farming basics** - Hoe, farmland, wheat
5. **Beds** - Spawn points, day skip
6. **Slabs & stairs** - Partial blocks
7. **Redstone basics** - Levers, buttons, lamps
8. **Polish** - Fences, glass, remaining items

---

## TECHNICAL REQUIREMENTS

### Determinism
All new systems MUST be deterministic:
- Fluid flow must produce identical results given same initial state
- Crop growth must use seeded RNG
- Redstone updates must have consistent ordering

### Performance
- Fluid updates should be batched and spread across ticks
- Only simulate fluids in loaded chunks
- Use dirty flags to avoid unnecessary updates

### Testing
Add tests for:
- Fluid spreading patterns
- Block state serialization
- Crop growth progression
- Redstone signal propagation

### Code Style
- Follow existing patterns in codebase
- Doc comments for public APIs
- No `unwrap()` in production paths
- Use `anyhow` with `.context()` for errors

---

## BLOCK REGISTRY ADDITIONS

Add to `config/blocks.json` or equivalent:

```
water, lava, farmland, wheat_crop_0-7,
oak_door_lower, oak_door_upper, iron_door_lower, iron_door_upper,
ladder, oak_fence, oak_fence_gate,
stone_slab_bottom, stone_slab_top, oak_slab_bottom, oak_slab_top,
stone_stairs, oak_stairs,
glass, glass_pane,
lever, stone_button, oak_button, stone_pressure_plate, oak_pressure_plate,
redstone_wire, redstone_torch, redstone_lamp,
bed_head, bed_foot,
chest
```

---

## SUCCESS METRICS

When complete, the game should:
- Have flowing water and lava with proper physics
- Support building with doors, ladders, fences, slabs, stairs
- Allow basic farming with plantable crops
- Let players set spawn with beds
- Have working levers/buttons/pressure plates
- Pass all tests with zero warnings
- Maintain 60 FPS with fluid simulation active

---

## KNOWN CHALLENGES

1. **Fluid mesh generation** - Water/lava need special handling for transparency and levels
2. **Partial block collision** - Slabs, stairs need non-AABB collision or compound AABBs
3. **Door two-block sync** - Opening door must update both blocks atomically
4. **Redstone ordering** - Updates must be deterministic, consider BFS from power sources
5. **Crop random ticks** - Need deterministic "random tick" system for growth

---

## COMMITS

Commit frequently with format:
- `[Feature] Add water/lava fluid types and basic spreading`
- `[Feature] Implement door blocks with open/close interaction`
- `[Fix] Correct fluid level rendering at block edges`
- `[Test] Add fluid spreading determinism tests`
