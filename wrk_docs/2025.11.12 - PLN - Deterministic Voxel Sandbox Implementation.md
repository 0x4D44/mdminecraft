# Multistage Implementation Plan — Deterministic Voxel Sandbox MVP
Date: 2025-11-12

## Stage 0 – Foundations & Tooling (Week 0-1)
- Objectives: lock repo scaffolding, CI skeleton, shared crates, coding standards.
- Major Activities: initialize Cargo workspace + crates per HLD; add tracing/metrics scaffolding; configure rustfmt/clippy gates; bootstrap testkit sinks with placeholders; set up CI matrix skeleton and artifact retention.
- Dependencies: finalized HLD, toolchain availability.
- Deliverables: compiling workspace with placeholder crates, lint/test jobs green, CI artifact buckets, engineering handbook for deterministic coding rules.
- Entry Criteria: leadership sign-off on HLD; staffing assigned for core subsystems.
- Exit Criteria: CI green on stubbed workspace, devs can run `cargo test` and baseline `worldtest` placeholder locally.

### Timeline Guardrails
- Stages run sequentially; a stage may start only after the prior stage’s exit report is signed off. Week ranges now include schedule buffer for spillover (e.g., Stage 2 begins no earlier than Week 7 even if Stage 1 finishes ahead of plan).
- Cross-functional spikes (docs, QA, art) may overlap, but engineering feature work stays gated to keep deterministic dependencies stable.

## Stage 1 - Engine Core & World Primitives (Weeks 1-6)
- Objectives: world data model, chunk pipeline, mesher, renderer, basic player movement.
- Major Activities: implement core math/time crates + SimTick; build chunk storage with SoA layout, LRU caches, dirty flags; author greedy mesher + mesh hashing; integrate wgpu renderer (DX12/Vulkan/Metal) in forward mode; implement physics capsule collisions and camera controls; wire event bus + JSONL sink; create Superflat worldtest scenario.
- Dependencies: Stage 0 completed; asset schema draft.
- Deliverables: interactive superflat world, place/break loop, headless render snapshots with hashes, Superflat worldtest passing, metrics for frame/tick time.
- Entry Criteria: CI scaffold, design-approved chunk/mesher specs, QA scenario definitions.
- Exit Criteria: 60 FPS in 9×9 chunk area on reference hardware, Superflat test stable (events + snapshot), no warnings in event log.

## Stage 2 - Lighting, Environmental Systems, Persistence (Weeks 7-12)
- Objectives: skylight/block light propagation, day/night + weather, zstd region saves, inventories/crafting basics.
- Major Activities: implement dual-channel BFS lighting with border queues; hook SimTime + weather toggles into lighting scalar and event stream; add LightUpdate instrumentation + AO toggle; build region IO (.rg) with async flush, CRC, versioning; implement inventory, recipe loader, crafting stations; persist player state.
- Dependencies: Stage 1 chunk+mesher complete; SimTime spec finalized; block registry data packs available.
- Deliverables: Torch worldtest + day/night/weather regression suite wired into CI as a blocking job, save/load parity tests with automated diffing, inventory UI, light probe unit tests, metrics.json entries capturing lighting latency deltas.
- Entry Criteria: Stage 1 exit, data pack schema defined.
- Exit Criteria: Torch worldtest passes (light removal <=2 ticks), save/reload bit-identical, weather & time-of-day reproducible via replay logs.

## Stage 3 - Networking & Multiplayer Surfaces (Weeks 13-18)
- Objectives: server authoritative netcode, client prediction/reconciliation, chunk streaming, deterministic replay plumbing.
- Major Activities: implement QUIC transport (quinn) with channels; define postcard schema with version+hash; integrate client prediction schedule + rewind; build chunk delta compression (palette+RLE) and streaming; implement entity delta replication; extend replay harness to capture input logs and net events; author 100 ms RTT LAN scenario in worldtest.
- Dependencies: Stage 2 world/lighting stable; net protocol RFC approved.
- Deliverables: two-player LAN demo building shared tower, rubber-band stats, replay logs regenerating authoritative event stream, networking dashboards covering bandwidth, CPU cost, packet loss, and reconciliation error budgets.
- Entry Criteria: Stage 2 exit, infra for hosting dedicated server build.
- Exit Criteria: <=30 ms avg reconciliation error at 100 ms RTT, peak bandwidth per client <= specified cap (TBD, tracked in metrics.json), event streams match server authoritative record, deterministic replay diff clean with zero schema drift warnings.

## Stage 4 - Biomes, Structures, Environmental Content (Weeks 19-24)
- Objectives: biome noise stack, structures, weather toggle UI, passive mobs/drop items with deterministic AI/behavior.
- Major Activities: implement chunk generation pipeline (heightmap, biomes, structures, population passes); integrate passive mob FSM seeded by SpawnSeed; add drop item lifecycle + events; create weather control hooks and UI indicators; lock render goldens per backend; expand worldtests (BiomeSeams, PassiveMobWander).
- Dependencies: Stage 3 networking stable; content team provides biome definitions.
- Deliverables: diverse terrain without seams, passive mobs wandering deterministically, drop/pickup events, weather toggle UI tied to replayable `WeatherChanged` events, updated snapshot hashes per backend, MegaForest/CaveCity performance captures.
- Entry Criteria: Stage 3 exit, biome/structure specs ready.
- Exit Criteria: no biome seams in test scenes, mesh hashes stable after rebuild, mobs/drop items and weather toggles reproducible via replay and worldtests, perf baselines within targets.

## Stage 5 - Hardening, CI Automation, Release Prep (Weeks 25-28)
- Objectives: finalize automated testing matrix, fuzz/property suites, metrics dashboards, documentation.
- Major Activities: expand proptest suites (lighting, collisions, chunk seams); run cargo-fuzz on input decoder/chunk deserializer/recipe parser; finalize headless snapshot goldens for all backends; integrate metrics.json diffing in CI; write operations runbook (SimTime/weather controls, replay debugging); conduct performance regression sweeps on reference hardware; prepare release candidate builds.
- Dependencies: All prior stages feature-complete, test suite infrastructure ready.
- Deliverables: green CI matrix with artifacts (events.jsonl, metrics.json, snapshots), reproducibility checklists, operator guide, release candidate builds with semver + reg_hash.
- Entry Criteria: Stage 4 exit, QA sign-off on content completeness.
- Exit Criteria: CI consistently green for a week, fuzz/property suites passing, documentation approved, reference hardware perf metrics at/under targets, go/no-go review complete with signed release checklist.

## Cross-Cutting Workstreams
- Observability & Metrics: tracing spans + metrics counters added as systems land; dashboards updated each stage.
- Security & Stability: validate asset packs, net inputs, and save files continuously; track outstanding risks in Jira with mitigation owners.
- Documentation & Training: maintain HLD/PLN deltas, subsystem READMEs, and runbooks after each stage exit.

## Staffing & Governance
- Core squads aligned to major crates (world/render/physics/net/testkit). Stage leads own demos + exit reports. Weekly checkpoint reviews evaluate metrics (tick time, fps, replay diffs) vs targets and approve progression to next stage.


