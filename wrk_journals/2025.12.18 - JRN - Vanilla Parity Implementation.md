# Vanilla Parity Implementation Journal

**Date:** 2025-12-18  
**Repo:** `/home/md/language/mdminecraft`  
**Plan:** `wrk_docs/2025.12.17 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  

---

## 2025-12-18

### Stage 3 — Survival loop fidelity (WIP)

- Moved survival ticking to the fixed 20 TPS sim loop (`GameWorld::fixed_update`) via a new `GameWorld::tick_player_survival(dt)` to reduce FPS-dependence.
- Implemented tick-based environmental hazards:
  - Drowning (air depletion + periodic drowning damage; Water Breathing prevents it).
  - Burning DOT (periodic fire damage; Water extinguishes; Fire Resistance prevents damage).
  - Lava contact damage + ignition (simplified; Fire Resistance prevents).
- Reintroduced XP orb physics + collection in sim-time (previously removed from per-frame update); XP now also drives Mending repairs (hotbar only, simplified).
- Added bed interaction: right-click bed sets spawn and skips to sunrise (simple hostile-mob proximity gate; clears weather).
- UI polish: added slot tooltips + durability bars for tools (hotbar + inventory overlay).
- Added personal crafting (2x2) inside the inventory UI; added crafting table recipe (4 planks → crafting table) to enable the early-game loop without requiring a pre-placed table.
- Prevented accidental item loss on close by returning any items left in crafting grids (crafting table + personal crafting) back into the hotbar (best-effort; warns if full).
- Added player drop-item behavior: `Q` drops one from the selected hotbar stack; `Ctrl+Q` drops the whole stack. Drops spawn just outside pickup radius in front of the player and are configurable via the pause-menu keybind editor (`DropItem`).
- Extended dropped-item mappings to include tools (pickaxe/axe/shovel/sword/hoe across materials), so dropping and re-picking up tools now works.
- Refactored brewing stand UI to use cursor + hotbar interactions (fuel/ingredient/bottle slots); the old quick-add buttons are now hidden behind `MDM_DEBUG_BREWING_QUICK_ADD=1`. Added client-side IDs + dropped-item mappings for brewing items and potions so they can be picked up/dropped.

### Stage 3 — Crafting + furnace UX (WIP)

- Fixed furnace UI integration: removed temporary “quick-add” debug buttons and wired furnace input/fuel/output to the selected hotbar slot (put selected → input/fuel; take output/input/fuel back to hotbar with overflow returned to the furnace).
- Hardened inventory insertion: implemented `Hotbar::add_stack` to merge/split stacks across hotbar slots and used it for crafting output + dropped-item pickup paths.
- Fixed a major block-id mismatch: aligned crafting recipes and hotbar defaults to the canonical ids from `config/blocks.json` (notably cobblestone=24, oak_log=11, oak_planks=12, crafting_table=13, furnace=18).
- Removed hardcoded block-name tables in the hotbar overlay; block names now come from `BlockRegistry` descriptors.
- Added canonical block-id constants to `mdminecraft_world` (`BLOCK_COBBLESTONE`, `BLOCK_OAK_LOG`, `BLOCK_OAK_PLANKS`) and re-exported them.
- Corrected several world block-id tables that were off-by-one vs `config/blocks.json` (redstone + farming blocks, plus interactive `bed_*`/`chest`/`trapdoor`/`torch` ids).
- Fixed dropped cobblestone placement + drops (`drop_item::ItemType::Cobblestone` now places as block id 24; cobblestone blocks drop themselves).
- Fixed crafting recipe matching to require exact counts (prevents “extra items still match” and silent deletion on craft).
- Added unit tests for crafting recipes (log→planks, planks→sticks, planks→table, cobble→furnace, coal+stick→torches) and exact-count enforcement.
- Fixed leaf drop IDs in `mdminecraft_world::drop_item` (oak/birch/spruce leaves now align with `config/blocks.json`) and wired leaf-breaking in the client to produce deterministic apple/sapling drops.
- Replaced the “fract(sim_tick)” drop RNG with a deterministic, per-block seeded RNG for Fortune/leaf drops (seeded by world seed + sim tick + block position).
- Added a regression test to ensure key block-id tables match `config/blocks.json` (`crates/world/tests/block_ids_match_blocks_json.rs`).
- Added core early-game smelting parity: `OakLog → Coal` (charcoal-as-coal) and `Cobblestone → Stone` in `mdminecraft_world::furnace`.
- Fixed crafting consumption semantics: crafting now consumes only the required inputs (instead of clearing the entire grid), and planks crafting intentionally allows extra log counts so players can craft multiple times without clearing the grid.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `cargo test -p mdminecraft`

### Stage 3 — Inventory UX (WIP)

- Replaced the “number button” crafting UI with a cursor-based slot interaction model:
  - Left click: pick up / place / merge / swap.
  - Right click: pick up half / place one / add one.
- Inventory UI (2×2) and crafting table UI (3×3) now use interactive slots for both grids + hotbar, with a visible cursor stack.
- Craft results now prefer the UI cursor stack; overflow spills to world drops instead of being silently lost.
- Inventory close now returns only the cursor stack; the personal crafting grid now persists across inventory closes (vanilla-like).
- Crafting table close returns the cursor stack plus any remaining grid items back to the player, spilling overflow to world drops.

### World drops — parity improvements

- Added droppable/placeable `CraftingTable` and `Torch` to `mdminecraft_world::drop_item::ItemType` (including `to_block`, `from_block`, and a new `from_placeable_block` helper).
- Updated worldtests/unit tests to match new block drop behavior for crafting tables/torches.

### Persistence safety

- On world save/exit (`persist_world`), stashes any UI-held items (cursor + both crafting grids) back into player storage or world drops so they aren’t lost when quitting mid-UI.

### Furnace UX

- Furnace UI now uses the same cursor-based slot interactions as inventory/crafting (input/fuel/output slots + hotbar shown, no “selected hotbar” buttons).
- Added unit tests covering furnace slot click semantics (output take/merge; input smeltable filtering + swap).

### Enchanting UX + Lapis

- Added Lapis Lazuli as a real core item (`Item(15)`) and mapped it to/from world dropped items so it can be picked up and used.
- Enchanting table UI now has an interactive lapis slot (deposit/withdraw via cursor) and shows the hotbar/cursor like other UIs (removed the debug “+ Lapis” button).
- Synced enchanting offers to the currently selected hotbar tool by mapping core tools to the world enchanting ID conventions; offers now reroll after enchanting.

### Stage 3 — Crafting Output UX (WIP)

- Removed “Craft” buttons: inventory 2×2 and crafting table 3×3 outputs are now clickable result slots.
- Normal click crafts once **into the cursor** (only if the cursor can accept the full output stack).
- Shift-click crafts as many times as possible **into the hotbar**; overflow spills to world drops.
- Added shift-click quick-move from crafting grid slots back to the hotbar (bypasses the cursor).
- Clamped `try_add_stack_to_cursor` to the cursor max stack size (so overflow returns to the caller for hotbar/spill instead of silently overfilling the cursor).
- Refactored `render_core_slot_interactive` to share a single visual renderer, so shift-click behavior doesn’t duplicate tooltip/durability rendering logic.
- Added unit tests for cursor clamping + craft-max helpers.

### Verification (post-change)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Verification (post-change 2)

- `cargo fmt --all`
- `cargo clippy -p mdminecraft --all-targets -- -D warnings`
- `cargo test -p mdminecraft`

### Stage 3 — Overflow Safety (WIP)

- Fixed dropped-item pickup overflow: if the hotbar can’t accept the full picked-up stack, the remainder is re-spawned just outside the pickup radius (prevents silent deletion).

### Verification (post-change 3)

- `cargo fmt --all`
- `cargo test -p mdminecraft`

### Stage 3 — Pause Menu + Options (WIP)

- Implemented an in-game pause menu (Esc) instead of immediately returning to title:
  - Resume Game
  - Options…
  - Save & Quit to Title
  - Quit Game
- While paused, the deterministic 20 TPS sim loop is halted and the fixed-step accumulator is held at 0 to prevent “fast-forward” on resume.
- Options screen:
  - Mouse sensitivity + invert-Y update live
  - FOV + render distance update live
  - “Save Controls” writes `config/controls.toml`
- Added `fov_degrees` + `render_distance` to `ControlsConfig` so menu + pause options persist and apply consistently.
- Game now initializes camera FOV + chunk radius from `ControlsConfig` (menu sliders are no longer cosmetic).
- Made menu → game propagation correct: starting a new game now reloads `ControlsConfig` from disk so menu changes take effect immediately.
- Updated menu “Save” behavior to preserve binding overrides by round-tripping `ControlsConfig` instead of overwriting with a minimal template.
- Added a basic keybind editor in pause menu → Options (base layer only, limited key set) and hot-reload bindings in-session by rebuilding `InputProcessor`.

### Verification (post-change 4)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Verification (post-change 5)

- `cargo fmt --all`
- `cargo clippy -p mdminecraft --all-targets -- -D warnings`
- `cargo test -p mdminecraft`

### Stage 3 — Main Inventory (WIP)

- Implemented an interactive 27-slot main inventory (distinct from the hotbar) with cursor interactions in the inventory UI.
- Added shift-click quick-move between main inventory and hotbar (vanilla-like “quick transfer” behavior).
- Wired main inventory persistence by converting to/from `mdminecraft_world::Inventory` on save/load:
  - Stores tool durability + enchantments in `Inventory::ItemStack.metadata` (compact, versioned encoding).
  - Includes a sentinel fallback path that stores a full `mdminecraft_core::ItemStack` as JSON metadata for items without a dropped-item mapping.
- Updated dropped-item pickup insertion to fill hotbar first, then main inventory; overflow is re-spawned just outside pickup radius (prevents silent deletion).
- Updated UI close/save stashing to return cursor/crafting-held stacks into player storage (hotbar → main inventory) and spill any remaining overflow to world drops (prevents hidden “cursor-only” items after closing UI).
- Bow arrow consumption now checks the main inventory if the hotbar has no arrows.
- Added `DroppedItemType::from_id(u16)` to support inventory persistence roundtrips and future container work.

### Verification (post-change 6)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `cargo test -p mdminecraft-world`
