# Journal — Input Overhaul (2025-11-18)

## 19:20 - Kickoff
- User reports control issues (WASD, mouse look, vertical movement).
- Need to investigate current input pipeline, review `InputState`, `GameWorld::update_camera`, renderer focus capture, etc.
- Plan: audit existing code paths, catalog deficiencies, draft comprehensive HLD for improved controls, including mode switching (fly vs physics), mouse capture, keybinds, rebinding architecture.
- Next: inspect `src/input`, `src/game.rs` sections for movement; gather winit event handling details.

## 19:40 - Controls HLD drafted
- Audited `InputState`/`update_camera`; confirmed cursor grab never engaged and movement logic is simplistic.
- Authored "2025.11.18 - HLD - Input and Camera Controls" covering goals, contexts, cursor locking, action mapping, physics vs fly modes, and implementation plan.
- Next up once approved: start implementing input contexts + cursor capture, then action mapping + movement rewrite.

## 19:55 - Design review pass
- Re-read HLD and identified gaps: Wayland cursor locking assumption, lack of config storage, missing sprint/crouch actions, limited automation notes.
- Updated HLD with DeviceEvent handling, controls.toml config, expanded action enum, scripted-input testing hook, and review notes section.
- Ready to solicit feedback / begin implementation when approved.

## 20:05 - Implementation plan drafted
- Derived staged plan from HLD: Stage0 foundations/config, Stage1 actions, Stage2 camera/cursor, Stage3 movement, Stage4 automation.
- Logged dependencies (Wayland capture guarding, DeviceEvent fallback).
- Ready to execute once approved.

## 20:15 - Plan review adjustments
- Re-read implementation plan and spotted missing context layering, cursor toggle testing, and menu/gameplay separation tasks.
- Updated plan with layered bindings, explicit toggle exit criteria, menu-aware action processing, and review notes section.
- Ready to proceed to execution phases once approved.

## 20:20 - Stage 0 foundations
- Begin implementing controls config + InputState scaffolding.
- Tasks: create `ControlsConfig` loader, update main/GameWorld to share config, extend `InputState` with contexts/snapshots + DeviceEvent plumbing.
## 20:40 - Stage 0 progress
- Added `ControlsConfig` loader (TOML) + workspace deps, wired into `main`/`GameWorld` via `Arc` so gameplay will have access to sensitivity/invert settings.
- Extended `InputState` with contexts, snapshots, scroll accumulation, raw mouse motion via `DeviceEvent`, and cursor capture helpers (Wayland-safe fallbacks). Re-exported `InputContext`/`InputSnapshot` for future stages.
- Game loop now forwards `DeviceEvent`s to `InputState`; auto-play still works (smoke-tested via `cargo build`).
- Next: Stage 1 action mapping layer.
## 21:05 - Stage 1 action mapping
- Added `src/input.rs` with bindings/action-processing pipeline: default keymap, TOML overrides, layered bindings, and `ActionState` (with axes, toggles, hotbar slots, scroll).
- `InputState` now supports snapshot_view (no reset) so action processing doesn't break legacy camera; snapshots still reset once per frame.
- `GameWorld` owns an `InputProcessor`, generates action state each frame, and currently applies hotbar slot/scroll actions (old digit handling removed). Cursor capture happens automatically on game start.
- Build verified via `cargo build` (no runtime yet). Ready for Stage 2 (camera/cursor hooking) next.
## 21:35 - Stage 2 camera & cursor
- Added `mod input` (new module) and wired processor/actions into `GameWorld`; actions now drive hotbar selection/scroll + cursor toggle.
- `InputState` gained `enter_ui_overlay`, `snapshot_view` for peeking without resetting, and context-aware cursor capture/release flows (Wayland-safe). ESC now releases cursor before returning to menu.
- Mouse look uses `ActionState` deltas + `ControlsConfig` sensitivity/invert instead of raw winit events; cursor toggle switches between gameplay capture and overlay.
- Built successfully (`cargo build`). Remaining Stage 2 work (cursor states) complete; ready to tackle movement rewrite next.
## 21:55 - Stage 3 movement rewrite
- Replaced movement logic with action-driven implementation: mouse look now pulled from `ActionState` (sensitivity/invert aware), `ActionState` feeds physics walk vs fly modes (sprint/crouch speed tiers, jump, fly ascend/descend). Added helpers to update camera position based on actions, with placeholder floor clamp + fall damage hooks.
- `apply_actions` also handles `ToggleFly`, cursor toggles now leverage the new InputState contexts.
- `DeviceEvent` import cleaned up, `ActionState` fields annotated appropriately; `cargo fmt` + `cargo build` pass.
- Ready for Stage 4 (automation + docs/test script) next.
## 22:20 - Stage 4 automation & docs
- Added scripted input support (`--scripted-input path`) with JSON-based step sequences (sample in `config/scripts/demo.json`). Auto-play now accepts scripts and GameWorld can drive movement/look purely from scripted actions.
- Main CLI parses both flags, GameWorld processes scripted actions (bypassing hardware input) and hotbar/cursor/fly toggles ride through the action layer. Input snapshots continue for manual play, and cursor capture flows through contexts.
- Updated README with scripted-input instructions; `cargo fmt` + `cargo build` pass.
- Remaining Stage 4 polish: HUD/status tweaks and QA checklist if needed.

## 22:45 - HUD telemetry polish
- Implemented `ControlMode` enum plus new Debug HUD fields (mode, cursor capture flag, mouse sensitivity) in `crates/render/src/ui.rs`, re-exported via render crate, and wired UI panel to display the extra telemetry.
- `GameWorld` now reports real-time mode/capture/sensitivity state each frame; added helper for deriving control mode based on context + physics toggle.
- Updated journal ahead of running `cargo fmt`/`clippy`/`build` to confirm the polish is stable.

## 22:55 - Tooling pass
- Ran `cargo fmt`, addressed Clippy feedback (derive Default usages, iterator cleanup, unused imports), and ensured `cargo clippy --all-targets --all-features -- -D warnings` is clean.
- Verified `cargo build` for workspace targets to confirm HUD additions didn't introduce regressions.

## 23:05 - QA checklist doc
- Authored `wrk_docs/2025.11.18 - CHK - Input Controls Regression.md` capturing 20 regression scenarios covering cursor flows, mouse look, movement modes, automation, and HUD telemetry.
- Document outlines steps/expected results plus automation notes for scripted input; ready for future runs whenever controls change.

## 23:20 - Wireframe bind group fix
- User reported crash inside the wireframe highlight pass complaining about mismatched bind group layouts; root cause was the wireframe pipeline creating its own camera layout (single binding) while we bound the main pipeline's camera bind group (camera + time).
- Updated `VoxelPipeline` to retain its camera bind group layout and exposed an accessor, then fed that into `WireframePipeline::new` so both pipelines share the same layout and bind group; removed the redundant wireframe-specific layout.
- Verified with `cargo fmt`, `cargo clippy --all-targets --all-features -- -D warnings`, and `cargo build`.

## 23:40 - Spawn + meshing polish
- Addressed two player-facing issues reported today: spawning mid-air (“in space”) and chunks missing top faces. Added `GameWorld::determine_spawn_point` to scan the origin chunk, pick the highest solid column, and spawn the camera slightly above it so players start on terrain. Also updated `player_physics.last_ground_y` accordingly.
- Corrected face normal orientation in `crates/render/src/mesh.rs`: when the solid voxel is on the negative side of the slicing plane we now emit a positive normal (and vice versa), fixing top/bottom faces that were previously culled.
- Rebuilt + clippy-clean to ensure the renderer compiles after the geometry adjustments.

## 23:55 - Scope assessment
- Reviewed current repo capabilities vs the “near-base Minecraft” goal (full voxel renderer, intuitive controls, day/night, but lacking survival gameplay depth). Preparing written status for user covering major gaps (textures, biome variety, inventory interactions, mobs, audio) and estimating work to close them.
