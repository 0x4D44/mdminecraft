# Implementation Plan — Input and Camera Controls Overhaul (2025-11-18)

## Stage 0: Foundations & Config (0.5 day)
### Objectives
- Establish configuration plumbing (controls.toml) for sensitivity, invert-Y, and keybindings.
- Extend `InputState` scaffolding to support contexts and snapshots.

### Tasks
1. **Controls config loader**
   - Define `ControlsConfig` struct in a new `mdminecraft-core` module or `src/config.rs`.
   - Load TOML from `config/controls.toml` (fallback to defaults if missing) during app startup; expose via `GameWorld`/`InputState`.
2. **InputState upgrades**
   - Add `InputContext`, `scroll_delta`, `raw_mouse_delta`, `cursor_captured` fields.
   - Implement `set_cursor_capture`, `enter_gameplay`, `enter_menu`, and `snapshot()`.
   - Update event handling to ignore `Repeat` states and accumulate scroll.
3. **DeviceEvent plumbing**
   - Register for `DeviceEvent::MouseMotion` in main loop; pipe into `InputState`.

### Exit Criteria
- Unit tests (or integration logs) show config loads and `InputState::snapshot()` returns consistent deltas.
- Cursor capture helpers compile on major platforms and log graceful warnings when a grab request fails (Wayland, macOS sandbox, etc.).

## Stage 1: Action Mapping Layer (0.5 day)
### Objectives
- Introduce `PlayerAction`, `Bindings`, and `ActionState` to decouple hardware inputs from gameplay logic.

### Tasks
1. **Bindings model**
   - Create default binding tables (Gameplay/Menu) mapping `KeyCode`/mouse buttons to actions.
   - Allow overrides from `ControlsConfig`, supporting contextual layers (`base`, `gameplay`, `ui`).
2. **ActionState derivation**
   - Add `InputProcessor` that consumes an `InputSnapshot` + layered `Bindings` to produce `ActionState` each frame.
   - Include analog axes (move_x, move_y, move_z, look_delta) and boolean flags (jump edge, sprint, crouch, toggle fly), plus hotbar slot changes.
3. **GameWorld integration**
   - Before updating camera/physics/UI, fetch snapshot -> action state and pass to downstream systems; ensure tests or logging can inject synthetic `ActionState`.

### Exit Criteria
- Debug logging shows reasonable `ActionState` values when keys/mouse move.
- Legacy direct `InputState::is_key_pressed` usage is removed from `GameWorld::update_camera`.

## Stage 2: Camera & Cursor Behaviour (0.5 day)
### Objectives
- Apply action-driven look deltas to the camera and manage cursor capture transitions.

### Tasks
1. **Camera updates**
   - Replace manual mouse handling with `action_state.look_delta * sensitivity`; clamp pitch.
   - Store yaw/pitch on `PlayerLook` (or reuse `Camera` struct fields) and expose for HUD.
2. **Cursor flow**
   - On gameplay entry (auto-play or menu transition) call `input.enter_gameplay`; on ESC release capture and show cursor.
   - Bind a `ToggleCursor` action to allow unlocking without leaving the game (e.g., F1).

### Exit Criteria
- Manual testing: cursor locks when gameplay starts, mouse look works in both auto-play and menu entry, ESC returns to menu with visible cursor, and the toggle key releases/recaptures the pointer without leaving gameplay.

## Stage 3: Movement Rewrite (1 day)
### Objectives
- Implement action-driven movement for physics and fly modes, with sprint/crouch/jump/ascend functionality.

### Tasks
1. **Physics mode**
   - Compute horizontal velocity from `move_x/move_y` relative to yaw; apply `walk/sprint/crouch` speed tiers from config.
   - Integrate jump edges; clamp Y using chunk/block collisions (reuse existing placeholder but expose hook for future voxel queries).
   - Update `PlayerPhysics` struct to track desired speed, crouch state (affects `player_height`), and camera offset.
2. **Fly mode**
   - Add ascend/descend inputs (Space/Ctrl or E/Q) and boost modifier.
   - Allow toggling physics/fly via action (F4) and ensure camera height resets appropriately.
3. **Hotbar & scroll**
   - Hook `scroll_delta` and numeric keys into `ActionState` to change selected slot.
4. **Menu vs Gameplay separation**
   - Ensure action processing respects context so that menus do not continue updating camera/movement while open.

### Exit Criteria
- Manual: WASD moves relative to view, mouse look + jump works, free-fly ascend/descend works, crouch alters camera height.
- Debug HUD displays current mode, speed, yaw/pitch, and indicates whether physics or fly mode is active.

## Stage 4: Automation & Polish (0.5 day)
### Objectives
- Add scripted input option for headless testing and update documentation/HUD.

### Tasks
1. **Scripted input**
   - Extend `--auto-play` with optional `--scripted-input path.json` that feeds canned `ActionState` frames.
   - Provide a default script that looks around and moves for CI smoke tests.
2. **HUD & docs**
   - Update Debug HUD to show input mode, sensitivity, and cursor capture status.
   - Update README/docs/HLD references to reflect the new control scheme and config file.
3. **QA checklist**
   - Create regression checklist covering menu transitions, mouse capture, sprint/crouch, fly mode, scripted run.

### Exit Criteria
- Scripted auto-play demo runs without manual input showing movement/looking logs.
- Documentation references new controls and config file locations.

## Dependencies & Notes
- Always guard cursor capture calls for Wayland (handle errors and log warnings without crashing).
- Keep feature flags or environment config to disable DeviceEvent processing if a platform misbehaves.
- Consider follow-up work (not in scope) for proper collision detection, scripted CI inputs, and keybinding UI once base controls stabilize.

## Review Notes (2025-11-18 20:15)
1. **Context layering** — Initial plan did not mention layered bindings; added requirement to merge base/gameplay/menu bindings so the same processor can drive menus without stray gameplay actions.
2. **Synthetic ActionState** — For automation, `ActionState` must be injectable; updated Stage 1/4 tasks to mention this.
3. **Cursor toggle exit criteria** — Stage 2 now requires validating the explicit toggle action, not just ESC.
4. **Movement & context separation** — Stage 3 lacked mention of suspending gameplay actions while menus are open; added task.
5. **Future work note** — Added reference to scripted CI inputs in dependencies for visibility.
