# Vanilla Parity Implementation Journal

**Date:** 2025-12-21  
**Repo:** `/home/md/language/mdminecraft`  
**Plan:** `wrk_docs/2025.12.21 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  
**Previous journal:** `wrk_journals/2025.12.20 - JRN - Vanilla Parity Implementation.md`  

---

## 2025-12-21

### Stage 5B (partial) — Raise world height to 384 (0..383)

- Raised chunk height from **256 → 384** (`CHUNK_SIZE_Y`, 24 sections), keeping `WORLD_MIN_Y=0` for now (negative-Y shift intentionally deferred).
- Updated world-space Y usage:
  - projectile collision bounds use `world_y_to_local_y` instead of `0..256`
  - render frustum chunk AABB uses `WORLD_MIN_Y` + `CHUNK_SIZE_Y`
  - updated out-of-bounds simulation tests to use `WORLD_MIN_Y/WORLD_MAX_Y` instead of hard-coded -1/256
- Networking: bumped `PROTOCOL_VERSION` to **3** and updated protocol chunk constants for 384 height; chunk encoding guards updated accordingly.
- Fixed `crates/render/examples/viewer.rs` to avoid invalid `return;` in the window event callback when rejecting out-of-range Y.

### Tests + runtime hygiene

- Updated worldtests/metrics to scale `blocks_generated` with `CHUNK_SIZE_Y`.
- Updated `stage4_integration_worldtest` defaults to stay well under the 60s “looks hung” threshold after height expansion:
  - debug default chunk radius: **3 → 2**
  - perf threshold now scales with `CHUNK_SIZE_Y` (override still supported via `MDM_STAGE4_INTEGRATION_MAX_AVG_GEN_US`).
- Updated `chunk_streaming::test_bandwidth_limiting` to derive its bandwidth limit from an encoded sample chunk (so the test remains correct as `CHUNK_VOLUME` changes).
- Updated `proptest_chunk_seams::heightmap_bounds` to validate heights against `WORLD_MIN_Y..=WORLD_MAX_Y`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (highlights: `tests/determinism_worldtest.rs` 15.29s; `crates/world/tests/stage4_integration_worldtest.rs` 17.02s; `crates/world/tests/large_scale_terrain_worldtest.rs` 32.67s)

