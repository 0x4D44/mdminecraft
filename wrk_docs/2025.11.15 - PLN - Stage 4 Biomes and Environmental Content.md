# Stage 4 Implementation Plan — Biomes, Structures, Environmental Content
Date: 2025-11-15

## Executive Summary

**Stage 3 Status:** ✅ Networking infrastructure complete (95% overall, 100% infrastructure)

**Stage 4 Objectives:** Implement chunk generation with biome noise stack, procedural structures, passive mobs with deterministic AI, drop item lifecycle, and weather control UI.

**Timeline:** Weeks 19-24 (6 weeks, estimate)

**Key Deliverables:**
- Chunk generation pipeline (heightmap, biomes, structures, population)
- Passive mob FSM with deterministic AI
- Drop item lifecycle and events
- Weather control UI with replayable events
- BiomeSeams and PassiveMobWander worldtests

---

## Stage 4 Architecture Overview

### Chunk Generation Pipeline

```
World Seed + Chunk Coords
    ↓
┌─────────────────────────────────────┐
│  Phase 1: Heightmap Generation     │
│  - Noise functions (Perlin/Simplex)│
│  - Continental/erosion/PV layers   │
│  - Output: height[x][z]            │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  Phase 2: Biome Assignment         │
│  - Temperature/humidity noise      │
│  - Biome map lookup                │
│  - Output: biome[x][z]             │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  Phase 3: Terrain Shaping          │
│  - Block placement per biome       │
│  - Stone, dirt, grass layers       │
│  - Cave carving (optional)         │
│  - Output: blocks[x][y][z]         │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  Phase 4: Structure Placement      │
│  - Grid-based structure spawning   │
│  - Tree placement per biome        │
│  - Village/dungeon generation      │
│  - Output: modified blocks         │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  Phase 5: Population Pass          │
│  - Tall grass, flowers, mushrooms  │
│  - Passive mob spawning            │
│  - Final decoration                │
│  - Output: complete chunk          │
└─────────────────────────────────────┘
```

### Entity System Architecture

```
┌─────────────────────────────────────┐
│  Entity Components (ECS)           │
│  - Position, Velocity, Health      │
│  - AI State, Inventory, Rendering  │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  AI Systems (Deterministic FSM)    │
│  - Idle, Wander, Flee, Follow      │
│  - Seeded RNG for AI decisions     │
│  - Tick-based state transitions    │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  Physics Integration               │
│  - Collision detection             │
│  - Gravity, velocity application   │
│  - Deterministic movement          │
└─────────────────────────────────────┘
```

---

## Phase Breakdown

### Phase 4.1: Noise Functions & Heightmap Generation (Week 19)

**Objectives:**
- Implement noise generation (Perlin/Simplex)
- Create heightmap generation from noise layers
- Ensure deterministic output from world seed

**Major Activities:**
1. Add noise library dependency (noise-rs or simdnoise)
2. Implement NoiseGenerator trait
3. Create heightmap function with multiple octaves
4. Add continental, erosion, and peaks-valleys layers
5. Unit tests for determinism and reproducibility

**Deliverables:**
- `crates/world/src/noise.rs` - Noise generation utilities
- `crates/world/src/heightmap.rs` - Heightmap generation
- Unit tests verifying deterministic output
- Performance benchmark for noise generation

**Exit Criteria:**
- Same seed produces identical heightmaps
- Heightmap generation < 5ms per chunk
- No seams between adjacent chunks
- Noise parameters configurable

---

### Phase 4.2: Biome System & Assignment (Week 19-20)

**Objectives:**
- Define biome types (Plains, Forest, Desert, Mountains, Ocean, etc.)
- Implement biome assignment from temperature/humidity noise
- Create biome transition/blending system

**Major Activities:**
1. Define BiomeId enum and BiomeData struct
2. Implement temperature and humidity noise layers
3. Create biome lookup table (2D grid: temp x humidity)
4. Add biome blending for smooth transitions
5. Integrate biome data into chunk generation

**Deliverables:**
- `crates/world/src/biome.rs` - Biome definitions and assignment
- Biome data files (JSON or similar)
- BiomeSeams worldtest scenario
- Visual biome map generation tool (optional)

**Exit Criteria:**
- At least 6 biomes implemented (Plains, Forest, Desert, Mountains, Ocean, Taiga)
- No visible seams between biomes
- Biome distribution looks natural
- Deterministic biome assignment from seed

---

### Phase 4.3: Terrain Generation & Block Placement (Week 20-21)

**Objectives:**
- Implement block placement based on heightmap and biome
- Add surface layer generation (grass, sand, etc.)
- Implement cave carving (optional for MVP)

**Major Activities:**
1. Create TerrainGenerator that uses heightmap + biome
2. Implement per-biome block palettes (grass, sand, stone, etc.)
3. Add surface layer generation (dirt depth based on biome)
4. Implement basic cave carving with 3D noise
5. Add ore generation (coal, iron, etc.)
6. Integration tests for terrain consistency

**Deliverables:**
- `crates/world/src/terrain.rs` - Terrain generation logic
- `crates/world/src/caves.rs` - Cave carving (optional)
- `crates/world/src/ores.rs` - Ore generation
- Superflat replacement with generated terrain
- Performance metrics for chunk generation

**Exit Criteria:**
- Terrain matches biome characteristics
- Surface layers have appropriate depth
- Caves generate without breaking surface
- Chunk generation < 20ms per chunk
- No floating blocks or gaps

---

### Phase 4.4: Structure Generation (Week 21-22)

**Objectives:**
- Implement structure placement system
- Add tree generation per biome
- Create village/dungeon structures (optional for MVP)

**Major Activities:**
1. Define Structure trait and StructureType enum
2. Implement grid-based structure spawning (avoid overlap)
3. Create tree generators (oak, birch, spruce, etc.)
4. Add structure templates (NBT or JSON format)
5. Implement structure placement in population pass
6. Add structure-specific loot tables

**Deliverables:**
- `crates/world/src/structures.rs` - Structure system
- `crates/world/src/trees.rs` - Tree generation
- Tree templates for each biome
- Structure placement tests
- Performance benchmarks

**Exit Criteria:**
- Trees generate in appropriate biomes
- No structure overlap or conflicts
- Structures are chunk-aligned
- Structure generation deterministic
- Performance impact < 5ms per chunk

---

### Phase 4.5: Passive Mobs & Deterministic AI (Week 22-23)

**Objectives:**
- Implement passive mob entities (Cow, Pig, Sheep, Chicken)
- Create deterministic FSM-based AI
- Add mob spawning during chunk population

**Major Activities:**
1. Define MobType enum and mob data
2. Implement AI states (Idle, Wander, Flee, Follow)
3. Create FSM with seeded RNG for state transitions
4. Add mob spawning in population pass
5. Integrate mob physics (gravity, collision)
6. Add mob rendering (use existing entity system)
7. Create PassiveMobWander worldtest

**Deliverables:**
- `crates/world/src/mobs.rs` - Mob spawning and data
- `crates/ecs/src/ai.rs` - AI FSM systems
- PassiveMobWander worldtest scenario
- Mob behavior tests (determinism)
- Performance metrics for AI systems

**Exit Criteria:**
- 4 passive mob types implemented
- AI behavior is deterministic from seed
- Mobs wander naturally and avoid cliffs
- No mob spawning in inappropriate biomes
- AI overhead < 0.1ms per mob per tick
- PassiveMobWander test passes

---

### Phase 4.6: Drop Items & Lifecycle (Week 23)

**Objectives:**
- Implement drop item entities
- Add item pickup and inventory integration
- Create item despawn timer

**Major Activities:**
1. Define DropItem entity type
2. Implement item drop on block break
3. Add item pickup on player collision
4. Create item despawn timer (5 minutes default)
5. Integrate with existing inventory system
6. Add DropItem events for replay
7. Unit tests for item lifecycle

**Deliverables:**
- `crates/world/src/items.rs` - Drop item logic
- `crates/ecs/src/item_pickup.rs` - Pickup system
- Item lifecycle tests
- DropItem event logging
- Performance benchmarks

**Exit Criteria:**
- Items drop on block break
- Items can be picked up by players
- Items despawn after timer
- Item events logged for replay
- No item duplication or loss bugs

---

### Phase 4.7: Weather Control UI & Integration (Week 23-24)

**Objectives:**
- Create weather control UI (toggle rain/clear)
- Integrate with existing weather system
- Ensure WeatherChanged events are replayable

**Major Activities:**
1. Design weather control UI mockup
2. Implement UI elements (buttons, indicators)
3. Add keyboard shortcuts for weather toggle
4. Integrate with existing SimTime and Weather
5. Emit WeatherChanged events
6. Add event logging to replay harness
7. Visual weather effects (rain particles, sky color)

**Deliverables:**
- `crates/client/src/weather_ui.rs` - Weather UI
- Weather toggle integration
- WeatherChanged event in protocol
- Visual weather effects
- Weather UI tests

**Exit Criteria:**
- Weather can be toggled via UI
- Weather changes replayed correctly
- Visual feedback for weather state
- No desyncs in multiplayer
- Weather transitions smooth

---

### Phase 4.8: Worldtests & Performance Validation (Week 24)

**Objectives:**
- Create BiomeSeams worldtest
- Create PassiveMobWander worldtest
- Validate performance metrics
- Lock render goldens per backend

**Major Activities:**
1. Implement BiomeSeams test (9x9 chunks, varied biomes)
2. Implement PassiveMobWander test (spawn mobs, verify AI)
3. Capture performance baselines (chunk gen, AI, rendering)
4. Generate render snapshots for each backend
5. Lock mesh hashes as goldens
6. CI integration for worldtests
7. MegaForest and CaveCity performance captures

**Deliverables:**
- `crates/testkit/src/biome_seams.rs` - BiomeSeams test
- `crates/testkit/src/passive_mob_wander.rs` - PassiveMobWander test
- Performance metrics in metrics.json
- Render goldens per backend
- CI job for Stage 4 worldtests

**Exit Criteria:**
- BiomeSeams test shows no visible seams
- PassiveMobWander test shows deterministic AI
- Mesh hashes stable after rebuild
- Performance within targets:
  - Chunk generation: < 20ms
  - Mob AI: < 0.1ms per mob
  - Frame rate: 60 FPS in 9x9 area
- All worldtests green in CI

---

## Technical Requirements

### Noise Generation
- **Library**: noise-rs or simdnoise (evaluate performance)
- **Noise types**: Perlin, Simplex, OpenSimplex
- **Octaves**: Configurable multi-octave noise
- **Seed**: Deterministic from world seed

### Biome System
- **Biome count**: Minimum 6 for MVP
- **Assignment**: 2D noise (temperature, humidity)
- **Blending**: Smooth transitions between biomes
- **Data format**: JSON or RON for biome definitions

### Terrain Generation
- **Block types**: Stone, dirt, grass, sand, water, etc.
- **Layers**: Surface, subsurface, bedrock
- **Features**: Caves (optional), ores
- **Performance**: < 20ms per chunk

### Structure Generation
- **Trees**: 3-4 tree types minimum
- **Placement**: Grid-based to avoid overlap
- **Templates**: NBT or JSON format
- **Determinism**: Seeded placement

### Mob AI
- **FSM states**: Idle, Wander, Flee, Follow
- **RNG**: Seeded per-mob for deterministic behavior
- **Pathfinding**: Simple random walk for MVP
- **Spawning**: During chunk population

### Drop Items
- **Spawn**: On block break, mob death
- **Pickup**: Collision detection with player
- **Despawn**: 5-minute timer
- **Events**: Logged for replay

### Weather UI
- **Controls**: Toggle buttons or keyboard shortcuts
- **Indicators**: Current weather state
- **Effects**: Rain particles, sky color changes
- **Events**: WeatherChanged logged

---

## Dependencies

### New Dependencies (Estimated)

```toml
# Noise generation
noise = "0.9"  # Or simdnoise for performance
```

### Existing Dependencies
- ✅ bevy_ecs - Entity component system
- ✅ mdminecraft-core - SimTick, deterministic RNG
- ✅ mdminecraft-world - Chunk storage, lighting, weather
- ✅ mdminecraft-render - Mesh generation, rendering
- ✅ mdminecraft-physics - Collision detection

---

## Performance Targets

| Metric | Target | Measurement |
|--------|--------|-------------|
| Chunk generation | < 20ms | Per chunk, including all phases |
| Noise generation | < 5ms | Heightmap + biome noise |
| Structure placement | < 5ms | Trees + structures per chunk |
| Mob AI overhead | < 0.1ms | Per mob per tick |
| Frame rate | 60 FPS | 9x9 chunks with mobs and weather |
| Memory | < 2GB | With 81 chunks loaded |

---

## Testing Strategy

### Unit Tests
- Noise generation determinism
- Biome assignment consistency
- Structure placement validation
- Mob AI state transitions
- Item lifecycle (drop, pickup, despawn)

### Integration Tests
- Chunk generation pipeline end-to-end
- Biome transitions (no seams)
- Structure placement (no overlap)
- Mob spawning and AI
- Weather integration

### Worldtests
- **BiomeSeams**: 9x9 chunks, verify smooth transitions
- **PassiveMobWander**: Spawn mobs, verify deterministic AI
- **MegaForest**: Large forest biome, performance capture
- **CaveCity**: Underground structures, performance capture

### Replay Validation
- Mob AI reproduces from seed
- Weather changes replay correctly
- Drop items behave deterministically

---

## Risk Assessment

### High Risk
1. **Noise generation performance** - May need SIMD optimization
   - Mitigation: Benchmark early, choose fastest library
2. **Biome seams** - Blending may be complex
   - Mitigation: Use weighted interpolation, extensive testing
3. **Mob AI determinism** - FSM must be perfectly seeded
   - Mitigation: Thorough testing, replay validation

### Medium Risk
1. **Structure overlap** - Grid-based system may have edge cases
   - Mitigation: Careful grid calculation, chunk boundary tests
2. **Cave generation** - May intersect with structures
   - Mitigation: Priority ordering (structures first)
3. **Performance regression** - Chunk gen may exceed budget
   - Mitigation: Profile early, optimize hot paths

### Low Risk
1. **Drop item lifecycle** - Well-defined behavior
2. **Weather UI** - Existing weather system in place
3. **Worldtests** - Standard test infrastructure

---

## Deliverables Summary

### Code
- `crates/world/src/noise.rs` - Noise generation
- `crates/world/src/heightmap.rs` - Heightmap generation
- `crates/world/src/biome.rs` - Biome system
- `crates/world/src/terrain.rs` - Terrain generation
- `crates/world/src/caves.rs` - Cave carving (optional)
- `crates/world/src/ores.rs` - Ore generation
- `crates/world/src/structures.rs` - Structure system
- `crates/world/src/trees.rs` - Tree generation
- `crates/world/src/mobs.rs` - Mob spawning
- `crates/world/src/items.rs` - Drop items
- `crates/ecs/src/ai.rs` - AI FSM
- `crates/ecs/src/item_pickup.rs` - Item pickup
- `crates/client/src/weather_ui.rs` - Weather UI

### Tests
- Unit tests for each module
- BiomeSeams worldtest
- PassiveMobWander worldtest
- MegaForest performance capture
- CaveCity performance capture

### Documentation
- Biome definitions and data
- Structure templates
- Mob AI behavior specs
- Performance metrics

---

## Entry Criteria

- ✅ Stage 3 exit (networking infrastructure complete)
- ⏸️ Biome/structure specifications ready
- ⏸️ Content team provides biome definitions

**Status**: Stage 3 complete, proceeding with placeholder biome data

---

## Exit Criteria

- ✅ No biome seams in test scenes
- ✅ Mesh hashes stable after rebuild
- ✅ Mobs and drop items reproducible via replay
- ✅ Weather toggles replayable
- ✅ Performance baselines within targets
- ✅ BiomeSeams worldtest passing
- ✅ PassiveMobWander worldtest passing
- ✅ All unit and integration tests green

---

## Timeline

**Week 19**: Noise & Heightmap, Biome System
**Week 20**: Biome Assignment, Terrain Generation
**Week 21**: Terrain Integration, Structure System
**Week 22**: Passive Mobs & AI
**Week 23**: Drop Items, Weather UI
**Week 24**: Worldtests, Performance Validation

**Total Duration**: 6 weeks (estimated)

---

## Next Steps

1. ✅ Create Stage 4 planning document (this document)
2. ⏸️ Add noise generation dependencies
3. ⏸️ Implement noise.rs and heightmap.rs
4. ⏸️ Define biome system architecture
5. ⏸️ Create BiomeSeams worldtest skeleton
6. ⏸️ Begin Phase 4.1 implementation

---

**Document Version**: 1.0
**Last Updated**: 2025-11-15
**Status**: Planning Complete, Implementation Pending
