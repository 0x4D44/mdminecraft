# Vanilla Parity Implementation Journal

**Date:** 2025-12-23  
**Repo:** `/home/md/language/mdminecraft`  
**Plan:** `wrk_docs/2025.12.23 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  
**Previous journal:** `wrk_journals/2025.12.21 - JRN - Vanilla Parity Implementation.md`  

---

## 2025-12-23

### Stage 4 hardening — Waterlogged water volumes

- Rendering: the chunk mesher emits water volumes for waterlogged blocks (shape-aware for slabs/stairs/trapdoors; fallback full-cube water for other supported blocks).
- Tests: added a render regression test that asserts a waterlogged slab produces the expected number of water faces.

### Stage 4 hardening — Alpha-blended fluid pass

- Rendering: voxel drawing now runs in two passes:
  - opaque pass discards fluid fragments
  - alpha-blended fluid pass (water/lava) loads the opaque depth buffer so fluids blend correctly without hiding underlying block geometry (notably for waterlogged non-cube blocks).
- Stability: translucent-fluid chunks are drawn back-to-front with deterministic tie-breaking to reduce blending flicker.

### Stage 4 hardening — Texture alpha cutouts

- Rendering: the opaque pass now alpha-tests atlas textures and discards fragments with `alpha < 0.5`, enabling cutout-style transparency for textures like glass/leaves without requiring a separate translucent block pass.

### Stage 4 hardening — Flowing fluid surface heights

- Rendering: fluid blocks are now meshed with a per-block fluid height derived from the encoded fluid level, instead of rendering as full cubes.
- Rendering: greedy meshing no longer generates faces for fluids, which prevents internal faces between e.g. water vs flowing-water IDs; fluid faces are emitted by a dedicated meshing pass that treats all water IDs as the same fluid.
- Rendering: fluid top surfaces now use **per-corner heights** (vanilla-ish sloped surface) so adjacent same-type fluids connect smoothly without vertical “step” faces.
- Performance: base heights are cached per-chunk (including a 1-block x/z border) to avoid repeated `voxel_at_world` sampling during meshing.
- Tests: added render regression tests for (1) flowing water emitting a partial-height top face, (2) adjacent same-height flowing water emitting no internal side faces, and (3) a flowing block sloping toward a neighboring source.

### Stage 4 hardening — Flow-direction fluid animation

- Rendering: fluids now encode a coarse flow direction in a spare byte in the voxel vertex format; the voxel shader uses it to orient the procedural wave animation along the flow direction (water/lava), improving “flowing” readability without a new vertex attribute.

### Stage 4 hardening — Translucent ice rendering

- Rendering: `ice` is now rendered in the alpha-blended pass (same pass as fluids), so its texture alpha is respected (visual translucency) rather than being forced opaque by the cutout/opaque pipeline.
- Meshing: `ice` is treated as non-opaque for greedy face culling so adjacent opaque block faces are still emitted (you can see blocks “behind” ice); added a small render regression test.

### Stage 4 hardening — Translucent glass rendering

- Rendering: `glass` and `glass_pane` now render in the alpha-blended pass (same pass as fluids/ice), so they behave like true translucent blocks instead of cutout-only textures.
- Rendering: shader uses the atlas alpha as an edge mask but enforces a base translucency (center remains visible and tinted), improving vanilla-like readability without swapping textures.

### Stage 4 hardening — Split opaque vs alpha index buffers

- Performance: chunk meshes now keep **separate index buffers** for opaque+cutout vs alpha-blended geometry, so chunks with water/glass no longer re-draw the entire index buffer twice each frame.
- Rendering: the alpha-blended pass now draws only the alpha index buffer while reusing the shared vertex buffer, preserving depth-tested translucency while reducing wasted work.
- Tests: added small render regression tests to ensure fluids and glass emit **alpha indices only** (prevents “invisible glass/water” regressions if the render-layer classification changes).

### Stage 4 hardening — Data-driven translucency + alpha-flagged vertices

- Rendering: translucency is now data-driven via the `mdm:render/translucent` block tag (configured in `config/blocks.json` for `ice`, `glass`, `glass_pane`, `nether_portal`, `end_portal`).
- Rendering: the voxel vertex format reserves the top bit of the `extra` byte to mark **alpha-pass membership**; shaders use this bit to discard fragments in the wrong pass, avoiding hard-coded block-id lists.
- Rendering: alpha-pass shading now uses an `alpha_kind` encoded in `extra` bits (fluids/glass/portals), so the voxel shader no longer hard-codes numeric block IDs for those effects.
- Rendering: fluid flow direction now uses the low 4 bits of `extra` (high bits are reserved for tint/alpha metadata).
- Config: added `render/alpha/glass` and `render/alpha/portal/*` tags to drive alpha-kind selection for glass and portals.

### Stage 4 hardening — End portal surface rendering

- Rendering: `end_portal` is now meshed as a **flat surface** at `12/16` block height (vanilla-ish), rendered in the alpha-blended pass instead of as a full cube.
- Tests: added a regression test verifying end portal surfaces emit alpha indices and the expected surface height.

### Stage 4 hardening — Nether portal plane rendering

- Rendering: `nether_portal` is now meshed as a thin vertical plane (2/16 thickness) oriented by the portal axis bit in voxel state (from activation logic), rendered in the alpha-blended pass instead of as a full cube.
- Rendering: portals get simple procedural shader effects (nether portal swirl + end portal starfield-ish).
- Tests: added regression coverage for portal plane orientation across chunk seams (state-driven).

### Stage 4 hardening — Texture atlas mipmaps

- Rendering: runtime atlas upload now generates a mip chain (nearest filtered), reducing distant texture shimmer and matching vanilla-ish mip behavior.
- Rendering: atlas loading now “bleeds” each tile’s edge pixels into its padding region before mip generation, avoiding black halos from empty padding.
- Rendering: mip generation is alpha-aware (RGB weighted by alpha; alpha uses max coverage) so cutout textures retain coverage more reliably in distant mips.
- Tooling: `atlas_packer` now extrudes tile edges into padding when building `atlas.png`, keeping authored atlases mip-safe (runtime still bleeds for backwards compatibility).
- Rendering: voxel sampling now uses linear mipmap filtering (trilinear between mip levels) while keeping nearest texel sampling, reducing mip “popping”.

### Stage 4 hardening — Biome tinting (grass + foliage)

- Rendering: chunk uniforms now include biome-derived **grass** + **foliage** tint colors (sampled at chunk center via the deterministic `BiomeAssigner`).
- Rendering: blocks can opt into tinting via data tags:
  - `mdm:render/tint/grass` (applies to `grass` top faces only)
  - `mdm:render/tint/foliage` (applies to leaf blocks)
- Rendering: tint intent is encoded per-vertex (packed into the `extra` byte), avoiding hard-coded block-id checks in the shader.
- Tests: added a regression test verifying tint extra bits are emitted for tagged blocks.

### Stage 4 hardening — Biome tinting (water)

- Rendering: chunk uniforms now include a biome-derived **water** tint color (sampled at chunk center via the deterministic `BiomeAssigner`), and the water shader uses it to tint fluid surfaces (vanilla-ish).
- World: `BiomeData` now defines per-biome `water_color` and blends it in `get_blended_biome` alongside grass/foliage colors.

### Visual parity — Dimension sky + environment fog

- Rendering: the time uniform now encodes the active dimension ID; the skybox shader uses it to switch to Nether/End sky approximations (no sun/moon/overworld clouds).
- Rendering: fog parameters are now environment-aware:
  - Nether/End use dimension-colored fog with shorter fog distances (vanilla-ish “thick” atmosphere).
  - Underwater uses biome-derived water tint fog with short visibility; precipitation is suppressed.

### Rendering fidelity — Ambient occlusion (AO)

- Rendering: greedy-meshed cube faces now compute a Minecraft-like per-vertex AO factor (based on opaque neighbor occupancy around each vertex) and apply it in the voxel shader.
- Rendering: AO is packed into the existing vertex format (high 4 bits of the `light` byte), preserving vertex layout and keeping the feature deterministic.

### Rendering fidelity — Smooth lighting (per-vertex light)

- Rendering: greedy-meshed cube faces now also compute per-vertex light values (averaging neighbor light samples on the face-adjacent layer) so lighting gradients interpolate across quads (vanilla-ish “smooth lighting”).
- Rendering: per-vertex light continues to use the existing vertex format (low 4 bits of the `light` byte), avoiding any new vertex attributes.

### Rendering fidelity — Grass side tint overlay

- Rendering: `grass` side faces now apply biome tint only to the top “grass” band (top 4px of the tile), approximating vanilla’s grass-side overlay behavior without tinting the dirt portion.
- Rendering: added a small atlas-params uniform so the shader can compute in-tile UVs even with packed atlases/padding.

### Visual parity — Dimension-aware voxel lighting

- Rendering: voxel shading now treats Nether/End as having no sun-driven lighting (constant low ambient), so block lighting carries the scene (more vanilla-ish).

### Rendering fidelity — Leaf tint variants (birch/spruce)

- Rendering: birch + spruce leaves now use fixed foliage tints (vanilla-ish) rather than biome foliage tint.

### Visual parity — Biome-tinted Overworld sky

- World: `BiomeData` now includes `sky_color` / `fog_color` / `water_fog_color` (vanilla-ish hooks; fog colors are constant for now and water fog uses vanilla-ish defaults).
- Rendering: added `TimeUniform.sky_color`; the skybox shader tints the daytime zenith toward this value, enabling per-biome sky hue variation without affecting simulation determinism.
- Rendering: adjusted the temperature→sky tint mapping to better span vanilla’s curve given mdminecraft’s normalized temperature range.

### Visual parity — Vanilla-ish underwater fog colors

- World: `water_fog_color` now uses vanilla-ish defaults (e.g. `0x050533`, with a swamp-specific greener variant), instead of reusing `water_color`.
- Rendering: underwater fog uses `water_fog_color` (Overworld) with shorter visibility distances (more vanilla-ish).

### Visual parity — Biome-tinted Overworld distance fog

- Rendering: Overworld terrain fog now tints slightly toward the biome sky tint (`TimeUniform.sky_color`) so distant haze better matches the sky (vanilla-ish).

### Visual parity — Underwater color grading (lite)

- Rendering: plumbed an `underwater` flag via `TimeUniform.time.z` and apply a strong skybox tint + a mild near-field voxel tint toward the underwater fog color (vanilla-ish full-screen feel without a post-process pass).

### Visual parity — Biome/dimension-aware precipitation particles

- Rendering: precipitation particles now spawn only in the Overworld (Nether/End stay dry) and switch rain↔snow based on local biome temperature (with a simple elevation bias) instead of global altitude.

### Weather parity — Deserts do not precipitate

- Rendering: precipitation particles are now suppressed in the `Desert` biome (vanilla-ish: deserts do not show rain/snow even while global weather is rainy).

### Weather parity — Precipitation respects cover

- Rendering: precipitation particles are now suppressed when blocked by nearby cover (a block between the camera and the spawn height), reducing “rain indoors / inside caves”.

### Lighting parity — Ice no longer blocks skylight

- Content: `ice` is now marked `opaque=false` in `config/blocks.json`, allowing skylight/blocklight to propagate through it (more vanilla-ish).

### Rendering correctness — World Y alignment

- Rendering: `ChunkUniform.chunk_offset.y` now includes `WORLD_MIN_Y`, so chunk-local vertex Y (0..`CHUNK_SIZE_Y`) maps to world Y (`WORLD_MIN_Y..WORLD_MAX_Y`) after the 384-height refactor (fixes a 64-block render offset when negative-Y is enabled).
- Tests: added a regression test for the chunk uniform world-offset mapping.

### Rendering fidelity — Fluid texture motion

- Rendering: plumbed deterministic simulation time (`TimeUniform.time.w = sim_tick/20`) for shader animation surfaces (fluids/portals).
- Rendering: water + lava now blend two scrolling samples (flow-direction aware) to better approximate vanilla animated textures (instead of only a color-wave cue).

### Verification

- `cargo fmt --all` (ok)
- `cargo clippy --workspace --all-targets -- -D warnings` (ok)
- `cargo test -p mdminecraft-render` (ok)
- `cargo test --workspace` (ok)
- `cargo test -p mdminecraft-world --test determinism_worldtest` (ok)

## 2025-12-24

### Lighting parity — Leaf skylight attenuation (`light_opacity`)

- Assets: added optional `light_opacity` (0..=15) to block definitions, defaulting to `15` when `opaque=true` and `0` otherwise.
- World: lighting propagation now uses `light_opacity` for attenuation:
  - skylight downward decays by opacity (`air=0` keeps full sun; leaves reduce it)
  - all other directions decay by `max(1, opacity)`
  - cross-chunk updates apply opacity in the target chunk to keep seam behavior consistent.
- Content: `oak_leaves` / `birch_leaves` / `spruce_leaves` now set `light_opacity: 1` so skylight under leaf canopies is slightly dimmer (vanilla-ish shade).
- Content: water/ice now attenuate skylight (`light_opacity: 3`), and lava blocks skylight (`light_opacity: 15`) for more vanilla-ish underwater/under-ice darkness.
- Tests: added asset-schema tests to lock `light_opacity` defaults and validation (`>15` errors).

### Verification

- `cargo fmt --all` (ok)
- `cargo clippy --workspace --all-targets -- -D warnings` (ok)
- `cargo test --workspace` (ok)

### Mob parity — Undead sunlight burning

- Gameplay: zombies and skeletons now ignite in daylight when **sky-exposed** (column clear above head) and skylight is strong (vanilla-ish).
- Gameplay: rain/snow extinguishes exposed undead (biome-aware: deserts are exempt), and water/waterlogging extinguishes immediately.
- Tests: added focused unit tests for `GameWorld::column_is_clear_to_sky` and the sunlight burn/extinguish predicates.

### Verification

- `cargo fmt --all` (ok)
- `cargo clippy --workspace --all-targets -- -D warnings` (ok)
- `cargo test --workspace` (ok)

### Mob combat parity — Skeleton archery + arrow player damage

- Gameplay: arrows now collide with and damage the player (enables skeleton archery + dispenser traps).
- Gameplay: skeletons now fire arrows deterministically at range (tick-scheduled; respects min distance + detection range).
- Tests: added a deterministic schedule test for `Mob::try_spawn_skeleton_arrow`.

### Verification

- `cargo fmt --all` (ok)
- `cargo clippy --workspace --all-targets -- -D warnings` (ok)
- `cargo test --workspace` (ok)

### Bugfix — Mob fire damage scheduling (refresh-safe)

- World: `Mob::update_fire()` now uses a deterministic burn timer so fire damage is applied even when the fire duration is continuously refreshed (important for undead daylight burning).
- World: added `Mob::extinguish()` and use it in daylight/rain/water extinguish paths.
- Tests: added `refreshing_fire_still_deals_periodic_damage`.

### Verification

- `cargo fmt --all` (ok)
- `cargo clippy --workspace --all-targets -- -D warnings` (ok)
- `cargo test --workspace` (ok)

### Mob loot parity — Skeleton arrow drops

- Gameplay: skeletons now drop arrows in addition to bones (deterministic count), improving the bow/arrow survival loop.

### Content/registry hardening — Lava texture + legacy alias

- Content: fixed lava textures for the canonical lava IDs (`BLOCK_LAVA=20`, `BLOCK_LAVA_FLOWING=22`) to use `blocks/lava` instead of the water placeholder.
- Content: removed a duplicate `"lava"` name collision in `config/blocks.json` by renaming the later entry to `lava_legacy` (id 81) so `id_by_name("lava")` resolves to the real fluid ID again.
- World: added `BLOCK_LAVA_LEGACY=81` and treat it as lava for fluids + light emission, preserving backward compatibility for any saves/scripts that placed the legacy id.
- Config: strict block-registry loading now errors on duplicate keys in the base registry file; lenient loading warns.

### Lighting parity — Waterlogged attenuation + remaining leaf opacity

- World: lighting attenuation now treats waterlogged blocks as attenuating at least as much as water (prevents “too bright” skylight through waterlogged panes/fences/etc.).
- Content: `azalea_leaves` now sets `light_opacity: 1` (matching other leaves).

### Visual parity — Overworld night stars

- Rendering: the Overworld skybox now renders a simple procedural star field at night (twinkle driven by deterministic sim-time, suppressed during precipitation and faded near the horizon).

### Weather parity — Thunderstorms + lightning flashes (visual)

- World: added `WeatherState::Thunderstorm` (rain + thunder) and `/weather thunder` command support; the deterministic weather cycle can now enter/exit thunderstorm states.
- Rendering: thunderstorm visuals now include darker overcast shading plus deterministic lightning flashes in the Overworld (skybox + voxel shading) driven by sim ticks (no wall-clock dependency).
- Notes: currently visual-only (no thunder SFX, no fires, no lightning bolt entity/mob interactions yet).

### Lighting parity — Data-driven block-light emission (`light_emission`)

- Assets: added optional `light_emission` (0..=15) to block definitions (validated), and exposed it through the block registry as the base emission used by block-light recomputation (content-pack friendly).
- World: block-light seeding now uses registry emission with stateful overrides preserved for redstone torches and respawn anchors.
- Content: set `light_emission` for common light sources in `config/blocks.json` (torch=14, glowstone=15, lava=15, furnace_lit=13, glow lichen=7, magma block=3, cave vines=14, sculk sensor=1, sculk catalyst=6, crying obsidian=10) and added vanilla-ish portal emissions (Nether portal=11; End portal=15).

### Weather parity — Lightning strike gameplay (charged creepers)

- Gameplay: thunderstorm lightning strikes now pick a deterministic target near the player and apply vanilla-ish effects:
  - damage + ignition for entities within a small radius
  - creepers struck by lightning become **charged**, doubling explosion damage + radius
- Visual: charged creepers are tinted cyan in the simplified mob billboard renderer (approximate vanilla’s “charged” look).
- Notes: still missing several vanilla interactions (block fires, lightning rods, skeleton horses, etc.).

### Content/pack compatibility — Legacy `emissive` fallback for light emission

- Assets: block definitions now accept `emissive: true` as a backward-compatible fallback for `light_emission` (treated as level 15 when `light_emission` is omitted).
- World: stateful emitters (e.g., redstone torches, respawn anchors) now **ignore the base emission** even when they evaluate to `0` (prevents legacy `emissive` metadata from making “off” states glow).

### Weather parity — Water freezing (ice formation)

- Gameplay: in cold biomes, a small deterministic “accumulation” tick can freeze nearby top-layer **water source blocks** into ice (faster during precipitation; vanilla-ish; limited scope).

### Weather parity — Snow accumulation (snow layers)

- Gameplay: during cold precipitation, a small deterministic “accumulation” tick can place **snow layers** (1..=8) on exposed full-block surfaces, and can increment layers on existing snow.
- Rendering/physics: snow now renders and collides at the correct per-layer height (layers/8).

### Weather parity — Accumulation respects block light

- Gameplay: ice freezing and snow placement now skip positions with **high block light** (e.g., torches), preventing “snow/ice next to torch” weirdness and improving vanilla-ish readability.
- Gameplay: a periodic deterministic melt tick now removes snow and melts ice back into water under strong block light (torch-melt parity).
- Gameplay: snow/ice can also melt under strong **daylight skylight** in warm biomes (time-of-day scaled), approximating vanilla sun melt without requiring torches.
- Simulation: freezing water into ice now calls `fluid_sim.on_fluid_removed(...)` so adjacent water flows react on the next tick.
- Simulation: melting ice back into water calls `fluid_sim.on_fluid_placed(...)` so water begins flowing naturally on the next tick.

### Verification

- `cargo fmt --all` (ok)
- `cargo clippy --workspace --all-targets -- -D warnings` (ok)
- `cargo test -p mdminecraft-world` (ok)
- `cargo test --workspace` (ok)

### Verification

- `cargo fmt --all` (ok)
- `cargo clippy --workspace --all-targets -- -D warnings` (ok)
- `cargo test --workspace` (ok)
