# Repo Code Review Plan (2025-12-16)

## 1) Scope and Goals

**Goal:** review all first-party code for correctness, determinism, security, performance, maintainability, and test adequacy; then produce actionable recommendations.

**In scope (first-party):**
- Rust workspace: `src/`, `crates/**`, `tools/**`, `tests/`
- GPU shaders: `crates/**/src/shaders/*.wgsl`
- Runtime/config data that influences behavior: `config/**` and key asset metadata (not raw textures)
- CI configuration relevant to code quality: `.github/workflows/ci.yml`

**Out of scope (review only as repo hygiene):**
- Vendored environment artifacts (`.venv/**`) and large binary assets (e.g., `assets/textures/**`)

## 2) Code Inventory (What Exists)

### Workspace packages and targets

- `mdminecraft` (bin): `src/main.rs` (+ `src/game.rs`, `src/menu.rs`, `src/input.rs`, `src/config.rs`, `src/scripted_input.rs`)
- Libraries (crates): `mdminecraft-{world,net,render,ui3d,core,ecs,server,client,assets,audio,scripting,testkit}`
- Dev tools (bins): `mdminecraft-cli`, `metrics-diff`, `debug-world`, `atlas_packer`, `ecs_compare`
- Tests:
  - Root integration: `tests/smoke.rs`, `tests/registry_pipeline.rs`
  - Worldtests + proptests: `crates/world/tests/*.rs`
  - Net fuzz/proptest: `crates/net/tests/*.rs`

### Code size (Rust)

- ~118 Rust files / ~51.8k LOC (excluding `.venv/`, `.git/`, `target/`)
- Highest density areas:
  - `crates/world` (~25.4k LOC): simulation, generation, persistence, gameplay systems
  - `src/` (~8.0k LOC): app shell, menu, game loop/input
  - `crates/net` (~5.1k LOC): QUIC/TLS transport, protocol, prediction/replay
  - `crates/render` (~4.8k LOC): wgpu renderer, meshing, UI overlay
  - `crates/ui3d` (~2.7k LOC): 3D UI rendering/layout components

### Non-Rust “code” artifacts

- WGSL shaders (6): voxel/skybox/particles/wireframe + UI3D billboard/text
- HTML (2): `index.html`, `V1/index.html` (reviewed for correctness/security if served)
- Config: `config/blocks.json`, `config/recipes.json`, `config/controls.toml`, scripted input JSON in `config/scripts/`

## 3) Review Methodology (How We Review)

### Phase A — Build & toolchain sanity

- Confirm workspace structure and dependencies (workspace `Cargo.toml`, per-crate `Cargo.toml`)
- Check CI expectations (`cargo fmt --check`, `cargo clippy -D warnings`, `cargo test --workspace`)
- Run key tests locally where feasible (unit + targeted integration/worldtests)

### Phase B — Static analysis pass (repo-wide)

- Scan for reliability hazards: `panic!/unwrap/expect/todo`, unchecked indexing, lossy casts
- Scan for determinism hazards: time-based APIs, OS RNG, unordered map iteration affecting state, float instability
- Scan for security hazards: TLS mode toggles, deserialization boundaries, file I/O paths, untrusted network inputs
- Identify public APIs and invariants (types, serialization formats, protocol versioning)

### Phase C — Deep dive per subsystem (read + reason)

For each subsystem, read “entrypoints → core types → hot loops → boundary I/O” and write findings with severity:
- **Correctness:** invariants, edge-cases, error handling, state transitions
- **Determinism:** stable iteration order, RNG seeding, numeric behavior, replay equivalence
- **Performance:** allocation patterns, caches, O(N²) risks, IO/compression costs
- **Security:** input validation, handshake/auth, TLS, resource exhaustion vectors
- **Maintainability:** module boundaries, naming, docs, tests, metrics/logging

Subsystem order:
1. App shell: `src/*` (event loop, menu/game state, input paths, scripted input)
2. Core types: `crates/core` (items, crafting, enchantments, shared IDs/types)
3. ECS: `crates/ecs` + schedule wiring in `crates/server`
4. World/simulation: `crates/world` (chunk/storage, gen, lighting, persistence, gameplay systems)
5. Networking: `crates/net` + `crates/client/multiplayer.rs` + `crates/server/multiplayer.rs`
6. Rendering: `crates/render` + shaders + headless paths
7. UI3D: `crates/ui3d` + shaders/examples/feature flags
8. Assets/config pipeline: `crates/assets`, `config/*`, `tools/atlas_packer`
9. Tooling/benching: `tools/ecs_compare`, `crates/cli` utilities
10. Tests: coverage gaps, determinism coverage, fuzz/proptest quality

## 4) Output Format (What We Produce)

### Findings rubric

- **P0 Critical:** crash/data corruption/security break/determinism break
- **P1 High:** likely bug, exploit/DoS risk, correctness gaps in core gameplay, major perf issue
- **P2 Medium:** edge-case issues, maintainability risks, unclear API contracts, test gaps
- **P3 Low:** style/docs nits, minor refactors, ergonomic improvements

Each finding includes: location(s), impact, evidence, and a concrete recommendation (plus optional “quick fix”).

### Deliverable

- `wrk_docs/2025.12.16 - CR - Comprehensive Code Review.md` (full report)

## 5) Execution Checklist

- [ ] Run `cargo fmt --all -- --check`
- [ ] Run `cargo clippy --workspace --all-targets -- -D warnings`
- [ ] Run `cargo test --workspace`
- [ ] Run at least one representative worldtest (determinism or large-scale terrain)
- [ ] Perform repo-wide scans (panic/unwrap/determinism/security)
- [ ] Review each workspace crate and tool in the subsystem order above
- [ ] Write report with prioritized actions and suggested follow-ups
