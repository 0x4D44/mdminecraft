# Coverage Improvement Plan (2026-01-01)

## Goal
Raise workspace line coverage from **63.30% → 98%**. This requires ~**24.6k** additional covered lines, concentrated in `src/game.rs`, render/UI code, CLI/tools, and multiplayer modules.

## Stage 0 — Baseline & Run Stability (now)
**Objective:** Keep coverage runs reliable and reproducible.
- ✅ Use `cargo llvm-cov` with an explicit skip list for flaky/slow tests:
  - `large_scale_terrain_worldtest` (perf threshold)
  - `stage4_metrics_worldtest` (long-running)
  - `headless_step_mode_no_render_smoke` (timeout)
- ✅ Capture coverage JSON to `target/coverage/coverage.json`.
- ✅ Log skipped tests (already documented in the report).

## Stage 1 — Low-Hanging Fruit (complete in this pass)
**Objective:** Eliminate easy 0% files and small crates.
- ✅ Added unit tests for:
  - `crates/scripting`, `crates/physics`, `crates/ecs`, `crates/net`
  - `crates/server`, `crates/client`
  - `src/scripted_input.rs`, `src/commentary.rs`
- **Expected impact:** +0.3–0.5% (achieved +0.33%).

## Stage 2 — CLI & Tools (high impact / low complexity)
**Objective:** Cover the **0% CLI + tools** segment (~1.3k LOC).
- ✅ Completed: refactored CLI bins and tools for testable logic and added unit coverage.
  - `crates/cli/src/main.rs` + bins: `debug-world`, `metrics-diff`, `save-upgrade`
  - `tools/atlas_packer`, `tools/ecs_compare`
- **Expected impact:** +1.5–2.0% (mostly from the 0% CLI/tools files).

## Stage 3 — Client/Server Multiplayer Harness
**Objective:** Drive coverage into `crates/client` + `crates/server` multiplayer modules.
- Introduce a deterministic in-memory transport stub (loopback) for multiplayer state.
- Add tests for:
  - handshake, session init, and tick advancement
  - basic replication path (entity snapshot → client apply)
  - error handling on invalid/late packets
- **Expected impact:** +1.0–2.0%.

## Stage 4 — Render/UI Refactor for Testability
**Objective:** Lift `crates/render`, `crates/ui3d`, and `src/menu.rs` out of 0–40% range.
- Extract pure builders for:
  - pipeline descriptor creation (`pipeline.rs`)
  - UI layout calculations (`ui.rs`, `menu.rs`)
  - font atlas packing helpers (`ui3d`)
- Add snapshot tests for:
  - descriptor structs
  - mesh outputs for known chunks
  - UI tree layout with deterministic inputs
- Add headless render tests where possible (without GPU). Reserve integration GPU tests for CI.
- **Expected impact:** +10–15% (this is the single biggest lever).

## Stage 5 — `src/game.rs` Coverage Expansion (largest lift)
**Objective:** Cover high-volume gameplay and orchestration logic (~15k uncovered lines).
- Identify deterministic subsystems in `src/game.rs` and split into testable modules:
  - state machines (player state, inventory UI state)
  - tick scheduling
  - event routing
- Add focused unit tests for state transitions and error paths.
- Leverage existing `mdminecraft-testkit` to simulate headless ticks.
- **Expected impact:** +15–20% (required for 98%).

## Stage 6 — Final 98% Push & Guardrails
**Objective:** Close remaining gaps with targeted tests or explicit exclusions.
- Add coverage gates in CI (`cargo llvm-cov --fail-under 98`).
- For true 98%, either:
  - fully test render/UI/CLI code paths, **or**
  - explicitly exclude untestable paths via `#[cfg(not(coverage))]` + coverage-only stubs.

---

# Next Implementation Steps (starting now)
1. Stage 2: Refactor CLI binaries to extract testable logic and add unit tests.
2. Stage 3: Add an in-memory multiplayer transport and basic client/server tests.
3. Stage 4: Extract render/UI builders and add snapshot tests.
