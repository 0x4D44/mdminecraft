# Implementation Plan: Real-time Capture + Teen Commentary Video Pipeline
Date: 2025-12-30
Author: Codex

## Scope
Implement the HLD for a deterministic, headless-friendly recording mode that:
- Captures frame sequences at a fixed FPS.
- Emits in-the-moment teen-style commentary with timestamps.
- Postprocesses into an MP4 with TTS narration (WSL + Windows SAPI).

---

## Stage 0 — Preflight & Alignment
**Goals:** Validate assumptions and choose defaults.
- Confirm default FPS (20 vs 30) and resolution (1280x720).
- Confirm default TTS voice (Zira vs David).
- Decide whether to ship as top-level CLI flags or a `record` subcommand.
- Identify existing screenshot/offscreen render pipeline to reuse.

**Deliverables:**
- Decisions logged in `wrk_docs/2025.12.30 - HLD - Real-time Capture + Teen Commentary Video Pipeline.md`.

---

## Stage 1 — Core Frame Capture
**Goals:** Deterministic frame capture, bounded output, minimal perf impact.
- Add CLI flags: `--record-dir`, `--record-fps`, `--record-duration-seconds`, `--record-width`, `--record-height`.
- Implement `Recorder` module:
  - Frame scheduler aligned to video time (`frame_index / fps`).
  - Offscreen render target + GPU readback (reuse screenshot pipeline).
  - Encode frames to PNG on a worker thread with bounded queue.
  - Stop after `fps * duration_seconds` frames.
- Write `capture.log` with settings and frame stats.

**Deliverables:**
- Recording writes `frames/frame_000001.png` ...
- Configurable resolution and FPS.

---

## Stage 2 — Commentary Engine (Teen Style)
**Goals:** In-the-moment commentary with deterministic timing.
- Add CLI flags: `--commentary-style`, `--commentary-min-interval-ms`, `--commentary-max-interval-ms`, `--commentary-log`.
- Implement `CommentaryEngine` module:
  - Input signals: time/weather change, teleport, mob counts, action pulses.
  - Phrase pools with teen slang (PG-safe).
  - Deterministic RNG seeded per run.
  - Timestamped JSONL output (`t_ms`, `text`).
- Emit `commentary.jsonl` during run.

**Deliverables:**
- Deterministic, slangy commentary events during capture.

---

## Stage 3 — Postprocess Tool (TTS + Mux)
**Goals:** Convert frames + commentary into MP4 with narration.
- Add a `tools/record_postprocess` script or a Rust subcommand.
- Steps:
  1) Convert `commentary.jsonl` → `commentary.txt` (chronological, minimal padding).
  2) Call Windows SAPI via `powershell.exe` (using `wslpath -w`) to generate `narration.wav`.
  3) Use `ffmpeg` to create `capture.mp4` from frames.
  4) Use `ffmpeg` to mux audio into `final.mp4`.
- Handle narration length mismatch by trimming or time‑stretching.

**Deliverables:**
- `final.mp4` with narration in `video_insights/run_.../`.

---

## Stage 4 — Validation & Ergonomics
**Goals:** Quick end-to-end success and developer experience.
- Add a short smoke test run (5s) and validate file outputs.
- Update README or docs with a 30s example command.
- Add guardrails: missing `ffmpeg` or SAPI errors should log and continue.

**Deliverables:**
- A documented, repeatable 30s capture pipeline.

---

## Stage 5 — Optional Enhancements (v1.1)
**Ideas:**
- Per-line TTS clips + precise timeline placement.
- Optional background music mixing.
- Automatic shot pacing (slow pans, action bursts) using scripted input.
- Hardware‑accelerated encode options.

---

## Risks & Mitigations
- **GPU readback stalls:** use async readback + encode queue; drop frames with warnings.
- **Large disk usage:** limit duration/FPS; include size estimates in logs.
- **WSL path issues:** always convert paths with `wslpath -w`.
- **TTS voice missing:** fallback to default SAPI voice and log.

---

## Estimated Effort (Rough)
- Stage 1: 2–4 days
- Stage 2: 1–2 days
- Stage 3: 1–2 days
- Stage 4: 0.5–1 day

---

## Exit Criteria
- A single 30‑second run produces `final.mp4` with clear teen‑style narration.
- Commentary timestamps align to visual events within ~500ms.
- Determinism preserved (no simulation side effects).
