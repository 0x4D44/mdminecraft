# Vanilla Parity Implementation Journal

**Date:** 2025-12-20  
**Repo:** `/home/md/language/mdminecraft`  
**Plan:** `wrk_docs/2025.12.20 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  

---

## 2025-12-19

### Stage 3 — Farming expansion: carrots + potatoes (+ baked potato)

- Added dropped-item support for **carrot**, **potato**, and **baked potato** (stable IDs appended), plus dropped↔core conversion mappings so pickup/drop works end-to-end.
- Extended core food types to include **Carrot**, **Potato**, and **BakedPotato**, and tuned hunger restore values.
- Expanded right-click farmland interactions:
  - wheat seeds → wheat (`wheat_0`)
  - carrot → carrots (`carrots_0`)
  - potato → potatoes (`potatoes_0`)
  - clicks on farmland now “belong” to planting attempts (so they don’t accidentally eat the held food when the spot is blocked).
- Added vanilla-ish deterministic drops:
  - mature carrots/potatoes drop extra produce in addition to the base drop.
- Added a vanilla-ish deterministic acquisition path:
  - zombies can drop carrots/potatoes (small deterministic chance) to bootstrap farming.
- Added furnace parity:
  - potato → baked potato smelting recipe in the world furnace.

### Verification (post-change 77)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing: gunpowder → splash potions

- Added `bottle_is_splash` to `BrewingStandState` (serde-defaulted for backwards-compatible deserialization) and implemented the gunpowder brewing step to convert drinkable potions into splash variants.
- Wired client↔world mappings so gunpowder is accepted as a brewing ingredient and bottles preserve splash state through the UI/hotbar.
- Added dropped-item support for splash potions so dropping/spilling/brewing-stand-break drops are safe.
- Added a micro snapshot for the gunpowder→splash conversion step.

### Verification (post-change 78)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: spider eyes → poison

- Added dropped-item support for **spider eyes** (stable IDs appended) and wired dropped↔core conversion so pickup/drop works end-to-end.
- Added a client-side core item ID for spider eyes and mapped it into the brewing ingredient pipeline (`SPIDER_EYE`), enabling brewing stand UI placement and shift-move.
- Added vanilla-ish deterministic spider-eye drops to spiders (0–1 per kill) to support acquiring the ingredient in survival.
- Added a micro snapshot covering **Awkward + Spider Eye → Poison**.

### Verification (post-change 79)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: golden carrots → night vision

- Added `FoodType::GoldenCarrot` (edible) and dropped-item support so pickup/drop works end-to-end.
- Added a vanilla-ish crafting recipe: **carrot + gold ingot → golden carrot**.
- Wired brewing ingredient mapping so golden carrots are accepted by the brewing stand (enables **Awkward + Golden Carrot → Night Vision**).
- Added unit coverage for crafting + brewing-slot shift-move behavior and conversion mappings.

### Verification (post-change 80)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Sugar cane + paper/books chain (+ brewing sugar → swiftness)

- Added **sugar cane** as a real block (appended to `config/blocks.json` and block ID constants) with:
  - vanilla-ish placement rules (must be on dirt/grass/sand adjacent to water, or stacked on sugar cane)
  - support removal behavior (column breaks when support is removed)
  - deterministic worldgen near water + deterministic growth system
- Added dropped-item support (stable IDs appended) for:
  - **SugarCane** (placeable block item)
  - **Sugar**, **Paper**, **Book** (generic items)
  - plus dropped↔core conversion mappings so pickup/drop/spill works end-to-end.
- Added vanilla-ish crafting chain:
  - sugar cane → sugar
  - 3 sugar cane → 3 paper
  - 3 paper + leather → book
  - updated bookshelf recipe to **6 planks + 3 books → bookshelf** (removes the old wheat placeholder).
- Wired sugar into brewing ingredient mapping so **Awkward + Sugar → Swiftness** is playable via the brewing stand UI.
- Added a micro snapshot covering **Awkward + Sugar → Swiftness**, plus unit coverage for crafting/conversions/support removal.

### Verification (post-change 81)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: brown mushrooms + fermented spider eye

- Added **brown mushrooms** as a real block (appended to `config/blocks.json` as ID 105) with:
  - vanilla-ish placement rules (top-face only; requires a solid support block)
  - support removal behavior (pops if the supporting block is removed)
  - deterministic worldgen (cave-ish placements; constrained to avoid altering surface-scanning worldtests)
- Added dropped-item support (stable IDs appended) for:
  - **BrownMushroom** (placeable block item)
  - **FermentedSpiderEye** (brewing ingredient item)
  - plus dropped↔core conversion mappings so pickup/drop/spill works end-to-end.
- Added a vanilla-ish crafting recipe:
  - **brown mushroom + sugar + spider eye → fermented spider eye** (shapeless; works in 2×2).
- Wired fermented spider eyes into the brewing ingredient pipeline (`FERMENTED_SPIDER_EYE`), enabling brewing stand UI placement + shift-move.
- Added a micro snapshot covering **Swiftness + Fermented Spider Eye → Slowness**, plus unit coverage for crafting, shift-move, and conversion mappings.

### Verification (post-change 82)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: magma cream + fire resistance

- Added a deterministic Overworld proxy block **magma_cream_ore** (appended to `config/blocks.json` as ID 106) and integrated it into ore generation at low Y so magma cream is obtainable before Nether content exists.
- Added dropped-item + core-item wiring for **Magma Cream**, including brewing stand UI acceptance + shift-move behavior.
- Added a micro snapshot covering **Awkward + Magma Cream → Fire Resistance**.

### Verification (post-change 83)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: ghast tears + regeneration

- Added a deterministic Overworld proxy block **ghast_tear_ore** (appended to `config/blocks.json` as ID 107) and integrated it into low-Y ore generation to provide an early access path to ghast tears before Nether content exists.
- Added dropped-item + core-item wiring for **Ghast Tear**, including brewing stand UI acceptance + shift-move behavior.
- Added a micro snapshot covering **Awkward + Ghast Tear → Regeneration**.

### Verification (post-change 84)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: glistering melons + rabbit feet (healing + leaping)

- Added deterministic Overworld proxy ore blocks:
  - **glistering_melon_ore** (appended to `config/blocks.json` as ID 108)
  - **rabbit_foot_ore** (appended to `config/blocks.json` as ID 109)
  - integrated into low-Y ore generation so the ingredients are obtainable without Nether/mob additions.
- Added dropped-item + core-item wiring for **Glistering Melon** and **Rabbit Foot**, including brewing stand UI acceptance + shift-move behavior.
- Added micro snapshots covering:
  - **Awkward + Glistering Melon → Healing**
  - **Awkward + Rabbit Foot → Leaping**

### Verification (post-change 85)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing expansion: phantom membranes + slow falling

- Added a deterministic Overworld proxy ore block **phantom_membrane_ore** (appended to `config/blocks.json` as ID 110) and integrated it into low-Y ore generation so phantom membranes are obtainable without Nether/mob additions.
- Added dropped-item + core-item wiring for **Phantom Membrane**, including brewing stand UI acceptance + shift-move behavior.
- Completed client-side potion plumbing for **Slow Falling** (drink + splash), including dropped↔core conversions for both bottle types.
- Added a micro snapshot covering **Awkward + Phantom Membrane → Slow Falling**.

### Verification (post-change 86)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Potions: gameplay effects + glass bottle return

- Implemented core potion gameplay effects so brewed potions are no longer “cosmetic-only”:
  - **Swiftness/Slowness** now modify player movement speed.
  - **Leaping** now boosts jump velocity.
  - **Strength/Weakness** now modify melee damage.
  - **Slow Falling** now reduces falling gravity/terminal velocity and prevents fall damage while active.
  - **Regeneration/Poison** now tick health over time (vanilla-ish intervals; poison won’t kill).
  - **Healing/Harming** now apply instantly when drunk.
- Drinking a potion now returns an **empty glass bottle** to storage (or spills if full).
- Added focused unit coverage for instant + over-time potion health effects.

### Verification (post-change 87)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Brewing modifiers: redstone/glowstone (Long/Strong variants)

- Added deterministic Overworld proxy ore blocks:
  - `redstone_dust_ore` (ID 111) → drops **Redstone Dust**
  - `glowstone_dust_ore` (ID 112) → drops **Glowstone Dust**
- Implemented per-bottle modifier state in `BrewingStandState`:
  - `bottle_is_extended` (redstone “long” duration)
  - `bottle_amplifier` (glowstone “strong” level; currently 0–1)
  - both are `serde(default)` for backwards-compatible save loads.
- Implemented redstone/glowstone brewing behavior (vanilla-ish constraints):
  - **Redstone Dust** extends duration for duration potions (no effect on instant potions).
  - **Glowstone Dust** strengthens supported potions (Swiftness/Leaping/Healing/Harming/Poison/Regeneration/Strength).
  - Modifiers are preserved across normal recipe transformations when meaningful, otherwise clamped/cleared.
- Appended stable core potion IDs for long/strong variants and wired UI naming + bottle↔core conversions so inventories represent variants correctly.
- Updated potion gameplay application (drink + splash) to honor **extended duration** and **amplifier** (including strong Healing/Harming).
- Added dropped-item variants for long/strong potions (drinkable + splash) plus dropped↔core conversion mappings so pickup/drop works end-to-end.
- Added parity micro snapshots covering:
  - Swiftness + Redstone Dust → **Long Swiftness**
  - Healing + Glowstone Dust → **Strong Healing**

### Verification (post-change 88)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `MDM_UPDATE_SNAPSHOTS=1 cargo test -p mdminecraft-world --test parity_micro_snapshots`

### Stage 3 — Brewing expansion: pufferfish + water breathing

- Added a deterministic Overworld proxy ore block **pufferfish_ore** (appended to `config/blocks.json` as ID 113) so water-breathing ingredients are obtainable without fishing/ocean mobs.
- Added dropped-item + core-item wiring for **Pufferfish**, including brewing-stand UI acceptance and shift-move behavior.
- Implemented the missing brewing step: **Awkward + Pufferfish → Water Breathing** (with Redstone extension supported via the existing modifier system).
- Added a micro snapshot covering **Awkward + Pufferfish → Water Breathing**.

### Verification (post-change 89)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `MDM_UPDATE_SNAPSHOTS=1 cargo test -p mdminecraft-world --test parity_micro_snapshots`

### Stage 3 — Potions: invisibility hostile detection + night vision visuals

- Invisibility now reduces **hostile mob detection range** (simple visibility multiplier; currently `0.25`).
- Night Vision now boosts the **minimum brightness** of voxel rendering (visual-only; simulation unchanged).
- Test runtime hygiene: tuned `terrain::tests::test_biome_specific_surface_blocks` to sample fewer chunks (avoids the “looks hung” 60s warning in `cargo test` runs).

### Verification (post-change 90)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
- `cargo test -p mdminecraft-world terrain::tests::test_biome_specific_surface_blocks`

### Stage 3 — UX: status effects HUD overlay

- Added a top-right HUD overlay listing active status effects with **level** and **remaining time** (sorted deterministically; green for positive effects, red for negative).

### Verification (post-change 91)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test -p mdminecraft`
- `cargo test --workspace`

### Stage 3 — Buckets: crafting + fluid pickup/place

- Added client-reserved core item IDs for **Bucket**, **Water Bucket**, and **Lava Bucket** and enforced **non-stackable** behavior in both core stacks and dropped-item stacks.
- Added dropped-item variants (appended for stable IDs) and wired dropped↔core conversions so pickup/drop/spill works end-to-end.
- Added a vanilla-ish crafting recipe: **3 iron ingots → 1 bucket** (shaped: `I _ I / _ I _`).
- Implemented right-click bucket interactions:
  - empty bucket picks up **water/lava source blocks**
  - filled buckets place a **source block** into adjacent air/replaceable fluid space
  - placement/removal notifies the fluid simulator and refreshes affected chunk lighting/meshes.
- Added focused unit coverage for conversions + crafting + bucket pickup/place behavior.

### Verification (post-change 92)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: cobblestone walls (crafting + meshing + collisions)

- Added a new block `cobblestone_wall` (appended to `config/blocks.json` as ID `114`) and exposed it as `interactive_blocks::COBBLESTONE_WALL` for rendering/collision rules.
- Added dropped-item support (stable IDs appended) so walls can be dropped/picked up and breaking the block drops the correct item.
- Added a vanilla-ish crafting recipe: **6 cobblestone → 6 cobblestone walls**.
- Implemented neighbor-aware wall meshing (plus a chunk-seam connectivity unit test) and fence-height collision with thicker post/arms (plus a unit test).

### Verification (post-change 93)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: iron bars (crafting + meshing + collisions)

- Added a new block `iron_bars` (appended to `config/blocks.json` as ID `115`) and exposed it as `interactive_blocks::IRON_BARS`.
- Added dropped-item support (stable IDs appended) so iron bars can be dropped/picked up and breaking the block drops the correct item.
- Added a vanilla-ish crafting recipe: **6 iron ingots → 16 iron bars**.
- Extended thin-pane meshing and collision logic to support both glass panes and iron bars, including chunk-seam connectivity coverage and a collision shape unit test for bars.

### Verification (post-change 94)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: stone bricks family (crafting + drops + meshing + collisions)

- Added new blocks `stone_bricks` (ID `116`), `stone_brick_slab` (ID `117`), `stone_brick_stairs` (ID `118`), and `stone_brick_wall` (ID `119`).
- Added dropped-item support (stable IDs appended) so each block can be dropped/picked up and breaking the block drops the correct item.
- Added crafting recipes:
  - **4 stone → 4 stone bricks**
  - **3 stone bricks → 6 stone brick slabs**
  - **6 stone bricks → 4 stone brick stairs**
  - **6 stone bricks → 6 stone brick walls**
- Extended meshing/collision logic:
  - stairs meshing uses `is_stairs` (now includes stone brick stairs)
  - wall meshing now handles both cobblestone and stone brick walls (chunk-seam connectivity test added)
  - wall collision thickness now applies to stone brick walls (unit test added).

### Verification (post-change 95)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: stairs connectivity (inner/outer corners)

- Implemented vanilla-like **inner/outer corner shape resolution** for stairs based on neighboring stairs (front/back checks), and exposed reusable helpers:
  - `stairs_shape_at(...)` computes `StairsShape`
  - `stairs_step_footprints(...)` provides the step AABB footprints for the resolved shape.
- Rendering: stairs now mesh as straight/inner/outer shapes (including chunk seam neighbor sampling).
- Collision: stairs now collide with the same resolved corner shapes, avoiding “visible-but-non-solid” and “solid-but-invisible” mismatches.
- Added focused unit tests for stairs shape resolution and collision expectations.

### Verification (post-change 96)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: double slabs (slab stacking + correct drops)

- Added full-block **double slab** blocks for the currently-supported slab set (stone / oak / stone brick):
  - placing a slab onto an existing slab now merges into the corresponding double-slab block (vanilla-ish “stacking” behavior).
  - breaking a double slab drops **two** of the underlying slab items.
- Implemented merge rules to match vanilla-ish expectations:
  - clicking the “exposed half” of an existing slab merges regardless of which side face you click
  - clicking the “occupied half” does not merge (it behaves like a normal placement attempt).
- Added unit coverage for merge rules + mapping completeness, and drop-item mapping coverage for the new block IDs.

### Verification (post-change 97)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Redstone: powerable blocks (doors/trapdoors/fence gates)

- Added a `redstone_powered` state bit for powerable interactive blocks (doors, trapdoors, fence gates).
- Extended the redstone simulator to update these blocks when neighboring power changes:
  - powered → open, unpowered → closed
  - open state is only forced when the powered flag changes (so manual open/close is preserved while unpowered).
- Interaction parity: while a block is redstone-powered, manual toggling is suppressed (vanilla-ish behavior).
- Added focused redstone unit coverage:
  - iron doors open/close with power
  - trapdoors + fence gates open/close with power
  - unpowered manual door-open survives “no-op” redstone updates.

### Verification (post-change 98)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Building: connectivity rules (full-cube neighbor classification + pane/bar connection)

- Added `is_full_cube_block(...)` helper for connectivity checks (separates “has collision” from “has a full solid face”).
- Updated meshing + collision connectivity for:
  - fences / walls (connect to full blocks + same-family blocks; walls also connect to fence gates)
  - glass panes / iron bars (connect to full blocks + **each other**, vanilla-ish).
- Avoids visibly-wrong “connection arms” to non-full blocks like doors/trapdoors, and keeps collisions consistent with visuals.
- Added focused unit coverage:
  - pane↔bars mesh connectivity across a chunk seam
  - pane↔bars collision connectivity
  - pane does **not** connect to doors.

### Verification (post-change 99)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Redstone: dust places wire + wire drops dust

- Updated dropped-item mapping so breaking **redstone wire** drops **redstone dust** (vanilla-ish).
- Updated hotbar placement rules so holding **redstone dust** places **redstone wire**.
- Added focused unit coverage for the new mappings.

### Verification (post-change 100)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Crafting: redstone torch

- Added a vanilla-ish crafting recipe: **1 redstone dust + 1 stick → 1 redstone torch** (craftable in 2×2).
- Added unit coverage for the recipe.

### Verification (post-change 101)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 3 — Crafting: redstone lamp

- Added a crafting recipe for **redstone lamps** (vanilla-inspired): alternating redstone/glowstone dust in a 3×3 grid.
- Added unit coverage for the recipe.

### Verification (post-change 102)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 4 — Redstone: repeater (delay + directional power)

- Added a new `redstone_repeater` block (append-only `blocks.json` ID: 123) with non-cube collision + custom meshing.
- Added a vanilla-ish crafting recipe: `torch dust torch / stone stone stone` → repeater.
- Placement sets facing; right-click cycles repeater delay (1→4).
- Redstone sim:
  - reads input from “behind” and emits power only out the “front”
  - output changes after the configured delay (tick-scheduled), enabling clocks/delay lines.
- Added dropped-item mappings + focused unit coverage (delay roundtrip + directional/delayed output).

### Verification (post-change 103)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 10 — Redstone: comparator (compare/subtract + 1-tick delay)

- Added `redstone_comparator` block (append-only `blocks.json` ID: 124) with:
  - facing on placement
  - right-click toggles **subtract mode**
  - directional output (front-only) with a 1-tick update delay (vanilla-ish).
- Added `nether_quartz_ore` (append-only `blocks.json` ID: 125) as a deterministic Overworld proxy to unlock comparator crafting:
  - generates during the ore pass (rare, like other proxy ores)
  - mining drops **Nether Quartz** (core item id `2023`).
- Added a vanilla crafting recipe: torches + nether quartz over stone → comparator.
- Rendering: added custom meshing for comparators and wire connectivity to comparator.
- Added focused unit coverage:
  - compare vs subtract output behavior
  - directional output + delay.

### Verification (post-change 104)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 10 — Redstone: observer (block-update pulse source)

- Added `redstone_observer` block (append-only `blocks.json` ID: 126).
- Added a vanilla crafting recipe: cobblestone ring + 2 redstone dust + nether quartz → observer.
- Placement (current restriction): top-face only; facing set from player yaw.
- Redstone sim:
  - stores a small “observed block” fingerprint in state bits (no extra block-entity needed)
  - detects changes in the “behind” voxel and emits a **2-tick pulse** after a **1-tick delay**
  - output is directional (front-only).
- Rendering: redstone wire connectivity recognizes observers (for more vanilla-ish wire visuals).
- Added focused unit coverage for pulse timing + directionality.

### Verification (post-change 105)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 10 — Redstone: piston (block push)

- Added `piston` + `piston_head` blocks (append-only `blocks.json` IDs: 127/128).
- Added a vanilla-ish crafting recipe: planks / cobble+iron+cobble / cobble+redstone+cobble → piston.
- Placement (current restriction): top-face only; facing set from player yaw (**horizontal-only** pistons for now).
- Redstone sim:
  - extends/retracts with a **1-tick delay** when powered/unpowered
  - pushes up to **12 blocks** in the facing direction (vanilla limit)
  - treats **air + fluids** as replaceable; current pushable set is intentionally conservative (no block-entities, doors/beds/crops, or other pistons)
  - emits “geometry changed” signals so the game recomputes **skylight + blocklight** and wakes the **fluid sim** after piston movement.
- Block-break handling: breaking either the base or head drops a piston and removes the paired part (no orphan heads).
- Added focused unit coverage for timing + push behavior.

### Verification (post-change 106)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 10 — Automation: hoppers + droppers/dispensers (basic item transport)

- Added `dispenser`, `dropper`, and `hopper` blocks (append-only `blocks.json` IDs: 129/130/131).
- Hopper mechanics (vanilla-ish, deterministic):
  - horizontal facing (set on placement), 5-slot inventory, 8-tick cooldown per transfer
  - **push** one item into the container in front; **pull** one item from a container above; else **pick up** one dropped item above
  - supported containers: chests, hoppers, droppers, dispensers (hopper-to-hopper works; insertion sets a cooldown on the target hopper to prevent same-tick multi-hop)
  - redstone **lock**: powered hoppers do not transfer items
  - breaking a hopper spills its inventory (in addition to dropping the hopper block).
- Dispenser/dropper basics:
  - new 9-slot persisted block-entity state (`DispenserState`) for both blocks
  - powered state is tracked in voxel state (redstone sim updates the “active” bit)
  - on **rising edge** of power, dispense one item as a dropped entity in front (cooldown: 4 ticks)
  - breaking spills inventory (in addition to dropping the block).
- Comparator “container read” wiring:
  - comparator rear-input treats chests/hoppers/droppers/dispensers as containers and reads their cached analog output (low 4 bits)
  - container output cache is refreshed:
    - when hoppers move items
    - while chest UI is open (after UI interactions)
    - when chunks load (for any persisted chests/hoppers/droppers/dispensers in the loaded chunk).
- Crafting (vanilla-inspired):
  - hopper: iron ingot “U” + chest
  - dropper: cobblestone ring + redstone dust
  - dispenser: cobblestone ring + bow + redstone dust

### Verification (post-change 107)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 10 — Automation: hopper/dispenser/dropper UIs

- Added container UIs for automation blocks:
  - Hopper: 5-slot container UI + player storage UI.
  - Dispenser/Dropper: 3×3 container UI + player storage UI.
- Interaction + lifecycle:
  - right-click opens UI; Escape/X closes UI
  - auto-close if the block-entity is removed while open (e.g., block broken).
- Inventory UX:
  - shift-click quick-move between container ↔ player storage
  - drag distribution across container + player slots (primary drag; secondary drag places 1 per slot).
- Comparator cache refresh: while these UIs are open, the container analog output cache is refreshed each frame (same pattern as chest UI).
- Added focused unit coverage for primary drag distribution into hopper/dispenser slots.

### Verification (post-change 108)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.42s)

### Stage 10 — Automation: hopper down-facing output + side-placement orientation

- Added a dedicated hopper state bit to encode “outputs down” without colliding with comparator power-level caching.
- Placement rules (vanilla-ish, within current constraints):
  - placing a hopper on a **top face** makes it output **down** into the supporting block
  - placing a hopper on a **side face** makes it output **into the clicked block** (horizontal)
  - placing on a **bottom face** (ceiling placement) is still rejected for now.
- Hopper simulation now routes the push-target to either the block below (down output) or the horizontal facing target.
- Added focused unit coverage for the placement-state behavior.

### Verification (post-change 109)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.46s)

### Stage 10 — Automation: dispenser bucket behavior + wall placement for piston/dispenser/dropper

- Dispenser now special-cases buckets (vanilla-ish subset):
  - water/lava buckets place a **source** fluid block in front (when valid) and return an empty bucket
  - empty buckets pick up **water/lava source blocks** in front and return the corresponding filled bucket
  - uses the same deterministic fluid-sim scheduling + immediate lighting/mesh refresh as player bucket interactions.
- Placement rules expanded (within current constraints):
  - pistons, dispensers, and droppers can now be placed on **side faces** with horizontal orientation
  - bottom-face/ceiling placement remains unsupported (no vertical facing yet).
- Refactor: bucket mesh/lighting refresh is centralized in `GameWorld::refresh_after_voxel_changes` (reused by player buckets and dispenser buckets).
- Added focused unit coverage for piston/dispenser/dropper placement state.

### Verification (post-change 110)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.95s)

### Stage 10 — Automation: hopper ceiling placement

- Hopper placement expanded to support **bottom-face / ceiling** placement (vanilla-ish “hanging hopper” behavior).
- Ceiling-placed hoppers keep a deterministic horizontal facing for visuals, and still output **down** (into the block below).
- Updated unit coverage to assert hopper placement succeeds on both top and bottom faces.

### Verification (post-change 111)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 10 — Automation + test harness: world-level hopper tick + contraption snapshots

- Extracted automation helpers into `mdminecraft-world`:
  - `tick_hoppers(...)` (headless/server-authoritative tick for hopper item transfer)
  - `update_container_signal(...)` + `comparator_signal_from_core_slots(...)` for comparator container-read caching
  - deterministic one-item transfer helpers for core-stack slot arrays.
- Wired the game loop to reuse the shared world-layer helpers (no behavior change intended; improves testability + reuse).
- Added Stage 10 “canonical contraptions” micro-snapshots:
  - `micro_redstone_observer_lamp_clock` (clock)
  - `micro_redstone_two_lever_door` (door control from both sides)
  - `micro_item_sorter_lite` (container-read comparator → hopper lock → item transfer gating)

### Verification (post-change 112)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 11 — Commands: in-game prompt + core command set

- Added an in-game command prompt (egui overlay):
  - open with `T` (empty) or `/` (prefilled slash)
  - executed commands append output lines to an on-screen log
  - input is handled in `UiOverlay` context, so gameplay movement/actions do not run while typing.
- Implemented a minimal deterministic command surface in `src/commands.rs`:
  - parsing → typed command enum → execution via a small `CommandContext` trait
  - supports vanilla-ish relative coordinates with `~offset` for `tp`, `setblock`, and `summon`
  - commands implemented: `help`, `tp`, `give`, `time set/add`, `weather`, `gamemode`, `setblock`, `summon`
  - known limitations:
    - local-only (no permissions/audit log/server authority yet)
    - `setblock` currently requires the target chunk to be loaded and uses default state `0` (no blockstate args).
- Added command output “golden” coverage in unit tests (`golden_command_session_outputs_are_stable`).
- Small API improvement: re-exported `mdminecraft-assets` item parsing helpers so commands can share the same item syntax as recipes.

### Verification (post-change 113)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

### Stage 11 — Content packs + deterministic command scripts

- Added deterministic content pack discovery:
  - `src/content_packs.rs` scans `content_packs/` and returns pack dirs in sorted order.
- Extended block registry loading to support packs:
  - Base registry still comes from `config/blocks.json` (stable IDs preserved for built-ins).
  - Pack blocks are appended from `content_packs/<pack>/blocks.json`.
  - Lenient runtime behavior: invalid packs are warned and skipped.
  - Strict loader (tests only): invalid/duplicate keys fail fast.
- Added pack crafting recipes (minimal, shapeless-only for now):
  - Loads `content_packs/<pack>/recipes.json` using the existing `RecipeDefinition` schema.
  - Recipes are cached once (OnceLock) and appended to the built-in crafting list.
  - Test-only strict path validates recipe-name uniqueness and item resolution against the merged block registry.
- Added an example pack:
  - `content_packs/example_pack` adds `example:polished_stone` and a craft recipe for it.
- Added deterministic “command scripts”:
  - `src/command_script.rs` loads `{tick, command}` steps, validates monotonic ticks, and drains commands deterministically.
  - Integrated into the sim tick loop and exposed via `--command-script <path>`.
- Known limitations (accepted for now):
  - Pack crafting recipes are shapeless-only; shaped patterns aren’t part of the pack schema yet.
  - Pack directory ordering is deterministic (sorted), but adding/removing packs can shift appended block IDs.

### Verification (post-change 114)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.12s)

### Stage 11 — Content packs: shaped recipes (vanilla-ish)

- Extended pack crafting recipes to support **shaped** definitions in addition to shapeless:
  - Shaped schema supports `pattern` (rows) + `key` (symbol → item string), plus optional `allow_horizontal_mirror`.
  - Implementation compiles shaped pack recipes into the existing `CraftingPattern` representation used by built-in recipes.
- Updated the example pack (`content_packs/example_pack`) recipe to a shaped 2×2 pattern, and tightened tests to assert the pattern and inputs.

### Verification (post-change 115)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 13.09s)

### Stage 11 — Content packs: manifests (ordering + enable/disable)

- Added optional content pack manifest support via `content_packs/<pack>/pack.json`:
  - defaults: `enabled=true`, `priority=0`, and `name` falls back to the directory name.
  - deterministic load order: packs are ordered by `(priority, pack_id)`.
  - lenient runtime behavior: packs with invalid manifests are skipped with a warning.
  - strict test behavior: invalid manifests fail fast.
- Updated block + pack-recipe loaders to respect manifest ordering and `enabled=false` (packs are ignored).
- Added `content_packs/example_pack/pack.json` as a reference implementation.
- Added tests covering ordering defaults + disabled-pack ignore behavior for blocks and recipes.

### Verification (post-change 116)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.26s)

### Stage 11 — Content packs: spawn tables (mob spawn overrides)

- Added pack-configurable mob spawn overrides via `content_packs/<pack>/spawns.json`:
  - schema: `{ "biome": "<biome>", "mob": "<mob>", "weight": <f32> }` entries
  - `weight = 0` removes a mob from that biome’s spawn list
  - applied deterministically in content-pack manifest order (`(priority, pack_id)`).
- Extended `mdminecraft-world` `MobSpawner` to accept an explicit biome → spawn-weight table:
  - `MobSpawner::new_with_spawn_table(world_seed, table)`
  - game startup loads pack overrides and constructs the spawner with the merged table.
- Added `BiomeId::parse/as_str` and `MobType::parse/as_str` helpers for pack configs.
- Added a unit test validating override ordering and disabled-pack behavior for spawns.

### Verification (post-change 117)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.37s)

### Stage 11 — Content packs: loot tables (block + mob drop overrides)

- Added pack-configurable loot overrides via `content_packs/<pack>/loot.json`:
  - Supports `blocks` and `mobs` sections.
  - Each entry provides a `drops` list with:
    - `item` token (same syntax as commands/recipes, plus `food:*`/`potion:*`/`splash_potion:*`)
    - either `count` or `min`/`max`
    - optional `chance` in `[0, 1]`.
  - Applied deterministically in manifest order (`(priority, pack_id)`); later packs override earlier per block/mob.
  - Disabled packs (`enabled=false`) are ignored.
- Integrated overrides into gameplay:
  - Block break drops: if a loot table exists for the block, it replaces the built-in Silk Touch/Fortune + special-case drop logic.
  - Unsupported block breaks (support loss): uses loot overrides if present, otherwise falls back to the old default-drop mapping.
  - Mob death drops: loot overrides replace the built-in per-mob drop rules.
- Added strict + lenient loaders and unit tests validating ordering/disable behavior and item validation.

### Verification (post-change 118)

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.98s)

---

## 2025-12-20

### Stage 11 — Crafting: tag-based ingredients in recipes

- Added tag-based crafting ingredients backed by per-block tags from `blocks.json`/content packs:
  - `#<tag_key>` (vanilla-ish), plus `tag:<key>` / `block_tag:<key>` aliases.
  - `BlockRegistry::blocks_with_tag(...)`-driven validation: invalid/empty tags reject the recipe.
- Updated crafting matching, autofill, consuming, and max-crafts to support tag ingredients deterministically:
  - Uses a deterministic max-flow allocation (avoids greedy ambiguity when tags overlap).
  - Plumbed `&BlockRegistry` through crafting UI and helpers.
- Updated built-in tool/armor recipe definitions and unit tests to compile with `CraftingIngredient`/tag-aware plumbing.
- Added focused unit coverage for tag ingredient parsing and overlapping-tag allocation.
- Tagged base blocks in `config/blocks.json`:
  - `planks` tag on `oak_planks`
  - `logs` tag on `oak_log`, `birch_log`, `spruce_log`
- Updated built-in wood recipes to use the `planks` tag (vanilla-ish): chest, crafting table, sticks, and wooden tools.
- Added unit coverage proving tag-based shaped recipes match “any planks” blocks (`crafting_chest_accepts_any_planks_tag`).

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.57s)

### Stage 11 — Commands: accept namespaced command forms (`/minecraft:<cmd>`)

- Added vanilla-ish command name parsing compatibility:
  - `/minecraft:give ...`, `/minecraft:tp ...`, etc. are accepted by stripping the `minecraft:` prefix before dispatching.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.62s)

### Stage 11 — Commands: `/gamemode` accepts self-style targets

- Improved vanilla snippet compatibility for gamemode changes:
  - `/gamemode <mode> @p` is accepted (local-player only; supports `@s/@p/@a/@r`).

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.10s)

### Stage 11 — Commands: `/setblock` optional raw voxel state

- Extended `/setblock` to accept an optional raw state: `/setblock <x> <y> <z> <block> [state]` (defaults to `0`).
- Threaded the `state` parameter through `CommandContext::set_block` and the `GameWorld` implementation, so scripts/commands can place oriented/variant blocks deterministically.
- Updated/added unit tests covering parsing and execution output stability.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.00s)

### Stage 10 — Dispensers: basic projectile behaviors

- Extended dispensers so they no longer always “drop items”:
  - arrows are dispensed as real arrow projectiles
  - splash potions are dispensed as real splash-potion projectiles (AoE on impact)
- Droppers remain vanilla-ish: they still dispense as dropped items.
- Refactored dispenser/dropper ticking into a testable helper (`DispenserTickContext`) and added unit coverage for arrow/splash behavior.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.68s)

### Stage 11 — Commands: `/setblock` loads/generates target chunks

- Updated the `GameWorld` `CommandContext::set_block` implementation to ensure the target chunk exists:
  - load from `RegionStore` if present, otherwise generate deterministically via `TerrainGenerator`
  - register crop + sugar-cane growth state for the newly loaded chunk
  - refresh container analog output signals for loaded containers (comparator-read correctness)
- Removes the “loaded chunks only” limitation for `/setblock`, making command scripts less fragile.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.59s)

### Stage 11 — Commands: structured blockstate syntax (`[key=value]`, subset)

- Added vanilla-ish blockstate bracket syntax: `<block>[key=value,...]` for `/setblock` (and shared with `/fill`).
- Implemented an initial property set for common blocks (automation + redstone + a few build blocks), mapping onto the existing `Voxel.state` bit layout.
- Guardrails:
  - properties are supported only for built-in blocks (`mdm:*`); content-pack blocks must use numeric state
  - cannot specify both `[blockstate]` properties and a numeric state argument

### Stage 11 — Commands: `/fill` modes + bulk placement

- Added `/fill` with vanilla-ish relative coords and a conservative volume cap (32,768 blocks).
- Added modes: `replace` (default), `outline`, `hollow`.
- Performance: extended `CommandContext` with `set_blocks(...)` and added a `GameWorld` bulk override to avoid per-block refresh/lighting work for large edits.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.90s)

### Stage 11 — Commands: `/clone` (replace/masked)

- Added `/clone <x1> <y1> <z1> <x2> <y2> <z2> <x> <y> <z> [replace|masked]` with a 32,768 block cap.
- Modes:
  - `replace`: copies air (clears destination where source is air)
  - `masked`: skips air (preserves destination where source is air)
- Added `CommandContext::get_block(...)` and implemented it for `GameWorld` by auto-loading/generating chunks (mirrors `setblock` command behavior).
- Current limitation: clones voxel `id/state` only (block-entity contents aren’t copied yet).

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.84s)

### Stage 11 — Commands: `/effect` (give/clear, player-only)

- Added minimal `/effect` support:
  - `/effect give <effect> [seconds] [amplifier]`
  - `/effect clear [effect]`
- Applies effects to the player only (no target selectors yet).
- Instant effects apply immediately via the existing gameplay logic (currently `instant_health` / `instant_damage`).
- Effect-name parsing is intentionally conservative (subset of vanilla ids; expand as needed).

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.07s)

### Stage 11 — Commands: `/clone` copies block-entity contents

- Upgraded `/clone` so it now copies common block-entity contents in addition to voxel `id/state`:
  - chests, hoppers, droppers/dispensers, furnaces, brewing stands, enchanting tables.
- Implemented a small boxed `BlockEntityData` payload and `CommandContext` hooks (`get_block_entity` / `set_block_entity`) so clone is testable and works for both scripts and in-game commands.
- Container analog-output caches are refreshed for cloned containers via `update_container_signal` (comparator-read parity).
- Current limitation: does not clone non-block entities (mobs/items/projectiles/etc.).

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.43s)

### Stage 11 — Commands: `/setblock keep`, `/fill keep`, and `/fill ... replace <filter>`

- Added `/setblock` mode `keep` (default is `replace`):
  - `/setblock <x> <y> <z> <block> keep` only places if the target is air.
- Added `/fill` mode `keep`:
  - `/fill ... <block> keep` only places into air blocks (does not replace existing blocks).
- Added `/fill ... replace <filter>`:
  - `replace` supports an optional filter block (matches by id, plus optional `[blockstate]` when provided).
  - Example: `/fill ... dirt replace stone`.
- Added focused unit coverage for `keep` + filtered-replace behavior.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.08s)

### Stage 6 — Structures: prevent ruins overlapping villages

- Added `StructureBounds::intersects_bounds(...)` to support structure overlap checks.
- Updated ruin placement to skip a surface ruin if its deterministic bounds would intersect the village bounds for the same structure region (villages take priority).

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 12.45s)

### Stage 6 — Worldgen: vegetation masking for surface structures

- Updated terrain population so trees and sugar cane do not spawn inside surface structure bounds (villages/ruins).
- Uses `worldgen_structure_kind_at_with_biome_assigner(...)` to avoid rebuilding the biome assigner per placement attempt.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.59s)

### Stage 6 — Structures: village terrain adaptation (foundation + interior clearing)

- Improved village v0 generation so structures are usable on uneven terrain:
  - houses and wells now clear their interior volumes so terrain doesn’t intersect them
  - house and well footprints fill foundations down to the first solid ground block (per-chunk), reducing floating platforms

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.80s)

### Stage 6 — Structures: village v0 furnishings (doors + torches)

- Updated village houses to place an oak door (upper/lower halves) and a floor torch, making generated villages more readable and usable at night.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.87s)

### Stage 6 — Structures: village v0 farms (farmland + crops)

- Added a small deterministic farm patch north of the well:
  - fills dirt foundations below the farmland layer
  - places wet farmland + a central water block
  - plants a deterministic mix of wheat/carrots/potatoes with randomized growth stages (still deterministic by village RNG seed)

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.31s)

### Stage 6 — Structures: village v0 paths (door/well/farm connections)

- Fixed village path placement so paths connect outside house doors (instead of running through house centers).
- Added basic path terrain adaptation:
  - fills support blocks below gravel paths
  - clears 2 blocks above the path to reduce hills burying paths
- Expanded village bounds to include path extents so structure masking/classification remains consistent.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.58s)

### Stage 6 — Structures: region-based placement + cross-chunk generation

- Added `crates/world/src/structures.rs` with deterministic region math + bounding-box intersection helpers for structure placement.
- Refactored dungeon/ruin/mineshaft-lite generation to be **region-based** and able to **cross chunk boundaries** (still simplified; no palettes/villages yet).
  - Ruin placement now derives its base Y from `Heightmap` + biome modifier, making it order-independent even when the ruin center is in a different chunk.
  - Added `*_bounds_for_region(...)` helpers to make tests target an intersecting chunk without brute-forcing terrain generation.
- Updated `crates/world/src/terrain.rs` integration and tests to match the new placement model.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `crates/world/tests/determinism_worldtest.rs` finished in 11.19s)

### Stage 6 — Structures: village v0 (static)

- Added a minimal deterministic **village v0** generator (static houses + well + gravel path) using region-based placement and cross-chunk generation.
  - Deterministic placement is keyed off region seed; villages are intentionally uncommon (region-seed modulus gate).
  - Village houses include a crafting table and a chest (loot filled by the existing worldgen chest loot pass).
- Integrated into terrain generation and added focused unit coverage proving deterministic generation and that a crafting table is placed for a known seed.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `crates/world/tests/determinism_worldtest.rs` finished in 12.21s)

### Stage 6 — Structures: structure-aware worldgen chest loot

- Added `mdminecraft_world::WorldgenStructureKind` + `mdminecraft_world::worldgen_structure_kind_at(...)` so the game layer can classify world positions against the deterministic region-based structure placements.
- Updated worldgen chest loot to be **structure-aware** (village/dungeon/mineshaft/ruin/generic) while remaining fully deterministic:
  - seed is derived from `(world_seed, x, y, z)` plus a per-table salt
  - loot tables differ so village chests don’t contain endgame-y items like ender pearls

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `crates/world/tests/determinism_worldtest.rs` finished in 11.27s)

### Stage 6 — Structures: dungeon rooms v0 + surface ruins v0 + worldgen chest loot

- Added a minimal deterministic dungeon generator (`DungeonGenerator`) that carves a small cobblestone room (with moss patches) and places a chest inside.
  - Current implementation is intentionally chunk-local (no cross-chunk placement/terrain adaptation yet).
- Added a minimal deterministic surface ruin generator (`RuinGenerator`) that places a small “broken” stone bricks/cobblestone footprint and a chest.
  - Also chunk-local; intended as an incremental on-ramp before cross-chunk structure placement.
- Added deterministic worldgen chest loot:
  - when a chunk is generated for the first time, any worldgen chest blocks in that chunk get a persisted `ChestState` filled with deterministic loot.
  - loaded chunks are not modified.
- Added focused unit coverage:
  - `mdminecraft-world` terrain test asserts a dungeon chest is placed for a known seed.
  - `mdminecraft-world` terrain test asserts a ruin places stone bricks for a known seed.
  - `mdminecraft` unit test asserts worldgen chest loot is deterministic and non-empty.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.39s)

### Stage 11 — Content packs: vanilla-ish `minecraft:` aliases for block and tag tokens

- Extended `mdminecraft_assets::parse_item_type_with_blocks(...)` to accept `block:minecraft:<name>` as an alias for `block:<name>` when resolving built-in blocks.
- Extended pack crafting tag parsing to accept `#minecraft:<tag>` / `tag:minecraft:<tag>` / `block_tag:minecraft:<tag>` as a vanilla-ish alias:
  - if `minecraft:<tag>` matches no blocks, it falls back to the default-namespace tag (`mdm:<tag>`)
  - if a pack explicitly provides `minecraft:<tag>` on blocks, that tag is used (no fallback)
- Added focused unit coverage for both behaviors.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.76s)

### Stage 11 — Content packs: `minecraft:` prefixes for loot/spawn identifiers

- Loot packs:
  - `loot.json` block entries now accept `minecraft:` prefixes for block keys (e.g. `minecraft:stone` or `block:minecraft:stone`).
  - `loot.json` mob entries now accept `minecraft:zombie` (and `mdm:`) as a convenience alias.
- Spawn packs:
  - `spawns.json` biome and mob fields accept `minecraft:` (and `mdm:`) prefixes (e.g. `minecraft:ocean`, `minecraft:chicken`).
- Added unit coverage to lock the parsing behavior.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.40s)

### Stage 11 — Commands: `/effect` name parsing expanded

- Extended `/effect` parsing to accept the full set of status effects implemented in mdminecraft (still a subset of vanilla overall):
  - absorption, saturation, luck, nausea (alias `confusion`), blindness, hunger, wither, bad luck (alias `unluck`)
  - supports the `minecraft:` namespace prefix for these names as well

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.89s)

### Stage 11 — Commands: accept more self-style selectors

- Expanded player-only selector compatibility:
  - `/effect`, `/clear`, and `/kill` now accept `@p`, `@a`, and `@r` as aliases for the local player (in addition to `@s`/`player`)
  - bracketed selector arguments are accepted and ignored (e.g., `@s[limit=1]`)
  - unsupported selectors (e.g., `@e`) still error

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.63s)

### Stage 11 — Commands: `/tp` accepts self-style selectors

- Improved vanilla snippet compatibility for teleporting by accepting a leading self selector:
  - `/tp @p <x> <y> <z>` and `/tp @s[limit=1] <x> <y> <z>` are treated as `/tp <x> <y> <z>` (local-player only)

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.30s)

### Stage 11 — Commands: `/give` accepts self-style selectors

- Improved vanilla snippet compatibility for item grants by accepting a leading self selector:
  - `/give @p <item> [count]` is treated as `/give <item> [count]` (local-player only)

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 11.57s)

### Stage 11 — Commands: `minecraft:` namespace compatibility

- Added vanilla-ish parsing compatibility so common vanilla ids can be pasted into this build’s commands:
  - `/setblock` and `/fill` accept `minecraft:<block>` (including `/fill ... replace <filter>`).
  - `/give` accepts `minecraft:<name>` for many common vanilla blocks/items/tools (plus `item:minecraft:<name>` and `block:minecraft:<block>` aliases).
  - `/summon` accepts `minecraft:<mob>`.
- This is best-effort aliasing to built-in ids only; other namespaces remain untouched.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.53s)

### Stage 11 — Commands: accept `@s` for player-only targets

- Updated command parsing to accept a vanilla-style self target (`@s`, plus `player`) for player-only commands:
  - `/effect give @s ...` and `/effect clear @s ...`
  - `/clear @s ...` and `/kill @s`
- Added focused unit coverage for the new parsing paths.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `crates/world/tests/determinism_worldtest.rs` finished in 11.54s)

### Stage 11 — Commands: support-break removals now drop items

- Updated command-driven unsupported-neighbor cleanup (`set_block` / `set_blocks` / bulk `destroy_blocks`) to be more vanilla-ish:
  - support-break removals now spill block-entity contents (when applicable) and drop the removed block
  - drop selection is loot-table aware (deterministic) with a `DroppedItemType::from_block(...)` fallback
  - door/bed halves use the same “single drop” rules as survival (no double-drops for door uppers / bed heads)
- Added unit coverage for the door/bed “single drop” decision helper.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `crates/world/tests/determinism_worldtest.rs` finished in 10.79s)

### Stage 11 — Commands: `/fill ... destroy`

- Added `/fill` mode `destroy` (vanilla-ish):
  - destroys the existing blocks in-region first (spilling any block-entity contents like chests/hoppers/etc.)
  - drops destroyed blocks using the existing `DroppedItemType::from_block(...)` mapping (not enchantment-aware)
  - then places the requested new block (or just destroys when filling `air`)
- Added `CommandContext::destroy_blocks(...)` with a `GameWorld` override so large destroys don’t refresh per-block.
  - includes extra-part cleanup for multi-block structures (doors/beds/pistons) to avoid double-drops when the region contains both parts
- Added focused unit coverage proving `destroy` is parsed for `/fill` and that the destroy hook is invoked deterministically.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.24s)

### Stage 11 — Commands: `/seed`, `/say`, `/clear`, `/kill`

- Added `/seed` to print the current world seed (useful for repro + determinism debugging).
- Added `/say <message...>` to emit a server-style message line to the on-screen command log.
- Added `/clear [item] [maxCount]` (player-only):
  - With no args: clears all items in hotbar + inventory.
  - With `item`: clears only matching items.
  - With `maxCount=0`: dry-run that reports how many matching items exist (clears nothing).
- Added `/kill` (player-only) to immediately kill the local player (enters the death screen).
- Added focused unit coverage for parsing + clear semantics + kill execution.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.05s)

### Stage 11 — Commands: command voxel edits clean up unsupported neighbors + register growth

- Updated the `GameWorld` `CommandContext` voxel-edit paths (`set_block` / `set_blocks`) to be less “cheaty” and closer to survival mechanics:
  - after command edits, unsupported neighbor blocks (e.g., torches, wires, wall-mounted items, door/bed halves) are cleaned up via the existing `remove_unsupported_blocks(...)` rules
  - crop blocks placed/removed via commands now register/unregister with the deterministic crop growth system
  - sugar cane placed via commands registers base positions with the deterministic sugar cane growth system

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 9.94s)

### Stage 11 — Commands: `/setblock ... destroy`

- Added `/setblock` mode `destroy`:
  - destroys the existing block first (spilling any block-entity contents like chests/hoppers/etc.)
  - drops the destroyed block using the existing `DroppedItemType::from_block(...)` mapping (not enchantment-aware)
  - then places the requested new block (or just destroys when setting `air`)
- Added focused unit coverage proving `destroy` is parsed and that the destroy hook is invoked deterministically.

### Verification

- `cargo fmt --all -- --check`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace` (notably `tests/determinism_worldtest.rs` finished in 10.08s)
