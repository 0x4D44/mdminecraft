# Vanilla Parity Implementation Journal

**Date:** 2025-12-25  
**Plan:** `wrk_docs/2025.12.25 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  
**Comparison:** `wrk_docs/2025.12.25 - DOC - Feature Comparison vs Vanilla Minecraft.md`  
**Previous journal:** `wrk_journals/2025.12.24 - JRN - Vanilla Parity Implementation.md`  

---

## Slice: Preserve durability through dropped items (player drop/pickup)

### Goals

- Preserve durability for damaged tools/weapons when dropped into the world and picked back up.
- Keep determinism and serialization compatibility.

### Implementation notes

- Add `durability: Option<u32>` to `mdminecraft_world::DroppedItem` (serde default for backward-compatible loads).
- Add `ItemManager::spawn_item_with_durability(...)` and return durability from `ItemManager::pickup_items(...)`.
- Wire `GameWorld` to pass durability when dropping items and to restore durability when picking them up (including the “inventory full → respawn remainder” path).

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Dispenser fills glass bottles from water (vanilla-ish)

### Goals

- Add a common vanilla dispenser behavior useful for brewing automation: dispensing a glass bottle into water yields a water bottle (stored back into the dispenser if possible).
- Preserve deterministic behavior and avoid item loss when the dispenser inventory is full.

### Implementation notes

- Added a dispenser tick special-case for `glass_bottle` when the block directly in front is `water`:
  - Consume one glass bottle.
  - Attempt to insert one water bottle back into the dispenser inventory; if insertion fails, spill the water bottle as a dropped item entity.
- Added a focused unit test: `dispenser_fills_glass_bottles_from_water`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Dispenser/Dropper container insertion (vanilla-ish precedence)

### Goals

- Match vanilla behavior where dispensers and droppers try to insert items into the inventory directly in front before doing projectile/special-case behavior (dispenser) or dropping an item entity (dropper).
- Keep determinism and ensure container comparator output stays correct.

### Implementation notes

- Extended `DispenserTickContext` to pass chest + hopper block-entity maps into `GameWorld::tick_dispensers_and_droppers(...)`.
- On rising-edge + cooldown=0:
  - Take exactly one item from the source container.
  - If the block directly in front is a chest/hopper/dispenser/dropper and has a free/mergeable slot, insert one item and update comparator signal for both source + target; no projectile/item entity is spawned.
  - Otherwise, fall back to the existing dispenser special-cases / dropper drop logic.
- Added focused unit tests:
  - `dispenser_inserts_into_chests_before_dispensing_projectiles`
  - `dropper_inserts_into_chests_before_dropping_items`

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Throw eggs + deterministic hatching

### Goals

- Add a vanilla-ish use for eggs: right-click throws an egg projectile.
- Keep determinism and persistence stability (impact outcome should not depend on floating point contact details).

### Implementation notes

- Added `mdminecraft_world::ProjectileType::Egg` and `Projectile::throw_egg(...)`.
- Added `Projectile::egg_hatch_count` (`#[serde(default)]`) so hatch results are precomputed at throw time and survive save/load.
- `GameWorld` now throws eggs when the held item is `ItemType::Item(104)`; hatch count is computed deterministically from `(world_seed, sim_tick, throw_index, block_pos)` and stored on the projectile.
- `GameWorld::update_projectiles` now treats eggs like other impact-break projectiles and spawns `MobType::Chicken` on impact when `egg_hatch_count > 0` (1 or 4).
- Dispensers now throw eggs as `ProjectileType::Egg` (instead of dropping them as items), and precompute `egg_hatch_count` the same way.
- Stack sizes are now more vanilla-ish: eggs and eyes of ender stack to 16.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Dispenser flint-and-steel ignition (fire/portal)

### Goals

- Improve vanilla automation feel: dispensers loaded with flint-and-steel should ignite in front.

### Implementation notes

- `GameWorld::tick_dispensers_and_droppers` now handles `CORE_ITEM_FLINT_AND_STEEL`:
  - attempts `try_activate_nether_portal(...)` at the facing block
  - otherwise places `mdminecraft_world::BLOCK_FIRE` when the target is air and has a solid support block
- Flint-and-steel durability is consumed only when the dispenser actually changes world state (places fire / lights a portal).

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Burning pigs/cows drop cooked meat

### Goals

- Improve vanilla feel: pigs/cows killed while burning should drop cooked meat instead of raw.

### Implementation notes

- Mob loot now uses `GameWorld::mob_meat_drop_type(...)` so pig/cow drops switch to cooked variants when `fire_ticks > 0`.
- Added a focused unit test: `mob_meat_drop_type_cooks_when_burning`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Speed up `determinism_worldtest` debug defaults

### Goals

- Prevent the determinism worldtest from looking “hung” under `cargo test` on slower machines (the harness prints a warning after 60 seconds).

### Implementation notes

- Reduced `CHUNK_RADIUS_DEBUG` in `mdminecraft-world` `determinism_worldtest` to generate a single chunk by default (env overrides remain for heavier runs).

### Verification

- `cargo test -p mdminecraft-world --test determinism_worldtest -- --nocapture`
- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Zombies can drop iron ingots

### Goals

- Match a familiar vanilla-ish drop: zombies can rarely drop iron ingots (alongside carrot/potato).

### Implementation notes

- Zombie “rare drop” logic is now centralized in `GameWorld::zombie_rare_drop(...)` and expanded to include `IronIngot`.
- Added a focused unit test: `zombie_rare_drop_rolls_expected_items`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Persist dropped-item durability/enchantments

### Goals

- Ensure dropped-item metadata survives save/load cycles so durability/enchantments aren’t lost when exiting and reloading a world.

### Implementation notes

- Extended `mdminecraft-world` persistence coverage by updating `world_state_roundtrip_with_content_is_stable_over_cycles` to include a dropped bow with durability and enchantments.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Chickens lay eggs (deterministic)

### Goals

- Add a recognizable vanilla-ish passive behavior: chickens periodically lay eggs.

### Implementation notes

- Added `GameWorld::chicken_should_lay_egg(...)` to compute a deterministic per-chicken egg schedule (seeded by world seed + mob identity).
- `GameWorld::update_mobs` spawns `DroppedItemType::Egg` at the chicken’s position when the schedule triggers.
- Added a focused unit test: `chicken_egg_laying_is_periodic_and_deterministic`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Container break/spill drops preserve durability + enchantments

### Goals

- Ensure breaking a chest/hopper/dispenser/dropper doesn’t strip durability/enchantments from stored items when they spill into the world.

### Implementation notes

- `GameWorld::on_block_entity_removed` now routes core stacks through `GameWorld::spill_core_stack_to_world(...)`, which uses `ItemManager::spawn_item_with_metadata(...)`.
- Added a focused unit test: `spill_core_stack_to_world_preserves_metadata`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Skeleton bow drops carry durability + rare enchantments

### Goals

- Make mob equipment drops feel more vanilla-ish (dropped bows aren’t always pristine).
- Preserve determinism and reuse the dropped-item metadata pipeline end-to-end.

### Implementation notes

- Mob loot drop spawning now uses `ItemManager::spawn_item_with_metadata(...)` so loot drops can optionally carry durability/enchantments while preserving insertion order.
- Skeleton bow drops now use `GameWorld::mob_bow_drop_metadata(...)` to produce deterministic remaining durability and a small chance of compatible bow enchantments.
- Added a focused unit test: `mob_bow_drop_metadata_is_deterministic_and_valid`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Preserve durability through automation (hoppers/dispensers/droppers)

### Goals

- Preserve durability metadata when:
  - a dispenser/dropper emits an item into the world
  - a hopper pulls an item entity from the world

### Implementation notes

- `ItemManager::take_one_near{,_if}` now returns durability metadata for the removed unit.
- Hopper pickup path applies dropped-item durability to the inserted `CoreItemStack`.
- Dispenser/dropper drop path uses `spawn_item_with_durability(...)` and forwards durability from the source core stack.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Preserve enchantments through dropped items (drop/pickup + automation)

### Goals

- Preserve enchantments for dropped items so enchanted bows/tools don’t lose their enchants when:
  - dropped by the player
  - emitted by dispensers/droppers
  - picked up by the player or pulled by hoppers

### Implementation notes

- `mdminecraft_world::DroppedItem` now stores `enchantments` metadata (serde default for backward-compatible loads).
- Added `ItemManager::spawn_item_with_metadata(...)`; drop/pickup and automation paths now forward durability + enchantments together.
- Hopper pickup path applies dropped-item enchantments to the inserted `CoreItemStack`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Expand flammability coverage (fire/lava)

### Goals

- Treat common logs/leaves and wood-derivative blocks as flammable so lava ignition and fire spread/burning behave more vanilla-ish.

### Implementation notes

- Expanded `mdminecraft_world::is_flammable` to cover additional logs/leaves and common wood derivatives (doors, fences, slabs/stairs, chest/bed, etc.).
- Updated the `is_flammable` unit test to cover the new expectations.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Projectile-hit button activation (arrows)

### Goals

- Let arrows activate buttons (vanilla-ish) to support basic redstone triggers and contraptions.

### Implementation notes

- Added **projectile-only** collision hitboxes for stone/oak buttons (wall/floor/ceiling mounts) so projectile sweep detects them without affecting player movement collision.
- Added `projectile_first_block_hit_along_segment_with_block(...)` so projectile sweeps can report the voxel that was hit (needed for “arrow hit button”).
- Arrow block impacts now activate buttons via `RedstoneSimulator::activate_button(...)` and refresh affected chunk meshes.
- Added focused unit tests: `projectile_collision_detects_wall_buttons` and `arrows_activate_buttons_on_hit`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Pressure plate activation (player/mobs + items)

### Goals

- Fix pressure plate activation to target the correct voxel (plates sit *above* their support).
- Make plate triggering more vanilla-ish:
  - players/mobs trigger stone + oak plates
  - dropped items trigger **oak** plates (not stone)
- Keep determinism and avoid per-tick allocations in the scan.

### Implementation notes

- Replaced the single `pressed_pressure_plate` tracker with a deterministic `BTreeSet` of pressed plates.
- Added `ItemManager::iter()` for allocation-free deterministic iteration over dropped items.
- Implemented `GameWorld::collect_pressed_pressure_plates(...)` + `apply_pressure_plate_transitions(...)`, called from `update_pressure_plates()` before the redstone tick (so power updates propagate in the same tick).
- Added a focused unit test: `pressure_plates_trigger_vanillaish_for_players_and_items`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Ender pearl ownership + dispenser launch

### Goals

- Prevent non-player-thrown ender pearls (e.g., dispenser launches) from teleporting the player.
- Make dispensers launch ender pearls as projectiles (vanilla-ish) instead of dropping item entities.
- Keep save/load deterministic and backward compatible.

### Implementation notes

- Added `ProjectileOwner` metadata to persisted projectiles (`None`/`Player`).
- Player-thrown ender pearls now set `owner=Player`; teleport only triggers for `owner=Player`.
- Dispensers now launch ender pearls as `ProjectileType::EnderPearl` with `owner=None`.
- Added a focused unit test: `dispenser_throws_ender_pearls_as_projectiles_without_owner`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`

---

## Slice: Dispenser inserts Eye of Ender into portal frames

### Goals

- Allow automation to complete End portals: dispensing an Eye of Ender into an empty End portal frame inserts it (vanilla-ish).

### Implementation notes

- Dispenser tick special-cases `Eye of Ender`:
  - If facing an empty `end_portal_frame`, it sets the “has eye” bit and attempts portal activation via `try_activate_end_portal(...)`.
  - Otherwise it falls back to normal dispensing (drops the item).
- Added a focused unit test: `dispenser_inserts_eye_of_ender_into_end_portal_frames`.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
