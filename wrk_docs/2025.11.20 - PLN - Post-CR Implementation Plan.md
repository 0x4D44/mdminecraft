# Post-CR Implementation Plan (2025-11-20)

Purpose: Address critical/major findings from the 2025-11-20 code review, restore networking correctness, tighten security, and close determinism gaps while preserving performance.

## Milestones (sequential)
1) **Networking correctness + security** – unblock reconciliation and remove MITM risk.
2) **Determinism and persistence fixes** – align mining timing, chunk existence checks, and lighting seams.
3) **Lighting & rendering robustness** – cross-chunk lighting, incremental updates, perf sanity.
4) **Tests & automation** – add regression coverage for new fixes and critical paths.
5) **Docs & rollout** – update guides, flags, and operational notes; tag release.

## Stage Details
### Stage 1 – Networking Receive Loop & TLS Hardening (High) **(DONE)**
- Implement non-blocking receive pipeline in `MultiplayerClient`:
  - Poll reliable + unreliable channels each tick; route to `handle_server_message`.
  - Surface disconnect/error to gameplay loop; drop connection cleanly.
  - Apply snapshots to predictor; drain pending messages to avoid backpressure.
- TLS/security:
  - Gate `SkipServerVerification` behind `cfg!(debug_assertions)` or `--insecure` flag.
  - Provide production path with real validation/pinned CA; document cert generation for dev.
- Add lightweight handshake + message-flow integration test (client/server loopback).
- Acceptance: Client reconciles with server snapshots in simulated loop; QUIC streams do not stall after 5k messages; insecure mode off by default.

### Stage 2 – Determinism & Persistence Corrections (High) **(DONE)**
- Mining timing: use per-frame `dt` for progress; add unit test with fixed dt to assert completion time.
- `RegionStore::chunk_exists`: read region map/index (or deserialize keys) to confirm chunk membership; add regression test.
- Block edit timing: ensure mining/placement paths use same dt; confirm no frame-rate dependence in tests.
- Acceptance: Mining time stable ±1% across 30/60/144 FPS sims; `chunk_exists` false when key absent though region file present.

### Stage 3 – Lighting Seam Propagation (High) **(DONE)**
- Implement cross-chunk lighting queueing for skylight/block light.
- Add seam-update scheduling to avoid infinite loops; cap per-tick work to maintain determinism.
- Integration/worldtest covering adjacent-chunk lighting continuity; verify no dark seams.
- Acceptance: Worldtest passes; lighting values across chunk borders match single-chunk baseline.

### Stage 4 – Performance & Rendering Follow-ups (Medium) **(DONE)**
- Optimize block edit path: incremental lighting update and selective remesh. **(DONE: seam lighting/targeted remesh after edits)**
- Particle visibility: HUD displays budget/active counts. **(DONE)**
- Optional feature guarded: billboard pipeline behind `ui3d_billboards` feature to avoid prod impact. **(DONE)**
- Acceptance: No perf regressions observed in targeted suites; optional features guarded by flag.

### Stage 5 – Testing & CI Hardening (Medium) **(PARTIAL)**
- New tests: network loopback, seam lighting property, mining timing, `chunk_exists` regression. **(DONE)**
- Add CI job to run new integration tests (can be feature-flagged for slow suite). **(DONE)**
- Property tests: extend lighting propagation quickcheck for border cases. **(DONE)**
- Acceptance: CI green with added suites; flaky rate 0 over 20 reruns.

### Stage 6 – Documentation & Release Prep (Low) **(DONE)**
- Update README/Docs: secure transport defaults, new CLI flags, testing instructions. **(DONE)**
- Add troubleshooting for handshake failures and cert setup. **(DONE: TLS Troubleshooting doc)**
- Release assets: changelog entry and final implementation report. **(DONE; tag pending user decision)**
- Acceptance: Docs merged; release notes/changelog compiled; tag can be cut when ready.

## Risks & Mitigations
- QUIC changes could regress determinism -> add replayable trace in tests to compare snapshots.
- Cross-chunk lighting may introduce perf spikes -> cap queue length per tick and benchmark.
- Certificate validation friction for contributors -> keep `--insecure` dev flag with loud warning.

## Timeline (aggressive, sequential)
- Stage 1: 2-3 days
- Stage 2: 2 days
- Stage 3: 3-4 days
- Stage 4: 2 days (can overlap with Stage 3 testing)
- Stage 5: 2 days
- Stage 6: 1 day

## Definition of Done
- All acceptance criteria met per stage; tests added and passing in CI.
- No new high/medium severities open related to reviewed areas.
- Docs updated; release artifact produced or ready for cut.
