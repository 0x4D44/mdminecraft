# Journal — Vanilla Parity Implementation

**Date:** 2025-12-16  
**Repo:** `mdminecraft`  
**Starting point:** `ca654b55589488081f95f5b08d67bd19f7c7d50b`  
**Plan reference:** `wrk_docs/2025.12.16 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  

## Goals (Stage 0 kick-off)

- Implement a reusable deterministic **micro-worldtest** harness + **snapshot** tooling.
- Add the first golden micro-tests (redstone, furnace, mining/drops) to establish the workflow.
- Keep everything deterministic and cheap to run locally/CI.

## Decisions / Notes

- Golden snapshots live **next to the crate that owns the test**, under `crates/<crate>/tests/snapshots/`.
- Snapshot update mode is gated behind `MDM_UPDATE_SNAPSHOTS=1` to avoid tests mutating the repo by default.
- Snapshot JSON is canonicalized by recursively sorting object keys (arrays preserve order).

## Work Log

### 2025-12-16

- Implemented Stage 0 snapshot tooling in `mdminecraft-testkit`:
  - `crates/testkit/src/snapshot.rs` — canonical JSON snapshot compare/update (`MDM_UPDATE_SNAPSHOTS=1`).
  - `crates/testkit/src/micro_worldtest.rs` — tick-based runner that snapshots state each tick and asserts against a golden file.
  - Exported both from `crates/testkit/src/lib.rs`.
- Added initial golden micro-worldtests in `mdminecraft-world`:
  - `crates/world/tests/parity_micro_snapshots.rs`
  - Goldens written to `crates/world/tests/snapshots/`:
    - `micro_redstone_wire_propagation.json`
    - `micro_furnace_single_smelt.json`
    - `micro_mining_stone_drops.json`
- Fixed the “hanging” determinism worldtest behavior:
  - `crates/world/tests/determinism_worldtest.rs` now defaults to a smaller debug workload (`MDM_DETERMINISM_CHUNK_RADIUS`, `MDM_DETERMINISM_VERIFICATION_ROUNDS` override supported).
  - Verified the test completes in ~30s locally instead of repeatedly triggering Cargo’s “running for over 60 seconds” warning.
- Restored `clippy -D warnings` cleanliness for `mdminecraft-world` integration tests (unused imports, manual range checks, unnecessary casts, etc.).
- Added a determinism-risk micro-worldtest for lighting seam stitching:
  - `crates/world/tests/parity_micro_snapshots.rs` includes `micro_lighting_seam_stitch_snapshot`.
  - New golden: `crates/world/tests/snapshots/micro_lighting_seam_stitch.json`.

## Commands Run

- `MDM_UPDATE_SNAPSHOTS=1 cargo test -p mdminecraft-world --test parity_micro_snapshots`
- `cargo test -p mdminecraft-world --test parity_micro_snapshots`
- `cargo test -p mdminecraft-testkit`
- `cargo test -p mdminecraft-world --test determinism_worldtest -- --nocapture`
- `cargo clippy -p mdminecraft-world --tests -- -D warnings`
- `cargo test -p mdminecraft-world --tests --no-run`
- `cargo test -p mdminecraft-world --test weather_cycle`
- `cargo test -p mdminecraft-world --test proptest_chunk_seams`
- `MDM_UPDATE_SNAPSHOTS=1 cargo test -p mdminecraft-world --test parity_micro_snapshots micro_lighting_seam_stitch_snapshot`

## Results / Artifacts

- Snapshot harness operational; baseline goldens checked into `crates/world/tests/snapshots/`.

## Next Steps

- Add at least one more micro-worldtest for an area with known determinism risk (e.g., fluids or lighting seam stitch).
- Stage 0: define + document snapshot schemas (block/entity/inventory diffs) so future tests converge on a common shape.
- Stage 0 → Stage 1: start registry/metadata/dimension baseline work once the harness + schema shape stabilizes.
