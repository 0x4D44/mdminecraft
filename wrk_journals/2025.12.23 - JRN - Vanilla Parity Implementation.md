# Vanilla Parity Implementation Journal

**Date:** 2025-12-23  
**Repo:** `/home/md/language/mdminecraft`  
**Plan:** `wrk_docs/2025.12.23 - PLN - Feature Gap Closure Plan toward Vanilla Minecraft.md`  
**Previous journal:** `wrk_journals/2025.12.21 - JRN - Vanilla Parity Implementation.md`  

---

## 2025-12-23

### Stage 4 hardening — Waterlogged water volumes

- Rendering: the chunk mesher emits water volumes for waterlogged blocks (shape-aware for slabs/stairs/trapdoors; fallback full-cube water for other supported blocks).
- Tests: added a render regression test that asserts a waterlogged slab produces the expected number of water faces.

### Stage 4 hardening — Alpha-blended fluid pass

- Rendering: voxel drawing now runs in two passes:
  - opaque pass discards fluid fragments
  - alpha-blended fluid pass (water/lava) loads the opaque depth buffer so fluids blend correctly without hiding underlying block geometry (notably for waterlogged non-cube blocks).
- Stability: translucent-fluid chunks are drawn back-to-front with deterministic tie-breaking to reduce blending flicker.

### Stage 4 hardening — Texture alpha cutouts

- Rendering: the opaque pass now alpha-tests atlas textures and discards fragments with `alpha < 0.5`, enabling cutout-style transparency for textures like glass/leaves without requiring a separate translucent block pass.

### Stage 4 hardening — Flowing fluid surface heights

- Rendering: fluid blocks are now meshed with a per-block fluid height derived from the encoded fluid level, instead of rendering as full cubes.
- Rendering: greedy meshing no longer generates faces for fluids, which prevents internal faces between e.g. water vs flowing-water IDs; fluid faces are emitted by a dedicated meshing pass that treats all water IDs as the same fluid.
- Rendering: fluid top surfaces now use **per-corner heights** (vanilla-ish sloped surface) so adjacent same-type fluids connect smoothly without vertical “step” faces.
- Performance: base heights are cached per-chunk (including a 1-block x/z border) to avoid repeated `voxel_at_world` sampling during meshing.
- Tests: added render regression tests for (1) flowing water emitting a partial-height top face, (2) adjacent same-height flowing water emitting no internal side faces, and (3) a flowing block sloping toward a neighboring source.

### Stage 4 hardening — Flow-direction fluid animation

- Rendering: fluids now encode a coarse flow direction in a spare byte in the voxel vertex format; the voxel shader uses it to orient the procedural wave animation along the flow direction (water/lava), improving “flowing” readability without a new vertex attribute.

### Stage 4 hardening — Translucent ice rendering

- Rendering: `ice` is now rendered in the alpha-blended pass (same pass as fluids), so its texture alpha is respected (visual translucency) rather than being forced opaque by the cutout/opaque pipeline.
- Meshing: `ice` is treated as non-opaque for greedy face culling so adjacent opaque block faces are still emitted (you can see blocks “behind” ice); added a small render regression test.

### Verification

- `cargo fmt --all`
- `cargo clippy --workspace --all-targets -- -D warnings`
- `cargo test --workspace`
