# Development Journal - Refactoring and Hardening
**Date:** 2025-12-10
**Status:** Completed

## 2025-12-10
### Phase 1: Core Determinism Restoration (Completed)
- **Fluids:** Refactored `FluidSimulator` to use `BTreeMap` for deterministic iteration.
- **Redstone:** Refactored `RedstoneSimulator` to use `BTreeSet`.
- **Game Loop:** Implemented Fixed Timestep Loop (`20 TPS`) in `src/game.rs`.
    - Introduced `TICK_RATE` and `accumulator`.
    - Moved simulation logic to `fixed_update`.
    - Replaced `frame_count` with `SimTick`.

### Phase 2: Network Protocol Hardening (Completed)
- Defined `MAX_CHAT_LEN` and `MAX_CHUNK_DATA_LEN`.
- Implemented `verify()` methods for `ClientMessage` and `ServerMessage` to enforce limits.

### Phase 3: Rendering Optimization (Completed)
- Implemented `BufferPool` in `ChunkManager` to reuse vertex/index buffers.
- Refactored `MeshBuilder` to be reusable (reset method), reducing `Vec` allocations.
- Updated `GameWorld` to hold a persistent `MeshBuilder` instance.

### Phase 4: Verification (Completed)
- Created `crates/world/tests/simulation_determinism.rs` verifying strict determinism of fluid and redstone simulation logic.