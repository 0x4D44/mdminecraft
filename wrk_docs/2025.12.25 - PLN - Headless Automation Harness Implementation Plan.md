# 2025.12.25 - PLN - Headless Automation Harness Implementation Plan

## Overview

This plan implements the design in `wrk_docs/2025.12.25 - HLD - Headless Automation Harness.md` in a sequence of small, shippable stages. Each stage is designed to keep the workspace building and tests passing, with clear acceptance criteria and a path to validate behavior locally and in CI.

## Guiding Principles

- **Determinism-first:** headless automation must not depend on wall-clock `Instant` for simulation/interaction behavior; step mode is tick-driven.
- **Minimal disruption:** keep the existing windowed gameplay path working; new code paths are additive and feature-gated by CLI flags.
- **Portability:** automation uses action-level injection (not OS key injection).
- **Observability:** every stage should improve introspection (logs, state query, event IDs, error codes).
- **Incremental testability:** prefer unit tests and “no-render” headless tests that run anywhere; gate GPU tests behind env vars.

## Repository Quality Gates (run after each stage)

```bash
cargo fmt --all -- --check
cargo clippy --workspace --all-targets -- -D warnings
cargo test --workspace
```

## Stage 0 — Prep: CLI plumbing + module scaffolding

**Goal:** Introduce scaffolding for automation + screenshots with zero behavior change unless flags are provided.

**Work items**
- Add a small CLI/options struct in `src/main.rs` (or a new `src/cli.rs`) that can parse new flags (even if some are no-ops initially):
  - `--automation-listen`, `--automation-token`, `--automation-log`
  - `--screenshot-dir`, `--screenshot-every-ticks`, `--screenshot-max`, `--resolution`
  - `--headless`, `--no-render`, `--no-audio`, `--save-dir`, `--no-save`, `--world-seed`, `--reset-world`
- Add `src/automation/` module skeleton:
  - `protocol.rs` (serde types + validation)
  - `server.rs` (TCP accept loop stub)
  - `controller.rs` (game-thread handler stub)
- Ensure no feature changes when flags are absent.

**Acceptance criteria**
- `mdminecraft` runs normally (windowed).
- Workspace passes fmt/clippy/tests.

## Stage 1 — Automation protocol v1 + windowed server (hello/errors only)

**Goal:** Establish the NDJSON control plane and a stable protocol surface without affecting gameplay yet.

**Work items**
- Implement NDJSON request parsing + response writing:
  - `hello` handshake with `version`, optional `token`
  - request `"id"` echoing
  - structured `{"event":"error","code":...}` responses
  - max line length enforcement (e.g., 1MB)
- Implement `AutomationServer` thread:
  - listen on loopback TCP by default
  - accept a single controller connection (“busy” for others)
  - bounded channels between server thread and game thread
- Wire server into the windowed loop:
  - process inbound messages each frame
  - send outbound events immediately

**Acceptance criteria**
- A simple `nc 127.0.0.1 PORT` session can `hello` and receive the response.
- Malformed JSON produces an `error` response (not a panic).
- No gameplay behavior changes without automation flags.

**Tests**
- Unit tests for protocol parsing/validation (hello, errors, id echo).

## Stage 2 — Action injection + core ops (set_actions/pulse/set_view/command/get_state)

**Goal:** Make automation actually drive gameplay in a deterministic, action-level way in the existing windowed binary.

**Work items**
- Define action schema and semantics (per HLD):
  - `set_actions` (held state, partial update/merge)
  - `pulse` (one-tick events; cleared after tick)
  - `set_view` (absolute yaw/pitch)
- Implement `AutomationController`:
  - holds current held state + queued pulses
  - per-frame/tick application into `GameWorld.input` + camera orientation
  - force `input.context = Gameplay` and `cursor_captured = true` only when automation is active (windowed)
- Implement:
  - `command` → run through existing command executor, return lines
  - `get_state` → tick, dimension, player pos/yaw/pitch, health/hunger
- Add optional JSONL logging (`--automation-log`) with token redaction.

**Acceptance criteria**
- An external client can:
  - `set_view`, `set_actions(move_y=1)`, observe `get_state` position changes over time
  - `command /tp ...` and see state update
- Click vs hold semantics work (e.g., hold attack mines; click attacks mobs when present).

**Tests**
- Unit tests for:
  - `set_actions` merge semantics
  - pulse clearing behavior
  - `set_view` deterministic camera update
- “No-render” unit tests where feasible (avoid wgpu).

## Stage 3 — Screenshot capture API (render crate) + windowed best-effort integration

**Goal:** Produce on-demand screenshots and optional periodic screenshots in windowed mode, without requiring headless yet.

**Work items**
- In `mdminecraft-render`:
  - Add an explicit screenshot readback API (e.g., `Renderer::capture_screenshot_rgba()` + `..._to_file()`).
  - Implement row-padding handling and BGRA→RGBA swizzle where needed.
  - Add a fallback path: re-render the scene into an offscreen `COPY_SRC` texture on screenshot frames if the surface cannot be copied.
- In `mdminecraft`:
  - Add screenshot scheduling:
    - periodic `--screenshot-every-ticks`
    - manual `{"op":"screenshot"}` automation request
  - Implement naming + tag sanitization (safe filenames).
  - Write a `run.json` metadata file in screenshot dir (seed, resolution, backend info, flags).

**Acceptance criteria**
- `{"op":"screenshot"}` produces a file on disk and returns its path in the response.
- Periodic screenshot mode produces files at the correct sim ticks.
- Windowed gameplay remains stable when screenshots are disabled.

**Tests**
- Unit tests for filename sanitization.
- Optional gated integration smoke test (ignored by default) if screenshot capture requires GPU.

## Stage 4 — Renderer headless support (offscreen RenderTarget) + disable UI

**Goal:** Enable a true headless render path that does not create a window and always renders into a `COPY_SRC` offscreen texture.

**Work items**
- In `mdminecraft-render`:
  - Introduce `RenderTarget` abstraction (surface vs offscreen).
  - Add `RenderContext::new_headless(size, format)` creating a device/queue without a surface.
  - Ensure UI initialization is skipped in headless mode (no `UiManager`).
  - Ensure `begin_frame` returns a usable `TextureView` for headless frames.
- Add `--no-render` mode to skip GPU entirely (simulation-only) for CI environments with no adapter.

**Acceptance criteria**
- `mdminecraft-render` can initialize headless in a unit/integration harness (even if `mdminecraft` binary doesn’t use it yet).
- Screenshot capture from the offscreen target works in environments with a GPU adapter.
- `--no-render` path cleanly errors with `unsupported` on screenshot requests (no panic).

## Stage 5 — Headless GameWorld + deterministic automation tick + HeadlessRunner

**Goal:** Deliver the actual “headless automation harness” experience: deterministic stepping, action injection, and screenshots without a window.

**Work items**
- Refactor `GameWorld` to support headless:
  - make window-dependent operations optional (avoid creating `winit::Window`)
  - ensure UI/cursor capture calls are gated
  - add `--no-audio` handling
- Implement `GameWorld::automation_tick(dt=TICK_RATE)` per HLD:
  - apply automation input
  - process actions
  - update camera/movement/interactions using deterministic dt
  - run `fixed_update()` exactly once
- Implement `HeadlessRunner`:
  - free-run loop (tick-based) with `--max-ticks`
  - `--exit-when-script-finished` support (exit once `--command-script` completes)
  - step mode (`--automation-step`) blocking on `step` requests
  - render only when a screenshot is due (periodic or on-demand)
- Implement save/seed safety:
  - headless default save dir is ephemeral unless `--save-dir` is set
  - enforce seed mismatch rules unless `--reset-world`

**Acceptance criteria**
- `mdminecraft --headless --automation-step ...` runs in a terminal-only environment.
- Automation client can:
  - step ticks deterministically
  - move and rotate player
  - request screenshots and receive file paths
- With `--no-render`, the same flow works except screenshot returns `unsupported`.

## Stage 6 — Hardening + CI-oriented tests

**Goal:** Make the harness robust for continuous automated usage and ensure key behaviors are covered by tests.

**Work items**
- Robustness:
  - bounded channels with clear backpressure errors
  - single-controller lock and clean reconnect semantics
  - graceful shutdown on disconnect (optional flag)
  - optional unix-only UDS transport (`--automation-uds`) for local automation
- Testing:
  - Always-on no-render integration tests for protocol + stepping + state/command ops
  - Gated GPU test for screenshot existence and dimensions (`MDM_RUN_HEADLESS_GPU_TESTS=1`)
- Documentation:
  - short user doc snippet (README or docs) showing how to run the harness and a minimal client example

**Acceptance criteria**
- CI-safe test suite runs without requiring a GPU.
- Gated GPU tests pass on a machine with a working adapter.
- No known deadlocks when client disconnects mid-step.

## Risks & Mitigations

- **Gameplay parity drift (windowed vs headless):** headless uses tick-based dt; windowed uses frame-based dt.  
  *Mitigation:* document that headless is a testing harness with stable semantics; keep windowed unchanged.

- **GPU backend availability in CI:** headless screenshots need an adapter.  
  *Mitigation:* provide `--no-render` and gate GPU tests behind env vars.

- **Swapchain capture unreliability:** surface readback may fail.  
  *Mitigation:* re-render-to-offscreen fallback for windowed screenshots; headless always uses offscreen.

- **Save pollution:** accidental writes to `saves/default`.  
  *Mitigation:* headless defaults to ephemeral save dir; require explicit `--save-dir` for persistence and `--reset-world` for destructive resets.

## Validation Commands (manual)

Windowed automation hello:

```bash
mdminecraft --auto-play --automation-listen 127.0.0.1:4242
```

Headless step mode + screenshots:

```bash
mdminecraft --headless --no-audio --no-save --world-seed 1 \
  --automation-listen 127.0.0.1:4242 --automation-step \
  --screenshot-dir target/harness/run1 --screenshot-every-ticks 1
```
